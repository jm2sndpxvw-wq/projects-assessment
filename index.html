<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projects Assessment ‚Äì Real Estate Team (Export PDF)</title>

  <!-- html2pdf (includes jsPDF + html2canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #0b0d10;
      --bg-alt: #151921;
      --bg-alt-soft: #1b2029;
      --primary: #4f8cff;
      --text: #f5f7fb;
      --text-muted: #9aa4c0;
      --danger: #ff4b5c;
      --success: #28c76f;
      --border: #252c3a;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background:radial-gradient(circle at top,#1a2134 0,#05060a 55%); color:var(--text); margin:0; padding:16px; display:flex; justify-content:center;}
    .app{width:100%; max-width:1280px; background:linear-gradient(135deg,#090b10 0,#111623 45%); border-radius:12px; display:grid; grid-template-columns:260px 1fr; gap:12px; padding:12px; border:1px solid rgba(255,255,255,0.04);}
    .sidebar{padding:12px; background:radial-gradient(circle at top left,#20263a 0,#070910 55%); border-right:1px solid var(--border); display:flex; flex-direction:column; gap:12px;}
    .logo{width:34px;height:34px;border-radius:8px;background:radial-gradient(circle at 30% 0,#7c8cff,#3a4bff,#141633);display:inline-flex;align-items:center;justify-content:center;font-weight:700}
    .team-list{display:flex;flex-direction:column;gap:8px;max-height:52vh;overflow:auto;padding-right:6px}
    .team-item{background:rgba(16,21,34,0.9);padding:8px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;border:1px solid transparent;cursor:pointer}
    .team-item.active{border-color:var(--primary);box-shadow:0 0 0 1px rgba(79,140,255,0.12)}
    .main{padding:8px 12px;display:flex;flex-direction:column;gap:10px}
    .tabs-row{display:flex;gap:8px}
    .tab-btn{padding:6px 12px;border-radius:999px;background:rgba(8,10,16,0.9);border:1px solid var(--border);cursor:pointer;color:var(--text-muted)}
    .tab-btn.active{background:var(--primary);color:#fff;border-color:rgba(79,140,255,0.9)}
    .content-grid{display:grid;grid-template-columns:minmax(0,320px) 1fr;gap:12px}
    .panel{background:var(--bg-alt);padding:10px;border-radius:10px;border:1px solid var(--border)}
    .cards-list{display:flex;flex-direction:column;gap:8px;max-height:56vh;overflow:auto;padding-right:6px}
    .card{background:var(--bg-alt-soft);padding:8px;border-radius:8px;border:1px solid var(--border)}
    .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.08);background:rgba(8,10,16,0.9);color:var(--text);cursor:pointer}
    .btn.primary{background:var(--primary);color:#fff;border-color:rgba(79,140,255,0.9)}
    .hint{color:var(--text-muted);font-size:13px}
    textarea{width:100%;min-height:64px;background:#0d1017;color:var(--text);border-radius:8px;padding:8px;border:1px solid var(--border)}

    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:9999}
    .modal{background:#0f1720;padding:16px;border-radius:10px;width:92%;max-width:720px;border:1px solid rgba(255,255,255,0.04)}
    .modal h3{margin:0 0 8px 0}
    .modal .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
    .template-card{background:#0b1220;padding:8px;border-radius:8px;border:1px solid var(--border);flex:1;min-width:160px}
    .template-card label{display:flex;gap:8px;align-items:center;cursor:pointer}
    .small{font-size:13px;color:var(--text-muted)}
    .switch-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}

    @media (max-width:900px){ .app{grid-template-columns:1fr} .content-grid{grid-template-columns:1fr} .sidebar{border-bottom:1px solid var(--border)} }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div style="display:flex;gap:8px;align-items:center">
        <div class="logo">BR</div>
        <div>
          <div style="font-weight:700">Bold Routes ‚Äì Projects</div>
          <div style="font-size:12px;color:var(--text-muted)">Export PDF ‚Äî Test build</div>
        </div>
      </div>

      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong style="font-size:14px">Team members</strong>
        <button class="btn" id="populateBtn" title="Fill sample data">Populate sample data</button>
      </div>
      <div class="team-list" id="teamList"></div>

      <div style="display:flex;gap:8px">
        <input id="newMemberInput" placeholder="Add member..." style="flex:1;padding:8px;border-radius:8px;background:#0d1017;border:1px solid var(--border);color:var(--text)" />
        <button class="btn" id="addMemberBtn">Add</button>
      </div>

      <div style="margin-top:auto;font-size:13px;color:var(--text-muted)">
        <div><strong>Color codes:</strong></div>
        <div>üü• &lt; 60% ‚Äì Needs training</div>
        <div>üü® 60‚Äì79% ‚Äì Average</div>
        <div>üü© ‚â• 80% ‚Äì Confident</div>
      </div>
    </aside>

    <main class="main">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div>
          <div id="currentMemberTitle" style="font-weight:700">Select team member</div>
          <div id="currentMemberSub" class="small">Choose a team member from the left</div>
        </div>
        <div class="controls">
          <button class="btn" id="exportBtn">Export PDF</button>
          <button class="btn" id="backupBtn">Backup</button>
          <button class="btn" id="restoreAutoBtn">Restore auto</button>
        </div>
      </div>

      <div class="tabs-row">
        <button class="tab-btn active" data-tab="assessment">Assessment</button>
        <button class="tab-btn" data-tab="conversion">Conversion</button>
        <button class="tab-btn" data-tab="overview">Members overview</button>
      </div>

      <!-- ASSESSMENT / CONVERSION / OVERVIEW CONTENT -->
      <div class="content-grid">
        <!-- LEFT: form -->
        <section class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong id="formTitle">New Project Assessment</strong><div class="small">Rate 0‚Äì10</div></div>
            <div class="small hint">Long press member to delete</div>
          </div>

          <div style="margin-top:8px;display:flex;flex-direction:column;gap:8px">
            <input id="projectName" placeholder="Project name" style="padding:8px;border-radius:8px;background:#0d1017;border:1px solid var(--border);color:var(--text)" />
            <input id="projectDeveloper" placeholder="Developer" style="padding:8px;border-radius:8px;background:#0d1017;border:1px solid var(--border);color:var(--text)" />
            <input id="projectRegion" placeholder="Region / Area" style="padding:8px;border-radius:8px;background:#0d1017;border:1px solid var(--border);color:var(--text)" />

            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px">
              <input id="scoreDevelopment" type="number" placeholder="Development (0‚Äì10)" min="0" max="10" step="0.5" />
              <input id="scoreLocation" type="number" placeholder="Location (0‚Äì10)" min="0" max="10" step="0.5" />
              <input id="scoreMasterplan" type="number" placeholder="Masterplan" min="0" max="10" step="0.5" />
              <input id="scoreFacilities" type="number" placeholder="Facilities" min="0" max="10" step="0.5" />
              <input id="scoreType" type="number" placeholder="Type mix" min="0" max="10" step="0.5" />
              <input id="scorePrice" type="number" placeholder="Price" min="0" max="10" step="0.5" />
              <input id="scorePayment" type="number" placeholder="Payment plan" min="0" max="10" step="0.5" />
              <input id="scoreDelivery" type="number" placeholder="Delivery" min="0" max="10" step="0.5" />
              <input id="scoreFinishing" type="number" placeholder="Finishing" min="0" max="10" step="0.5" />
              <input id="scoreMaintenance" type="number" placeholder="Maintenance" min="0" max="10" step="0.5" />
              <input id="scoreOrientation" type="number" placeholder="Orientation skills" min="0" max="10" step="0.5" />
            </div>

            <textarea id="projectNotes" placeholder="Notes"></textarea>

            <div style="display:flex;gap:8px">
              <button class="btn primary" id="addProjectBtn">Save project</button>
              <button class="btn" id="cancelEditBtn">Cancel edit</button>
            </div>
          </div>
        </section>

        <!-- RIGHT: lists / overview -->
        <section class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Projects & Scores</strong><div class="small">Click card to expand</div></div>
            <div class="small hint">Filters will affect PDF export</div>
          </div>

          <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
            <span class="small">Region:</span>
            <select id="regionFilter"><option value="all">All regions</option></select>
            <span class="small">Developer:</span>
            <select id="developerFilter"><option value="all">All developers</option></select>
            <div style="flex:1;text-align:right"><span id="regionStats" class="small">No projects yet</span></div>
          </div>

          <div class="cards-list" id="projectsList" style="margin-top:10px">
            <div class="card">No projects yet. Add a new assessment on the left.</div>
          </div>

          <div style="margin-top:12px;border-top:1px dashed rgba(255,255,255,0.04);padding-top:8px">
            <strong>ÿÆÿ∑ÿ© ÿßŸÑÿ™ÿØÿ±Ÿäÿ® (ÿ£Ÿàÿ™ŸàŸÖÿßÿ™ŸäŸÉ)</strong>
            <div id="trainingList" class="small" style="margin-top:6px">ŸÑÿ≥Ÿá ŸÖÿßŸÅŸäÿ¥ ÿØÿßÿ™ÿß ŸÉŸÅÿßŸäÿ© ÿØŸÑŸàŸÇÿ™Ÿä.</div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Modal: Export options -->
  <div class="modal-backdrop" id="exportModal">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Export PDF ‚Äî Choose template</h3>
      <div class="row">
        <div class="template-card">
          <label><input type="radio" name="template" value="overview_single" checked /> <div style="font-weight:700">Members Overview ‚Äî Single member</div></label>
          <div class="small">Export one member card (the currently selected sales person).</div>
          <div class="small" style="margin-top:6px">Good for sending a quick performance card to one sales.</div>
        </div>

        <div class="template-card">
          <label><input type="radio" name="template" value="overview_all" /> <div style="font-weight:700">Members Overview ‚Äî All cards</div></label>
          <div class="small">All overview cards (multiple pages).</div>
        </div>

        <div class="template-card">
          <label><input type="radio" name="template" value="assessment_filtered" /> <div style="font-weight:700">Assessment ‚Äî Filtered projects</div></label>
          <div class="small">Export projects list according to current Region & Developer filters.</div>
        </div>

        <div class="template-card">
          <label><input type="radio" name="template" value="conversion_table" /> <div style="font-weight:700">Conversion ‚Äî Table (day)</div></label>
          <div class="small">Export conversion table for the current selected date.</div>
        </div>
      </div>

      <div class="switch-row">
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="includeTrends" /> Include trends (if available)</label>
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="openAfterGenerate" checked /> Open PDF in new tab after generation (mobile-friendly)</label>
        <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="landscapeMode" /> Landscape mode</label>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn" id="cancelExport">Cancel</button>
        <button class="btn primary" id="confirmExport">Generate PDF</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- state + helpers ----------
    const STORAGE_KEY = "br_assessment_v3";
    const AUTO_BACKUP_KEY = "br_assessment_autobackup_v1";
    const ALL_TEAM_ID = "__ALL_TEAM__";
    const CONV_METRICS = ["deals","scheduled","meetings","requests","callBack","activeCalls","calls"];
    const CONV_TARGET_METRICS = ["deals","scheduled","meetings","requests","calls"];
    const CONV_LABELS = { deals: "Deals", scheduled: "Scheduled", meetings: "Meetings", requests: "Requests", callBack: "Call back", activeCalls: "Active calls", calls: "Calls" };
    let state = { members: [], selectedMemberId: null, activeTab: "assessment", conversion: { currentDate: null, targets: {}, entries: {} } };
    let editingProjectId = null;

    function uid(){ return Date.now().toString(36)+Math.random().toString(16).slice(2); }
    function todayISO(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return `${d.getFullYear()}-${m}-${day}`; }
    function daysInMonth(dateStr){ const [y,m] = dateStr.split("-").map(n=>parseInt(n,10)); return new Date(y,m,0).getDate(); }

    function initConversionState(){
      if (!state.conversion) state.conversion = { currentDate: null, targets: {}, entries: {} };
      if (!state.conversion.targets) state.conversion.targets = {};
      CONV_TARGET_METRICS.forEach(m => { if (!state.conversion.targets[m]) state.conversion.targets[m] = { mode: "day", value: 0 }; });
      if (!state.conversion.entries) state.conversion.entries = {};
    }

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) try{ state = JSON.parse(raw); }catch(e){ console.warn("parse failed",e); }
      if (!state.members) state.members = [];
      if (!state.selectedMemberId && state.members.length) state.selectedMemberId = state.members[0].id;
      initConversionState();
    }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify(state)); }

    // ---------- DOM refs ----------
    const teamListEl = document.getElementById("teamList");
    const newMemberInput = document.getElementById("newMemberInput");
    const addMemberBtn = document.getElementById("addMemberBtn");
    const populateBtn = document.getElementById("populateBtn");
    const currentMemberTitle = document.getElementById("currentMemberTitle");
    const currentMemberSub = document.getElementById("currentMemberSub");
    const regionFilter = document.getElementById("regionFilter");
    const developerFilter = document.getElementById("developerFilter");
    const regionStats = document.getElementById("regionStats");
    const projectsListEl = document.getElementById("projectsList");
    const trainingListEl = document.getElementById("trainingList");

    const projectNameEl = document.getElementById("projectName");
    const projectDeveloperEl = document.getElementById("projectDeveloper");
    const projectRegionEl = document.getElementById("projectRegion");
    const projectNotesEl = document.getElementById("projectNotes");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");

    const tabButtons = document.querySelectorAll(".tab-btn");
    const exportBtn = document.getElementById("exportBtn");
    const exportModal = document.getElementById("exportModal");
    const confirmExport = document.getElementById("confirmExport");
    const cancelExport = document.getElementById("cancelExport");
    const backupBtn = document.getElementById("backupBtn");
    const restoreAutoBtn = document.getElementById("restoreAutoBtn");

    // score ids
    const scoreIds = ["scoreDevelopment","scoreLocation","scoreMasterplan","scoreFacilities","scoreType","scorePrice","scorePayment","scoreDelivery","scoreFinishing","scoreMaintenance","scoreOrientation"];
    const SCORE_LABELS = { development:"Development", location:"Location", masterplan:"Masterplan", facilities:"Facilities", type:"Type mix", price:"Price positioning", payment:"Payment plan", delivery:"Delivery date", finishing:"Finishing", maintenance:"Maintenance", orientation:"Orientation skills" };

    // ---------- rendering ----------
    function renderTeamList(){
      teamListEl.innerHTML = "";
      if (!state.members.length){
        const div = document.createElement("div"); div.className="card"; div.textContent = "Add your team members to start."; teamListEl.appendChild(div);
        currentMemberTitle.textContent = "Select team member"; currentMemberSub.textContent = "Choose a team member from the left";
        return;
      }

      // all-team item
      const allItem = document.createElement("div"); allItem.className="team-item"+(state.selectedMemberId===ALL_TEAM_ID?" active":"");
      const left = document.createElement("div"); left.style.display="flex"; left.style.flexDirection="column";
      const nm = document.createElement("div"); nm.textContent="All team"; nm.style.fontWeight="700"; left.appendChild(nm);
      const meta = document.createElement("div"); meta.className="small"; meta.textContent=state.members.length + " member(s)"; left.appendChild(meta);
      allItem.appendChild(left);
      const pill = document.createElement("div"); pill.className="team-score-pill"; pill.textContent="All"; allItem.appendChild(pill);
      allItem.addEventListener("click", ()=>{ state.selectedMemberId = ALL_TEAM_ID; saveState(); renderAll(); });
      teamListEl.appendChild(allItem);

      state.members.forEach(member=>{
        const item = document.createElement("div"); item.className="team-item"+(member.id===state.selectedMemberId?" active":"");
        const main = document.createElement("div"); main.style.display="flex"; main.style.flexDirection="column";
        const name = document.createElement("div"); name.textContent = member.name; name.style.fontWeight="600";
        const meta = document.createElement("div"); meta.className="small"; meta.textContent = (member.projects?.length||0) + " project(s)";
        main.appendChild(name); main.appendChild(meta);
        item.appendChild(main);
        const pill = document.createElement("div"); pill.className="team-score-pill"; pill.textContent = "‚Äî";
        item.appendChild(pill);

        // long press -> delete
        let timer=null; let longPressed=false;
        item.addEventListener("pointerdown", ()=>{ longPressed=false; timer=setTimeout(()=>{ if (confirm(`ÿ™ŸÖÿ≥ÿ≠ ${member.name} ŸàŸÉŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ÿü`)){ state.members = state.members.filter(m=>m.id!==member.id); if (state.selectedMemberId===member.id) state.selectedMemberId = state.members[0]?.id || ALL_TEAM_ID; saveState(); renderAll(); } longPressed=true; },650); });
        ["pointerup","pointerleave","pointercancel"].forEach(ev => item.addEventListener(ev, ()=>{ if (timer){ clearTimeout(timer); timer=null; } }));
        item.addEventListener("click", ()=>{ if (longPressed) return; state.selectedMemberId = member.id; saveState(); renderAll(); });

        teamListEl.appendChild(item);
      });
    }

    function getCurrentMember(){
      if (state.selectedMemberId === ALL_TEAM_ID) return { id: ALL_TEAM_ID, name: "All team", isAllTeam: true, projects: state.members.flatMap(m => (m.projects||[]).map(p => ({...p, ownerName: m.name}))) };
      return state.members.find(m=>m.id===state.selectedMemberId) || null;
    }

    function computeAssessmentAverage(member){
      const projects = member?.projects || [];
      if (!projects.length) return 0;
      let sum=0; projects.forEach(p=> sum += p.overallPercent || 0); return sum/projects.length;
    }

    function renderFiltersAndStats(member){
      const projects = member?.projects || [];
      const regions = new Set(); const devs = new Set();
      projects.forEach(p=>{ if (p.region) regions.add(p.region); if (p.developer) devs.add(p.developer); });
      const prevR = regionFilter.value || "all", prevD = developerFilter.value || "all";
      regionFilter.innerHTML = "<option value='all'>All regions</option>";
      Array.from(regions).forEach(r=>{ const opt=document.createElement("option"); opt.value=r; opt.textContent=r; regionFilter.appendChild(opt); });
      developerFilter.innerHTML = "<option value='all'>All developers</option>";
      Array.from(devs).forEach(d=>{ const opt=document.createElement("option"); opt.value=d; opt.textContent=d; developerFilter.appendChild(opt); });

      if (regions.has(prevR) || prevR==="all") regionFilter.value = prevR; else regionFilter.value="all";
      if (devs.has(prevD) || prevD==="all") developerFilter.value = prevD; else developerFilter.value="all";

      if (!projects.length){ regionStats.textContent = "No projects yet"; return; }
      const selR = regionFilter.value, selD = developerFilter.value;
      const filtered = projects.filter(p=> (selR==="all"||p.region===selR) && (selD==="all"||p.developer===selD));
      if (!filtered.length){ regionStats.textContent = "No projects with current filters"; return; }
      const avg = filtered.reduce((a,b)=>a+(b.overallPercent||0),0)/filtered.length;
      regionStats.textContent = `Filtered: ${avg.toFixed(1)}% over ${filtered.length} project(s)`;
    }

    function renderProjectsList(member){
      projectsListEl.innerHTML = "";
      if (!member || !member.projects || !member.projects.length){
        projectsListEl.innerHTML = "<div class='card'>No projects yet. Add a new assessment on the left.</div>";
        trainingListEl.textContent = "ŸÑÿ≥Ÿá ŸÖÿßŸÅŸäÿ¥ ÿØÿßÿ™ÿß ŸÉŸÅÿßŸäÿ© ÿØŸÑŸàŸÇÿ™Ÿä.";
        return;
      }
      const selR = regionFilter.value || "all", selD = developerFilter.value || "all";
      const projects = member.projects.filter(p=> (selR==="all"||p.region===selR) && (selD==="all"||p.developer===selD));
      if (!projects.length){ projectsListEl.innerHTML = "<div class='card'>No projects with current filters.</div>"; return; }
      projects.slice().sort((a,b)=>b.createdAt - a.createdAt).forEach(project=>{
        const c = document.createElement("div"); c.className="card";
        const h = document.createElement("div"); h.style.display="flex"; h.style.justifyContent="space-between";
        const left = document.createElement("div"); left.innerHTML = `<div style="font-weight:700">${project.name}</div><div class="small">${project.region||''} ‚Ä¢ ${project.developer||''}</div>`;
        const right = document.createElement("div"); right.innerHTML = `<div style="text-align:right"><span style="font-weight:700">${project.overallPercent.toFixed(1)}%</span></div>`;
        h.appendChild(left); h.appendChild(right);
        c.appendChild(h);
        const det = document.createElement("div"); det.className="small"; det.style.marginTop="8px";
        const parts = []; for (const k in project.scores){ parts.push(`${SCORE_LABELS[k]||k}: ${project.scores[k]}`); }
        det.textContent = parts.join(" ‚Ä¢ ");
        c.appendChild(det);
        projectsListEl.appendChild(c);
      });

      // training summary
      const lines=[]; const summaryCounts={};
      (member.projects||[]).forEach(project=>{
        const s = project.scores||{}; const weak=[];
        Object.entries(s).forEach(([k,v])=>{ const num = typeof v === "number" ? v : 0; if (num < 7) weak.push(SCORE_LABELS[k]||k); if (num <= 5) summaryCounts[SCORE_LABELS[k]||k] = (summaryCounts[SCORE_LABELS[k]||k]||0)+1; });
        if (weak.length) lines.push(`${member.isAllTeam && project.ownerName ? project.ownerName+' ‚Äì ' : member.name+' ‚Äì '} ${project.name}: [${weak.join("ÿå ")}]`);
      });
      trainingListEl.innerHTML = lines.length ? lines.join("<br>") : "ŸÖŸÅŸäÿ¥ ŸÜŸÇÿßÿ∑ ÿ∂ÿπŸÅ Ÿàÿßÿ∂ÿ≠ÿ© ÿØŸÑŸàŸÇÿ™Ÿäÿå ÿ¥ÿ∫ŸÑ ŸÉŸàŸäÿ≥ üëå";
    }

    function renderHeaderForMember(member){
      if (!member){ currentMemberTitle.textContent="Select team member"; currentMemberSub.textContent="Choose a team member"; return; }
      if (member.isAllTeam){
        currentMemberTitle.textContent = "All team";
        currentMemberSub.textContent = `Members: ${state.members.length}`;
      } else {
        const avg = computeAssessmentAverage(member);
        currentMemberTitle.textContent = member.name;
        currentMemberSub.textContent = `Overall assessment: ${avg.toFixed(1)}% ‚Äì ${member.projects?.length||0} project(s)`;
      }
    }

    function renderTabs(){
      tabButtons.forEach(btn=> btn.classList.toggle("active", btn.dataset.tab === state.activeTab));
      // (we keep content single view ‚Äî filters and lists are always visible in this simplified test)
    }

    function renderAll(){
      renderTabs();
      renderTeamList();
      const member = getCurrentMember();
      renderHeaderForMember(member);
      renderFiltersAndStats(member);
      renderProjectsList(member);
      initConversionState();
      if (!state.conversion.currentDate) state.conversion.currentDate = todayISO();
    }

    // ---------- actions: add member / project ----------
    addMemberBtn.addEventListener("click", ()=>{ const name = newMemberInput.value.trim(); if (!name) return; const member = { id: uid(), name, projects: [] }; state.members.push(member); state.selectedMemberId = member.id; newMemberInput.value=""; saveState(); renderAll(); });
    newMemberInput.addEventListener("keydown", e=>{ if (e.key === "Enter") addMemberBtn.click(); });

    addProjectBtn.addEventListener("click", ()=>{
      const member = getCurrentMember(); if (!member || member.isAllTeam){ alert("Select a specific team member first (not All team)."); return; }
      const realMember = state.members.find(m=>m.id===member.id); if (!realMember) return;
      const name = projectNameEl.value.trim(); const dev = projectDeveloperEl.value.trim(); const region = projectRegionEl.value.trim();
      if (!name){ alert("Please enter project name."); return; }
      const scores = {}; let sum=0, count=0;
      function parseScore(id,key){ const el=document.getElementById(id); const v=parseFloat(el?.value); const val = isNaN(v)?0:Math.min(Math.max(v,0),10); scores[key]=val; sum+=val; count++; }
      parseScore("scoreDevelopment","development"); parseScore("scoreLocation","location"); parseScore("scoreMasterplan","masterplan"); parseScore("scoreFacilities","facilities"); parseScore("scoreType","type"); parseScore("scorePrice","price"); parseScore("scorePayment","payment"); parseScore("scoreDelivery","delivery"); parseScore("scoreFinishing","finishing"); parseScore("scoreMaintenance","maintenance"); parseScore("scoreOrientation","orientation");
      const avg = count? sum/count : 0; const overallPercent = (avg/10)*100;
      if (editingProjectId){
        const existing = realMember.projects.find(p=>p.id===editingProjectId);
        if (existing){ existing.name=name; existing.developer=dev; existing.region=region; existing.scores=scores; existing.notes=projectNotesEl.value.trim(); existing.lastReassessedAt=Date.now(); existing.lastDelta = overallPercent - (existing.overallPercent||0); existing.overallPercent = overallPercent; }
      } else {
        realMember.projects = realMember.projects || [];
        realMember.projects.push({ id: uid(), name, developer:dev, region, scores, notes: projectNotesEl.value.trim(), overallPercent, createdAt: Date.now() });
      }
      saveState(); clearForm(); renderAll();
    });

    cancelEditBtn.addEventListener("click", clearForm);

    function clearForm(){
      projectNameEl.value=""; projectDeveloperEl.value=""; projectRegionEl.value=""; projectNotesEl.value="";
      scoreIds.forEach(id=>{ const el=document.getElementById(id); if (el) el.value=""; });
      editingProjectId = null; document.getElementById("formTitle").textContent = "New Project Assessment";
    }

    regionFilter.addEventListener("change", ()=>{ renderFiltersAndStats(getCurrentMember()); renderProjectsList(getCurrentMember()); });
    developerFilter.addEventListener("change", ()=>{ renderFiltersAndStats(getCurrentMember()); renderProjectsList(getCurrentMember()); });

    // ---------- Populate sample data (for testing) ----------
    populateBtn.addEventListener("click", ()=>{
      // create sample members + projects + conversion entries
      state.members = [];
      for (let i=1;i<=4;i++){
        const m = { id: uid(), name: `Sale ${i}`, projects: [] };
        for (let p=1;p<=3;p++){
          const scores = { development: rnd(), location: rnd(), masterplan: rnd(), facilities: rnd(), type: rnd(), price: rnd(), payment: rnd(), delivery: rnd(), finishing: rnd(), maintenance: rnd(), orientation: rnd() };
          const avg = Object.values(scores).reduce((a,b)=>a+b,0)/Object.keys(scores).length;
          m.projects.push({ id: uid(), name:`Project ${i}-${p}`, developer: ["Emaar","SODIC","HydePark"][p%3], region: ["New Zayed","New Cairo","North Coast"][p%3], scores, overallPercent: (avg/10)*100, createdAt: Date.now() - p*1000000 });
        }
        state.members.push(m);
      }
      // conversion entries (random) for current month
      const today = todayISO();
      state.conversion.currentDate = today;
      state.conversion.entries = {};
      const [y,m] = today.split("-");
      for (let d=1; d<=3; d++){
        const day = `${y}-${m}-${String(d).padStart(2,"0")}`;
        state.conversion.entries[day] = {};
        state.members.forEach(mem=>{
          state.conversion.entries[day][mem.id] = { deals:Math.floor(Math.random()*3), scheduled:Math.floor(Math.random()*4), meetings:Math.floor(Math.random()*3), requests:Math.floor(Math.random()*4), callBack:0, activeCalls:Math.floor(Math.random()*10), calls:Math.floor(Math.random()*20) };
        });
      }
      saveState(); state.selectedMemberId = state.members[1]?.id; renderAll();
      function rnd(){ return Math.round((Math.random()*8+1)*2)/2; }
    });

    // ---------- Export modal logic ----------
    exportBtn.addEventListener("click", ()=>{ exportModal.style.display="flex"; });

    cancelExport.addEventListener("click", ()=>{ exportModal.style.display="none"; });

    // helper: build overview card DOM for one member
    function buildOverviewCard(member, includeTrends){
      const container = document.createElement("div");
      container.style.padding = "12px";
      container.style.background = "#fff";
      container.style.color = "#000";
      container.style.borderRadius = "8px";
      container.style.fontFamily = "Arial, Helvetica, sans-serif";
      container.style.width = "100%";
      container.style.boxSizing = "border-box";

      const header = document.createElement("div"); header.style.display="flex"; header.style.justifyContent="space-between"; header.style.alignItems="center";
      const left = document.createElement("div");
      const title = document.createElement("div"); title.style.fontSize="20px"; title.style.fontWeight="700"; title.textContent = member.name;
      const meta = document.createElement("div"); meta.style.fontSize="12px"; meta.textContent = `${(member.projects?.length||0)} project(s)`;
      left.appendChild(title); left.appendChild(meta);
      header.appendChild(left);

      const pill = document.createElement("div"); pill.style.textAlign="right";
      const avg = computeAssessmentAverage(member); const pillText = `${avg.toFixed(0)}%`;
      const pillBox = document.createElement("div"); pillBox.style.padding="8px 12px"; pillBox.style.borderRadius="999px"; pillBox.style.fontWeight="700"; pillBox.textContent = pillText;
      if (avg < 60) pillBox.style.background="#fff0f0"; else if (avg < 80) pillBox.style.background="#fff8e6"; else pillBox.style.background="#e8fff0";
      pill.appendChild(pillBox);
      header.appendChild(pill);

      container.appendChild(header);

      const projectsDiv = document.createElement("div"); projectsDiv.style.marginTop="12px";
      const projTitle = document.createElement("div"); projTitle.textContent = "Top projects (filtered)"; projTitle.style.fontWeight="700"; projectsDiv.appendChild(projTitle);

      const table = document.createElement("table"); table.style.width="100%"; table.style.borderCollapse="collapse"; table.style.marginTop="8px";
      const thead = document.createElement("thead"); thead.innerHTML = `<tr><th style="text-align:left;border-bottom:1px solid #ddd;padding:6px">Project</th><th style="border-bottom:1px solid #ddd;padding:6px">Region</th><th style="border-bottom:1px solid #ddd;padding:6px">Developer</th><th style="border-bottom:1px solid #ddd;padding:6px">Score</th></tr>`;
      table.appendChild(thead);
      const tbody = document.createElement("tbody");
      // use filtered projects (based on current filters)
      const selR = regionFilter.value || "all", selD = developerFilter.value || "all";
      const projects = (member.projects||[]).filter(p=> (selR==="all"||p.region===selR) && (selD==="all"||p.developer===selD));
      projects.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.name}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.region||''}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.developer||''}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.overallPercent.toFixed(1)}%</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      projectsDiv.appendChild(table);
      container.appendChild(projectsDiv);

      if (includeTrends){
        const trends = document.createElement("div"); trends.style.marginTop="12px";
        trends.innerHTML = `<div style="font-weight:700">Trends</div><div style="margin-top:6px;font-size:13px">Reassessments & improvements are tracked per project inside the tool.</div>`;
        container.appendChild(trends);
      }

      return container;
    }

    // helper: build assessment DOM (projects list)
    function buildAssessmentDOM(member){
      const container = document.createElement("div"); container.style.background="#fff"; container.style.color="#000"; container.style.padding="12px"; container.style.borderRadius="8px"; container.style.fontFamily="Arial, Helvetica, sans-serif";
      const title = document.createElement("div"); title.style.fontWeight="700"; title.textContent = `Assessment ‚Äî ${member.name}`;
      container.appendChild(title);

      const selR = regionFilter.value || "all", selD = developerFilter.value || "all";
      const projects = (member.projects||[]).filter(p=> (selR==="all"||p.region===selR) && (selD==="all"||p.developer===selD));
      if (!projects.length){ const e = document.createElement("div"); e.textContent="No projects with current filters"; e.style.marginTop="8px"; container.appendChild(e); return container; }

      const table = document.createElement("table"); table.style.width="100%"; table.style.borderCollapse="collapse"; table.style.marginTop="8px";
      table.innerHTML = `<thead><tr><th style="text-align:left;border-bottom:1px solid #ddd;padding:6px">Project</th><th style="border-bottom:1px solid #ddd;padding:6px">Region</th><th style="border-bottom:1px solid #ddd;padding:6px">Developer</th><th style="border-bottom:1px solid #ddd;padding:6px">Score</th></tr></thead>`;
      const tbody = document.createElement("tbody");
      projects.forEach(p=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `<td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.name}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.region||''}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.developer||''}</td><td style="padding:6px;border-bottom:1px solid #f0f0f0">${p.overallPercent.toFixed(1)}%</td>`;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
      return container;
    }

    // helper: build conversion table DOM (day)
    function buildConversionDOM(dateStr){
      const container = document.createElement("div"); container.style.background="#fff"; container.style.color="#000"; container.style.padding="12px"; container.style.borderRadius="8px"; container.style.fontFamily="Arial, Helvetica, sans-serif";
      const title = document.createElement("div"); title.style.fontWeight="700"; title.textContent = `Conversion ‚Äî ${dateStr}`;
      container.appendChild(title);

      const table = document.createElement("table"); table.style.width="100%"; table.style.borderCollapse="collapse"; table.style.marginTop="8px";
      const headers = `<tr><th style="text-align:left;padding:6px;border-bottom:1px solid #ddd">Sales</th>${CONV_METRICS.map(h=>`<th style="padding:6px;border-bottom:1px solid #ddd">${CONV_LABELS[h]||h}</th>`).join("")}</tr>`;
      table.innerHTML = `<thead>${headers}</thead>`;
      const tbody = document.createElement("tbody");
      const entries = state.conversion.entries[dateStr] || {};
      state.members.forEach(mem=>{
        const entry = entries[mem.id] || {};
        const tr = document.createElement("tr");
        let cells = `<td style="padding:6px;border-bottom:1px solid #f0f0f0">${mem.name}</td>`;
        CONV_METRICS.forEach(m=> cells += `<td style="padding:6px;border-bottom:1px solid #f0f0f0">${entry[m]||0}</td>`);
        tr.innerHTML = cells;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
      return container;
    }

    function getSelectedTemplate(){
      const v = document.querySelector('input[name="template"]:checked')?.value;
      return v || "overview_single";
    }

    confirmExport.addEventListener("click", async ()=>{
      try{
        const template = getSelectedTemplate();
        const includeTrends = document.getElementById("includeTrends").checked;
        const openAfter = document.getElementById("openAfterGenerate").checked;
        const landscape = document.getElementById("landscapeMode").checked;

        // build DOM fragment to feed to html2pdf
        const fragment = document.createElement("div");
        fragment.style.padding = "10px";
        fragment.style.boxSizing = "border-box";

        if (template === "overview_single"){
          const member = getCurrentMember();
          if (!member || member.isAllTeam){ alert("Select a specific member for single-card export."); return; }
          const card = buildOverviewCard(member, includeTrends);
          fragment.appendChild(card);
        } else if (template === "overview_all"){
          // build all member cards
          state.members.forEach(m=>{
            const card = buildOverviewCard(m, includeTrends);
            fragment.appendChild(card);
            // page break
            const pb = document.createElement("div"); pb.style.pageBreakAfter = "always"; fragment.appendChild(pb);
          });
        } else if (template === "assessment_filtered"){
          const member = getCurrentMember();
          if (!member){ alert("Select member (or All team) first."); return; }
          // if All team selected, export each member's assessment as separate section
          if (member.isAllTeam){
            state.members.forEach(m=>{
              fragment.appendChild(buildAssessmentDOM(m));
              const pb = document.createElement("div"); pb.style.pageBreakAfter = "always"; fragment.appendChild(pb);
            });
          } else {
            fragment.appendChild(buildAssessmentDOM(member));
          }
        } else if (template === "conversion_table"){
          const dateStr = state.conversion.currentDate || todayISO();
          fragment.appendChild(buildConversionDOM(dateStr));
        }

        // prepare options for html2pdf
        const opt = {
          margin:       10,
          filename:     `${(getCurrentMember()?.name||"report").replace(/\s+/g,"_")}_${new Date().toISOString().slice(0,10)}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true, logging:false },
          jsPDF:        { unit: 'mm', format: landscape ? 'a4' : 'a4', orientation: landscape ? 'landscape' : 'portrait' }
        };

        // show small feedback
        confirmExport.textContent = "Generating...";
        confirmExport.disabled = true;

        // run html2pdf: use from(element).toPdf().get('pdf') to open in new tab if needed
        await new Promise((resolve, reject) => {
          html2pdf().from(fragment).set(opt).save().then(() => { resolve(); }).catch(err => { reject(err); });
        });

        confirmExport.textContent = "Generate PDF";
        confirmExport.disabled = false;
        exportModal.style.display = "none";
      } catch(err){
        console.error(err); alert("Export failed: "+(err.message||err));
        confirmExport.textContent = "Generate PDF";
        confirmExport.disabled = false;
      }
    });

    // ---------- backup / restore ----------
    backupBtn.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = `br_assessment_backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    restoreAutoBtn.addEventListener("click", ()=>{
      const raw = localStorage.getItem(AUTO_BACKUP_KEY);
      if (!raw){ alert("No auto backup found."); return; }
      try{ state = JSON.parse(raw); initConversionState(); saveState(); renderAll(); alert("Auto backup restored."); } catch(e){ alert("Restore failed"); }
    });

    // tabs
    tabButtons.forEach(btn=> btn.addEventListener("click", ()=>{
      state.activeTab = btn.dataset.tab; saveState(); renderAll(); tabButtons.forEach(x=>x.classList.toggle("active", x===btn));
    }));

    // ---------- init ----------
    loadState();
    renderAll();

    // expose a note to user about testing on iPad:
    console.log("To test on iPad: save this HTML file, open it in Safari on your iPad. Use 'Populate sample data' then 'Export PDF'.");

  </script>
</body>
</html>