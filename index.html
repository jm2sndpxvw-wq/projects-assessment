â€<!DOCTYPE html><!DOCTYPE html><!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projects Assessment â€“ Real Estate Team</title>
  <style>
    /* (Ù†ÙØ³ Ø§Ù„Ù€ CSS Ø§Ù„Ù„ÙŠ Ø§Ù†Øª Ø¨Ø¹ØªÙ‡Ø§ Ø¨Ø§Ù„Ø¸Ø¨Ø·) */
    :root {
      --bg: #0b0d10;
      --bg-alt: #151921;
      --bg-alt-soft: #1b2029;
      --primary: #4f8cff;
      --primary-soft: #223455;
      --text: #f5f7fb;
      --text-muted: #9aa4c0;
      --danger: #ff4b5c;
      --warning: #ffbf47;
      --success: #28c76f;
      --border: #252c3a;
      --card-radius: 10px;
      --shadow-soft: 0 8px 20px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", sans-serif; }
    body { background: radial-gradient(circle at top, #1a2134 0, #05060a 55%); color: var(--text); min-height: 100vh; display: flex; justify-content: center; padding: 16px; }
    .app { width: 100%; max-width: 1280px; background: linear-gradient(135deg, #090b10 0, #111623 45%, #090b10 100%); border-radius: 18px; box-shadow: var(--shadow-soft); display: grid; grid-template-columns: 260px 1fr; overflow: hidden; border: 1px solid rgba(255,255,255,0.04); }

    /* Sidebar */
    .sidebar { background: radial-gradient(circle at top left, #20263a 0, #070910 55%); border-right: 1px solid var(--border); padding: 18px 16px; display: flex; flex-direction: column; gap: 16px; }
    .app-title { font-size: 18px; font-weight: 700; display:flex; align-items:center; gap:8px; }
    .app-title span.logo { width:26px; height:26px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; background: radial-gradient(circle at 30% 0, #7c8cff, #3a4bff, #141633); box-shadow:0 0 18px rgba(79,140,255,0.55); font-size:14px; }
    .app-sub { font-size:11px; color:var(--text-muted); margin-top:4px; }

    .team-header { display:flex; align-items:center; justify-content:space-between; margin-top:6px; margin-bottom:4px; }
    .team-header span { font-size:12px; color:var(--text-muted); letter-spacing:0.03em; text-transform:uppercase; }

    .team-list { display:flex; flex-direction:column; gap:6px; margin-bottom:6px; max-height:260px; overflow-y:auto; padding-right:4px; }
    .team-item { border-radius:10px; padding:8px 10px; background:rgba(16,21,34,0.9); border:1px solid transparent; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:0.18s ease; position:relative; }
    .team-item.active { border-color:var(--primary); background: radial-gradient(circle at 0 0, #27345c 0, #131723 48%); box-shadow:0 0 0 1px rgba(79,140,255,0.4); }
    .team-item:hover { background:#171c29; }
    .team-main { display:flex; flex-direction:column; gap:3px; }
    .team-name { font-size:13px; font-weight:600; }
    .team-meta { font-size:11px; color:var(--text-muted); }
    .team-score-pill { padding:3px 8px; border-radius:999px; font-size:10px; font-weight:600; letter-spacing:0.04em; text-transform:uppercase; border:1px solid rgba(255,255,255,0.08); }
    .pill-red { color:var(--danger); border-color:rgba(255,75,92,0.65); }
    .pill-yellow { color:var(--warning); border-color:rgba(255,191,71,0.7); }
    .pill-green { color:var(--success); border-color:rgba(40,199,111,0.7); }

    .add-team { display:flex; gap:6px; margin-top:4px; }
    .add-team input { flex:1; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:rgba(8,10,16,0.9); color:var(--text); font-size:12px; outline:none; }
    .add-team button { border-radius:999px; padding:0 10px; font-size:11px; border:none; background:var(--primary); color:#fff; cursor:pointer; transition:0.18s ease; }
    .add-team button:hover { background:#3a70ff; }
    .hint-mini { font-size:10px; color:var(--text-muted); margin-top:2px; }
    .sidebar-footer { margin-top:auto; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.07); font-size:11px; color:var(--text-muted); display:flex; flex-direction:column; gap:4px; }
    .sidebar-footer strong { color:var(--text); font-weight:600; }

    /* Main */
    .main { padding:18px 18px 18px 16px; display:flex; flex-direction:column; gap:10px; }
    .main-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .main-header-left { display:flex; flex-direction:column; gap:4px; }
    .main-title { font-size:16px; font-weight:600; }
    .main-sub { font-size:11px; color:var(--text-muted); }

    .main-actions { display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background:rgba(8,10,16,0.9); color:var(--text); font-size:11px; cursor:pointer; display:inline-flex; align-items:center; gap:4px; transition:0.18s ease; }
    .btn-primary { background:var(--primary); border-color:rgba(79,140,255,0.9); color:#fff; }
    .btn-primary:hover { background:#3a70ff; } .btn:hover { background:#171c29; }
    .btn input[type="file"]{ display:none; }

    .tabs-row { display:flex; gap:6px; font-size:11px; }
    .tab-btn { padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(8,10,16,0.9); color:var(--text-muted); cursor:pointer; font-size:11px; }
    .tab-btn.active { background:var(--primary); border-color:rgba(79,140,255,0.9); color:#fff; }

    .hidden { display:none !important; }

    .filters-row { display:flex; gap:8px; align-items:center; font-size:11px; color:var(--text-muted); margin-top:6px; }
    .filters-row select { background:var(--bg-alt); color:var(--text); border-radius:999px; border:1px solid var(--border); padding:4px 8px; font-size:11px; outline:none; }
    .chip { padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:10px; }
    .chip-soft { background:rgba(255,255,255,0.02); border-style:dashed; }

    .content-grid { display:grid; grid-template-columns:minmax(0,280px) minmax(0,1fr); gap:12px; margin-top:6px; height:calc(100% - 60px); min-height:0; }

    .panel { background:var(--bg-alt); border-radius:14px; border:1px solid var(--border); padding:10px 10px 12px; display:flex; flex-direction:column; gap:8px; overflow:hidden; }
    .panel-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .panel-title { font-size:12px; font-weight:600; }
    .panel-sub { font-size:10px; color:var(--text-muted); }
    .form-grid { display:grid; grid-template-columns:1fr; gap:6px; margin-top:2px; max-height:100%; overflow-y:auto; padding-right:2px; }
    .field { display:flex; flex-direction:column; gap:2px; }
    .field label { font-size:10px; color:var(--text-muted); }
    .field input, .field textarea, .field select { background:#0d1017; border-radius:8px; border:1px solid var(--border); padding:5px 7px; font-size:11px; color:var(--text); outline:none; }
    .field input:focus, .field textarea:focus, .field select:focus { border-color:var(--primary); }
    .field textarea { min-height:40px; resize:vertical; }

    .scores-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:4px 8px; }
    .score-input { width:100%; }
    .score-input::-webkit-outer-spin-button, .score-input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }

    .projects-panel { position:relative; min-height:0; display:flex; flex-direction:column; }
    .cards-list { margin-top:4px; overflow-y:auto; padding-right:2px; display:flex; flex-direction:column; gap:6px; }

    .card { background:var(--bg-alt-soft); border-radius:12px; border:1px solid var(--border); padding:8px 9px; display:flex; flex-direction:column; gap:6px; cursor:pointer; transition:0.15s ease; }
    .card:hover { border-color:rgba(255,255,255,0.12); background:#191f2b; }
    .card.reassessed { box-shadow:0 0 0 1px rgba(40,199,111,0.4); }
    .card-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .card-title-block { display:flex; flex-direction:column; gap:2px; }
    .card-title { font-size:12px; font-weight:600; }
    .card-subtitle { font-size:10px; color:var(--text-muted); }
    .card-tag { padding:3px 8px; border-radius:999px; font-size:10px; border:1px solid var(--border); }
    .tag-red { color:var(--danger); border-color:rgba(255,75,92,0.7); }
    .tag-yellow { color:var(--warning); border-color:rgba(255,191,71,0.7); }
    .tag-green { color:var(--success); border-color:rgba(40,199,111,0.7); }
    .card-footer { display:flex; justify-content:space-between; align-items:center; gap:6px; font-size:10px; color:var(--text-muted); flex-wrap:wrap; }
    .card-footer span.bold { font-weight:600; color:var(--text); font-size:11px; }
    .details { margin-top:4px; border-top:1px dashed rgba(255,255,255,0.08); padding-top:4px; display:none; font-size:10px; color:var(--text-muted); }
    .details-row { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:3px 10px; margin-top:2px; }
    .details-row span { display:flex; justify-content:space-between; }
    .details-row span strong { font-weight:500; color:var(--text); }
    .card.open .details { display:block; }
    .training-panel { font-size:11px; color:var(--text-muted); display:flex; flex-direction:column; gap:4px; margin-top:4px; }
    .training-list { font-size:10px; line-height:1.4; max-height:90px; overflow-y:auto; padding-right:2px; }
    .empty-state { font-size:11px; color:var(--text-muted); padding:12px 4px; text-align:center; }
    .print-only { display:none; }

    /* Conversion */
    .conversion-layout { display:grid; grid-template-columns:minmax(0,260px) minmax(0,1fr); gap:12px; margin-top:6px; }
    .conversion-table { width:100%; border-collapse:collapse; font-size:10px; }
    .conversion-table th, .conversion-table td { border:1px solid var(--border); padding:4px 5px; text-align:center; }
    .conversion-table th { font-size:10px; background:#151a25; }
    .conversion-table td input { width:100%; border-radius:6px; border:1px solid var(--border); background:#05070b; color:var(--text); font-size:10px; padding:3px 4px; text-align:center; }
    .conversion-table .sales-name-cell { text-align:left; font-weight:600; font-size:11px; }
    .percent-chip { font-size:9px; margin-top:2px; display:inline-block; }
    .percent-good { color:var(--success); } .percent-mid { color:var(--warning); } .percent-bad { color:var(--danger); }
    .conversion-summary { font-size:10px; color:var(--text-muted); margin-top:6px; line-height:1.5; }
    .conversion-summary-line { margin-bottom:2px; }
    .sales-total-row td { background:#101521; font-weight:600; }

    /* Members overview styles */
    .overview-panel { padding:10px; }
    .overview-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:10px; margin-top:8px; }
    .member-card { background:var(--bg-alt-soft); border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .member-top { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .member-name { font-weight:700; font-size:14px; }
    .member-meta { font-size:11px; color:var(--text-muted); }
    .scores-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .score-block { flex:1; min-width:96px; padding:8px; border-radius:8px; background:rgba(8,10,16,0.6); border:1px solid rgba(255,255,255,0.02); text-align:center; }
    .score-label { font-size:11px; color:var(--text-muted); margin-bottom:4px; }
    .score-value { font-weight:700; font-size:16px; }
    .total-performance { display:flex; align-items:center; gap:8px; justify-content:space-between; padding:8px; border-radius:8px; background:linear-gradient(90deg, rgba(10,12,18,0.6), rgba(15,18,28,0.6)); border:1px solid rgba(255,255,255,0.03); }
    .trend { font-size:13px; display:flex; align-items:center; gap:6px; color:var(--text-muted); }
    .trend.up { color:var(--success); } .trend.down { color:var(--danger); } .trend.flat { color:var(--text-muted); }

    /* scrollbar */
    ::-webkit-scrollbar { width:5px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:#303545; border-radius:999px; }

    @media (max-width:900px) {
      .app { grid-template-columns:1fr; }
      .sidebar { border-right:none; border-bottom:1px solid var(--border); flex-direction:column; }
      .content-grid, .conversion-layout { grid-template-columns:1fr; height:auto; }
    }

    @media print {
      body { background:#05060a !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .app, .sidebar, .main, .panel, .card, .team-item.active, .filters-row, .training-panel { background-color:#111623 !important; color:#f5f7fb !important; }
      .main-actions, .tabs-row { display:none !important; }
      #assessmentTab .content-grid { grid-template-columns:1fr !important; }
      #assessmentTab .content-grid > section:first-child { display:none !important; }
      .team-item { display:none !important; }
      .team-item.active { display:flex !important; }
      .add-team, .hint-mini { display:none !important; }
      #projectsList { display:none !important; }
      #printProjectsList { display:flex !important; }
      #assessmentTab.hidden, #conversionTab.hidden, #overviewTab.hidden { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="app-title">
          <span class="logo">BR</span>
          <div>
            Bold Routes â€“ Projects Assessment
            <div class="app-sub">Dark mode â€¢ Compact â€¢ Team based</div>
          </div>
        </div>
      </div>

      <div class="team-header">
        <span>Team members</span>
      </div>
      <div class="team-list" id="teamList"></div>

      <div class="add-team">
        <input id="newMemberInput" placeholder="Add new member..." />
        <button id="addMemberBtn" type="button">Add</button>
      </div>
      <div class="hint-mini">Long press on member name to delete ğŸ—‘ï¸</div>

      <div class="sidebar-footer">
        <div>
          <strong>Color codes (Project):</strong><br />
          ğŸŸ¥ &lt; 60% â€“ Needs training<br />
          ğŸŸ¨ 60â€“79% â€“ Average<br />
          ğŸŸ© â‰¥ 80% â€“ Confident
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="main-header">
        <div class="main-header-left">
          <div class="main-title" id="currentMemberTitle">Select team member</div>
          <div class="main-sub" id="currentMemberSub">Choose a team member from the left to start assessment.</div>
        </div>
        <div class="main-actions">
          <button class="btn" id="exportBtn" type="button">Export PDF (Current)</button>
          <button class="btn" id="backupBtn" type="button">Backup</button>
          <label class="btn"> Restore file <input type="file" id="restoreFileInput" accept="application/json" /></label>
          <button class="btn" id="restoreAutoBtn" type="button">Restore auto</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs-row">
        <button class="tab-btn active" data-tab="assessment">Assessment</button>
        <button class="tab-btn" data-tab="conversion">Conversion</button>
        <button class="tab-btn" data-tab="overview">Members overview</button>
      </div>

      <!-- ASSESSMENT TAB -->
      <div id="assessmentTab">
        <div class="filters-row">
          <span>Region:</span>
          <select id="regionFilter"><option value="all">All regions</option></select>
          <span>Developer:</span>
          <select id="developerFilter"><option value="all">All developers</option></select>
          <span class="chip chip-soft" id="regionStats">No projects yet</span>
        </div>

        <div class="content-grid">
          <!-- LEFT: FORM -->
          <section class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title" id="formTitle">New Project Assessment</div>
                <div class="panel-sub">Rate each point from 0 to 10 (English labels)</div>
              </div>
            </div>

            <div class="form-grid">
              <div class="field"><label>Project name</label><input id="projectName" placeholder="e.g. New Zayed Lakes" /></div>
              <div class="field"><label>Developer</label><input id="projectDeveloper" placeholder="e.g. Emaar, SODIC..." /></div>
              <div class="field"><label>Region / Area</label><input id="projectRegion" placeholder="e.g. New Zayed, NAC..." /></div>

              <div class="scores-grid">
                <div class="field"><label>Development</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreDevelopment" placeholder="0â€“10" /></div>
                <div class="field"><label>Location</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreLocation" placeholder="0â€“10" /></div>
                <div class="field"><label>Masterplan</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreMasterplan" placeholder="0â€“10" /></div>
                <div class="field"><label>Facilities</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreFacilities" placeholder="0â€“10" /></div>
                <div class="field"><label>Type mix</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreType" placeholder="0â€“10" /></div>
                <div class="field"><label>Price positioning</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scorePrice" placeholder="0â€“10" /></div>
                <div class="field"><label>Payment plan</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scorePayment" placeholder="0â€“10" /></div>
                <div class="field"><label>Delivery date</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreDelivery" placeholder="0â€“10" /></div>
                <div class="field"><label>Finishing quality</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreFinishing" placeholder="0â€“10" /></div>
                <div class="field"><label>Maintenance (deposit)</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreMaintenance" placeholder="0â€“10" /></div>
                <div class="field"><label>Orientation skills</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreOrientation" placeholder="0â€“10" /></div>
              </div>

              <div class="field"><label>Notes (optional)</label><textarea id="projectNotes" placeholder="Any remarks, red flags, comparison with competitors..."></textarea></div>

              <div class="submit-row">
                <button class="btn btn-primary" id="addProjectBtn" type="button">Save project</button>
                <button class="btn" id="cancelEditBtn" type="button">Cancel edit</button>
              </div>
            </div>
          </section>

          <!-- RIGHT: CARDS + TRAINING -->
          <section class="panel projects-panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Projects & Scores</div>
                <div class="panel-sub">Click on a card to expand details â€“ filtered by region & developer.</div>
              </div>
            </div>

            <div class="cards-list" id="projectsList"><div class="empty-state">No projects yet. Add a new assessment on the left.</div></div>
            <div class="cards-list print-only" id="printProjectsList"></div>

            <div class="training-panel">
              <div><strong>Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ): Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ø­Ø³Ø¨ ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹</strong></div>
              <div class="training-list" id="trainingList">Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.</div>
              <div style="margin-top:4px;"><strong>Ù†Ù‚Ø· Ù…ØªÙƒØ±Ø±Ø© Ø£Ù‚Ù„ Ù…Ù† Ù¥/Ù¡Ù  Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹:</strong></div>
              <div class="training-list" id="trainingSummaryList">Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.</div>
            </div>
          </section>
        </div>
      </div>

      <!-- CONVERSION TAB -->
      <div id="conversionTab" class="hidden">
        <div class="conversion-layout">
          <section class="panel">
            <div class="panel-header"><div><div class="panel-title">Daily conversion</div><div class="panel-sub">Sales write numbers, tool calculates %</div></div></div>
            <div class="form-grid">
              <div class="field"><label>Select date</label><input type="date" id="convDate" /></div>
              <div class="field"><label>Targets mode</label><small>Choose per day / per month for each metric</small></div>
              <div class="field">
                <table class="conversion-table">
                  <thead><tr><th>Metric</th><th>Target</th><th>Mode</th><th>Daily</th><th>Monthly</th></tr></thead>
                  <tbody id="convTargetsBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header"><div><div class="panel-title">Team performance (per day & month)</div><div class="panel-sub">Numbers per sales â€“ plus monthly totals under each one</div></div></div>

            <div style="overflow-x:auto;">
              <table class="conversion-table" id="convTable">
                <thead><tr><th>Sales name</th><th>Deals</th><th>Scheduled</th><th>Meetings</th><th>Requests</th><th>Call back</th><th>Active calls</th><th>Calls</th><th>Total %</th></tr></thead>
                <tbody id="convTableBody"></tbody>
              </table>
            </div>

            <div class="conversion-summary" id="convSummary">Ù…ÙÙŠØ´ Ø¯Ø§ØªØ§ Ù„Ø³Ù‡ Ù„Ù„ÙŠÙˆÙ… Ø¯Ù‡.</div>
          </section>
        </div>
      </div>

      <!-- OVERVIEW TAB -->
      <div id="overviewTab" class="hidden">
        <div class="panel overview-panel">
          <div class="panel-header">
            <div><div class="panel-title">Members overview</div><div class="panel-sub">50/50 weight â€” Assessment & Conversion combined (Total performance)</div></div>
            <div>
              <small class="panel-sub">Date for conversion: <span id="overviewDateLabel"></span></small>
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <label style="font-size:11px; color:var(--text-muted);">Choose month date:</label>
            <input type="month" id="overviewMonthInput" style="background:#0d1017; border-radius:8px; padding:6px; border:1px solid var(--border); color:var(--text);" />
          </div>

          <div class="overview-grid" id="overviewGrid"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* =========================
       Original baseline JS (unchanged)...
       (Ø£Ø²Ù„Øª Ø§Ù„Ø­Ø´Ùˆ Ù‡Ù†Ø§ ÙÙŠ Ø§Ù„Ø´Ø±Ø­ Ù„ÙƒÙ† ÙØ¹Ù„ÙŠÙ‹Ø§ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ Ù‡Ùˆ Ù†ÙØ³ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù„ÙŠ Ø¨Ø¹ØªØªÙ‡ â€” loadState, renderAll, event listeners... )
       ========================= */

    const STORAGE_KEY = "br_assessment_v3";
    const AUTO_BACKUP_KEY = "br_assessment_autobackup_v1";
    const ALL_TEAM_ID = "__ALL_TEAM__";

    // Conversion metrics
    const CONV_METRICS = ["deals","scheduled","meetings","requests","callBack","activeCalls","calls"];
    const CONV_TARGET_METRICS = ["deals","scheduled","meetings","requests","calls"];
    function hasTarget(metric){ return CONV_TARGET_METRICS.includes(metric); }
    const CONV_LABELS = { deals: "Deals", scheduled: "Scheduled", meetings: "Meetings", requests: "Requests", callBack: "Call back", activeCalls: "Active calls", calls: "Calls" };

    let state = { members: [], selectedMemberId: null, activeTab: "assessment", conversion: { currentDate: null, targets: {}, entries: {} } };
    let editingProjectId = null;

    function initConversionState() {
      if (!state.conversion) state.conversion = { currentDate: null, targets: {}, entries: {} };
      if (!state.conversion.targets) state.conversion.targets = {};
      CONV_TARGET_METRICS.forEach(m => { if (!state.conversion.targets[m]) state.conversion.targets[m] = { mode: "day", value: 0 }; });
      if (!state.conversion.entries) state.conversion.entries = {};
    }

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try { state = JSON.parse(raw); } catch(e){ console.error("Failed parse", e); }
      }
      if (!state.members) state.members = [];
      if (!state.selectedMemberId && state.members.length > 0) state.selectedMemberId = state.members[0].id;
      if (!state.activeTab) state.activeTab = "assessment";
      initConversionState();
    }

    function autoBackup(){ try{ localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify(state)); }catch(e){ console.warn("Auto backup failed", e); } }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); autoBackup(); }
    function uid(){ return Date.now().toString(36) + Math.random().toString(16).slice(2); }
    function todayISO(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return `${d.getFullYear()}-${m}-${day}`; }
    function daysInMonth(dateStr){ const [y,m] = dateStr.split("-").map(n=>parseInt(n,10)); return new Date(y,m,0).getDate(); }
    function monthPrefixFromDateStr(dateStr){ const [y,m] = dateStr.split("-"); return `${y}-${m}`; }

    // Elements
    const teamListEl = document.getElementById("teamList");
    const newMemberInput = document.getElementById("newMemberInput");
    const addMemberBtn = document.getElementById("addMemberBtn");
    const currentMemberTitle = document.getElementById("currentMemberTitle");
    const currentMemberSub = document.getElementById("currentMemberSub");
    const regionFilter = document.getElementById("regionFilter");
    const developerFilter = document.getElementById("developerFilter");
    const regionStats = document.getElementById("regionStats");
    const projectsListEl = document.getElementById("projectsList");
    const printProjectsListEl = document.getElementById("printProjectsList");
    const trainingListEl = document.getElementById("trainingList");
    const trainingSummaryListEl = document.getElementById("trainingSummaryList");
    const exportBtn = document.getElementById("exportBtn");
    const backupBtn = document.getElementById("backupBtn");
    const restoreFileInput = document.getElementById("restoreFileInput");
    const restoreAutoBtn = document.getElementById("restoreAutoBtn");

    const projectNameEl = document.getElementById("projectName");
    const projectDeveloperEl = document.getElementById("projectDeveloper");
    const projectRegionEl = document.getElementById("projectRegion");
    const projectNotesEl = document.getElementById("projectNotes");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const formTitleEl = document.getElementById("formTitle");
    const defaultFormTitle = formTitleEl.textContent;

    const tabButtons = document.querySelectorAll(".tab-btn");
    const assessmentTabEl = document.getElementById("assessmentTab");
    const conversionTabEl = document.getElementById("conversionTab");
    const overviewTabEl = document.getElementById("overviewTab");

    const convDateEl = document.getElementById("convDate");
    const convTargetsBody = document.getElementById("convTargetsBody");
    const convTableBody = document.getElementById("convTableBody");
    const convSummaryEl = document.getElementById("convSummary");

    const overviewGrid = document.getElementById("overviewGrid");
    const overviewMonthInput = document.getElementById("overviewMonthInput");
    const overviewDateLabel = document.getElementById("overviewDateLabel");

    const scoreIds = ["scoreDevelopment","scoreLocation","scoreMasterplan","scoreFacilities","scoreType","scorePrice","scorePayment","scoreDelivery","scoreFinishing","scoreMaintenance","scoreOrientation"];
    const SCORE_LABELS = { development:"Development", location:"Location", masterplan:"Masterplan", facilities:"Facilities", type:"Type mix", price:"Price positioning", payment:"Payment plan", delivery:"Delivery date", finishing:"Finishing", maintenance:"Maintenance", orientation:"Orientation skills" };

    function getCurrentMember(){
      if (state.selectedMemberId === ALL_TEAM_ID) {
        // return simplified all-team object (no projects shown in conversion)
        return { id: ALL_TEAM_ID, name: "All team", isAllTeam: true, projects: state.members.flatMap(m => (m.projects||[]).map(p => ({...p, ownerName: m.name}))) };
      }
      return state.members.find(m => m.id === state.selectedMemberId) || null;
    }

    // (Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯ Ø§Ù„Ù€ baseline ÙƒÙ…Ø§ Ù‡Ùˆ â€” Ù„Ø§ ØªØ¹Ø¯ÙŠÙ„Ù‡)
    // -----------------------------------------------------------------
    // [Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø¯ÙˆØ§Ù„ ÙˆØ§Ù„Ù€ renderAll Ùˆ event listeners â€” Ù†Ø³Ø®ØªÙ‡ ÙƒØ§Ù…Ù„Ø© ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ Ø£Ù†Øª]
    // -----------------------------------------------------------------

    // init load
    loadState();
    renderAll();

    /* =========================
       Cloud Sync Module (Gist) â€” integrated with STORAGE_KEY
       - Auto-sync every 60s (can change from settings)
       - Prompt for token first time
       - Default gistId set to your Gist (changeable via UI)
       ========================= */

    (function BRCloudSync(){
      const DEFAULT_GIST_ID = '46451b1db133cb423ed7dc856f957c24';
      const GIST_FILENAME = 'br_assessment_cloud.json';
      const LS_TOKEN_KEY = 'br_assessment_gist_token';
      const LS_GIST_KEY  = 'br_assessment_gist_id';
      // we will use the app STORAGE_KEY as source-of-truth snapshot
      const APP_STORAGE_KEY = STORAGE_KEY; // "br_assessment_v3"
      const DEFAULT_INTERVAL_MS = 60 * 1000; // every minute

      let token = localStorage.getItem(LS_TOKEN_KEY) || null;
      let gistId = localStorage.getItem(LS_GIST_KEY) || DEFAULT_GIST_ID;
      let autoIntervalMs = DEFAULT_INTERVAL_MS;
      let autoTimer = null;
      let isSyncing = false;

      function headers(){
        return {
          'Accept': 'application/vnd.github+json',
          'Authorization': token ? ('token ' + token) : '',
          'X-GitHub-Api-Version': '2022-11-28',
          'Content-Type': 'application/json'
        };
      }

      async function getGist(){
        const url = `https://api.github.com/gists/${gistId}`;
        const res = await fetch(url, { headers: headers() });
        if (!res.ok) throw new Error('Gist GET failed: ' + res.status);
        return res.json();
      }

      async function patchGist(contentString, message='Update from BR Assessment'){
        const url = `https://api.github.com/gists/${gistId}`;
        const body = JSON.stringify({
          files: { [GIST_FILENAME]: { content: contentString } },
          description: message
        });
        const res = await fetch(url, { method: 'PATCH', headers: headers(), body });
        if (!res.ok) throw new Error('Gist PATCH failed: ' + res.status);
        return res.json();
      }

      async function downloadCloud(){
        const gist = await getGist();
        const file = gist.files && gist.files[GIST_FILENAME];
        if (!file) return null;
        try { return JSON.parse(file.content || '{}'); } catch(e){ console.warn('cloud parse', e); return null; }
      }

      async function uploadCloud(obj){
        const payload = { metadata: { ts: new Date().toISOString(), origin: location.hostname }, data: obj };
        const content = JSON.stringify(payload, null, 2);
        return await patchGist(content);
      }

      function readLocalAppState(){
        try { const raw = localStorage.getItem(APP_STORAGE_KEY); return raw ? JSON.parse(raw) : null; } catch(e){ return null; }
      }
      function writeLocalAppState(obj){
        try { localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(obj)); } catch(e){ console.warn('write local failed', e); }
      }

      function smartMerge(localObj, cloudObj){
        function merge(a,b){
          if (a === undefined) return b;
          if (b === undefined) return a;
          if (Array.isArray(a) && Array.isArray(b)) return b.length ? b : a;
          if (typeof a === 'object' && typeof b === 'object') {
            const out = {...a};
            Object.keys(b).forEach(k=>{ out[k] = merge(a[k], b[k]); });
            return out;
          }
          return b;
        }
        return merge(localObj, cloudObj);
      }

      // UI
      function createUI(){
        if (document.getElementById('br-cloudsync-ui')) return;
        const C = document.createElement('div'); C.id = 'br-cloudsync-ui';
        C.style.position = 'fixed'; C.style.bottom = '18px'; C.style.right = '18px'; C.style.zIndex = '99999'; C.style.fontFamily = 'Inter, system-ui, -apple-system, "Segoe UI", Roboto';
        C.style.display = 'flex'; C.style.flexDirection = 'column'; C.style.gap = '8px';

        const box = document.createElement('div');
        box.style.background = 'rgba(20,20,25,0.95)'; box.style.color = '#fff'; box.style.padding = '10px'; box.style.borderRadius = '12px'; box.style.boxShadow = '0 6px 18px rgba(0,0,0,0.45)'; box.style.minWidth = '200px';

        const title = document.createElement('div'); title.textContent = 'Cloud Sync'; title.style.fontWeight='700'; title.style.marginBottom='8px'; box.appendChild(title);

        const status = document.createElement('div'); status.id='br-cloud-status'; status.textContent='Idle'; status.style.fontSize='12px'; status.style.opacity='0.9'; status.style.marginBottom='8px'; box.appendChild(status);

        const row = document.createElement('div'); row.style.display='flex'; row.style.gap='6px';
        const btnSync = document.createElement('button'); btnSync.textContent='Sync Now'; btnSync.style.flex='1'; btnSync.style.padding='6px'; btnSync.style.borderRadius='8px'; btnSync.style.border='none'; btnSync.style.cursor='pointer'; btnSync.style.background='#2563eb'; btnSync.style.color='#fff';
        btnSync.onclick = ()=> autoSyncNow();
        const btnRestore = document.createElement('button'); btnRestore.textContent='Restore'; btnRestore.style.flex='1'; btnRestore.style.padding='6px'; btnRestore.style.borderRadius='8px'; btnRestore.style.border='none'; btnRestore.style.cursor='pointer'; btnRestore.style.background='#10b981'; btnRestore.style.color='#fff';
        btnRestore.onclick = async ()=>{
          try {
            if (!token) { alert('No token set. Open Settings.'); return; }
            const cloud = await downloadCloud();
            if (!cloud || !cloud.data) { alert('No cloud data found'); setStatus('No cloud data'); return; }
            writeLocalAppState(cloud.data);
            // force app reload of state
            state = cloud.data;
            initConversionState();
            saveState();
            renderAll();
            alert('Restored latest cloud snapshot.');
            setStatus('Restored from cloud');
          } catch(e) { console.warn(e); alert('Restore failed'); setStatus('Restore failed'); }
        };
        row.appendChild(btnSync); row.appendChild(btnRestore);
        box.appendChild(row);

        const srow = document.createElement('div'); srow.style.display='flex'; srow.style.gap='6px'; srow.style.marginTop='8px';
        const btnSettings = document.createElement('button'); btnSettings.textContent='Settings'; btnSettings.style.flex='1'; btnSettings.style.padding='6px'; btnSettings.style.borderRadius='8px'; btnSettings.style.border='1px solid rgba(255,255,255,0.06)'; btnSettings.style.background='transparent'; btnSettings.style.color='#fff';
        const btnHist = document.createElement('button'); btnHist.textContent='History'; btnHist.style.flex='1'; btnHist.style.padding='6px'; btnHist.style.borderRadius='8px'; btnHist.style.border='1px solid rgba(255,255,255,0.06)'; btnHist.style.background='transparent'; btnHist.style.color='#fff';
        srow.appendChild(btnSettings); srow.appendChild(btnHist);
        box.appendChild(srow);

        C.appendChild(box);
        document.body.appendChild(C);

        // Settings modal
        const modal = document.createElement('div'); modal.id='br-cloud-modal'; modal.style.position='fixed'; modal.style.left='50%'; modal.style.top='50%'; modal.style.transform='translate(-50%,-50%)'; modal.style.background='#0b0b0f'; modal.style.color='#fff'; modal.style.padding='18px'; modal.style.borderRadius='12px'; modal.style.boxShadow='0 12px 40px rgba(0,0,0,0.6)'; modal.style.zIndex='100000'; modal.style.minWidth='320px'; modal.style.display='none';
        modal.innerHTML = `
          <div style="font-weight:700;margin-bottom:8px;">Cloud Sync Settings</div>
          <div style="font-size:13px;margin-bottom:8px;">Gist ID</div>
          <input id="br_gist_input" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0f1113;color:#fff;margin-bottom:8px;">
          <div style="font-size:13px;margin-bottom:8px;">Personal Token (stored locally)</div>
          <input id="br_token_input" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0f1113;color:#fff;margin-bottom:8px;">
          <div style="margin-top:10px;font-size:12px;color:#bbb;">Auto-sync interval (seconds)</div>
          <input id="br_interval_input" type="number" min="10" step="10" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:#0f1113;color:#fff;margin-top:6px;">
          <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="br_save_settings" style="flex:1;padding:8px;background:#2563eb;border:none;color:#fff;border-radius:8px;cursor:pointer;">Save</button>
            <button id="br_close_settings" style="flex:1;padding:8px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;border-radius:8px;cursor:pointer;">Close</button>
          </div>
        `;
        document.body.appendChild(modal);

        btnSettings.onclick = ()=>{
          modal.style.display='block';
          (document.getElementById('br_gist_input')).value = gistId || '';
          (document.getElementById('br_token_input')).value = token ? token.replace(/.(?=.{4})/g, '*') : '';
          (document.getElementById('br_interval_input')).value = (autoIntervalMs/1000).toString();
        };
        document.getElementById('br_close_settings').onclick = ()=> modal.style.display='none';
        document.getElementById('br_save_settings').onclick = ()=>{
          const newGist = (document.getElementById('br_gist_input')).value.trim();
          const newToken = (document.getElementById('br_token_input')).value.trim();
          const newInterval = parseInt((document.getElementById('br_interval_input')).value || '60', 10);
          if (newGist) { gistId = newGist; localStorage.setItem(LS_GIST_KEY, gistId); }
          if (newToken) { token = newToken; localStorage.setItem(LS_TOKEN_KEY, token); }
          autoIntervalMs = (isFinite(newInterval) && newInterval >= 10) ? (newInterval*1000) : DEFAULT_INTERVAL_MS;
          if (autoTimer) { clearInterval(autoTimer); autoTimer = setInterval(autoSyncNow, autoIntervalMs); }
          modal.style.display='none';
          setStatus('Settings saved');
        };

        // history button: fetch gist commits and show simple list
        btnHist.onclick = async ()=>{
          if (!token) { alert('Set token in Settings first'); return; }
          try {
            const commitsUrl = `https://api.github.com/gists/${gistId}/commits`;
            const res = await fetch(commitsUrl, { headers: headers() });
            if (!res.ok) throw new Error('Commits fetch failed: ' + res.status);
            const commits = await res.json();
            const list = commits.map(c => `${new Date(c.version ? Date.parse(c.committed_at) : c.committed_at).toLocaleString()} â€” ${c.version || c.url}`).join('\n');
            alert('Gist history (recent):\n\n' + list);
          } catch(e) { console.warn(e); alert('Failed to fetch history'); }
        };
      }

      function setStatus(text){
        const s = document.getElementById('br-cloud-status'); if (s) s.textContent = text;
      }

      async function downloadAndMerge(){
        setStatus('Sync: pulling...');
        try {
          const cloud = await downloadCloud();
          const local = readLocalAppState();
          if (!cloud && !local) { setStatus('No data found'); return null; }
          if (!cloud && local) {
            await uploadCloud(local);
            setStatus('Bootstrapped cloud from local');
            return local;
          }
          if (cloud && !local) {
            writeLocalAppState(cloud.data);
            // apply to app
            state = cloud.data;
            initConversionState();
            saveState();
            renderAll();
            setStatus('Restored local from cloud');
            return cloud.data;
          }
          // both exist -> merge
          const merged = smartMerge(local, cloud.data);
          writeLocalAppState(merged);
          await uploadCloud(merged);
          state = merged;
          initConversionState();
          saveState();
          renderAll();
          setStatus('Merged local & cloud');
          return merged;
        } catch(e) {
          console.warn(e);
          setStatus('Sync failed');
          throw e;
        }
      }

      async function autoSyncNow(){
        if (!token) { setStatus('No token - open Settings'); return; }
        if (isSyncing) return;
        isSyncing = true; setStatus('Syncing...');
        try {
          // capture snapshot from STORAGE_KEY (app state)
          const snapshot = readLocalAppState();
          if (!snapshot) { setStatus('No local state to upload'); isSyncing=false; return; }
          // upload
          await uploadCloud(snapshot);
          setStatus('Synced: ' + new Date().toLocaleTimeString());
        } catch(e) {
          console.warn(e); setStatus('Sync error');
        } finally { isSyncing = false; }
      }

      function startAuto(){
        if (autoTimer) clearInterval(autoTimer);
        autoTimer = setInterval(autoSyncNow, autoIntervalMs);
        setStatus('Auto-sync every ' + (autoIntervalMs/1000) + 's');
      }
      function stopAuto(){ if (autoTimer) { clearInterval(autoTimer); autoTimer = null; setStatus('Auto-sync stopped'); } }

      // init sequence
      (function init(){
        createUI();
        // ensure gistId saved locally
        localStorage.setItem(LS_GIST_KEY, gistId);
        // prompt for token if not set
        if (!token) {
          // prompt but wrapped so iOS accepts it inside user gesture? we still prompt on load
          try {
            const t = prompt('Enter your GitHub Personal Access Token (gist scope). Will be stored locally on this device only.');
            if (t) { token = t; localStorage.setItem(LS_TOKEN_KEY, token); }
          } catch(e){}
        }
        // try initial download & merge if token present
        if (token) {
          downloadAndMerge().catch(e=> console.warn('initial sync failed', e));
        } else {
          setStatus('Token not set');
        }
        // start auto
        startAuto();
      })();

      // expose for debugging (optional)
      window.brCloudSync = {
        downloadAndMerge,
        autoSyncNow,
        startAuto,
        stopAuto,
        setToken: (t)=>{ token = t; localStorage.setItem(LS_TOKEN_KEY, t); },
        setGistId: (g)=>{ gistId = g; localStorage.setItem(LS_GIST_KEY, g); },
      };

    })();

  </script>
</body>
</html>â€</html>