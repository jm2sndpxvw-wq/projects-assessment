<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projects Assessment â€“ Real Estate Team</title>
  <style>
    :root {
      --bg: #0b0d10;
      --bg-alt: #151921;
      --bg-alt-soft: #1b2029;
      --primary: #4f8cff;
      --primary-soft: #223455;
      --text: #f5f7fb;
      --text-muted: #9aa4c0;
      --danger: #ff4b5c;
      --warning: #ffbf47;
      --success: #28c76f;
      --border: #252c3a;
      --card-radius: 10px;
      --shadow-soft: 0 8px 20px rgba(0,0,0,0.45);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top, #1a2134 0, #05060a 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1280px;
      background: linear-gradient(135deg, #090b10 0, #111623 45%, #090b10 100%);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      display: grid;
      grid-template-columns: 260px 1fr;
      overflow: hidden;
      border: 1px solid rgba(255,255,255,0.04);
    }

    /* Sidebar */

    .sidebar {
      background: radial-gradient(circle at top left, #20263a 0, #070910 55%);
      border-right: 1px solid var(--border);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .app-title {
      font-size: 18px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-title span.logo {
      width: 26px;
      height: 26px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at 30% 0, #7c8cff, #3a4bff, #141633);
      box-shadow: 0 0 18px rgba(79,140,255,0.55);
      font-size: 14px;
    }

    .app-sub {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .team-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .team-header span {
      font-size: 12px;
      color: var(--text-muted);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .team-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 6px;
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .team-item {
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(16,21,34,0.9);
      border: 1px solid transparent;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: 0.18s ease;
      position: relative;
    }

    .team-item.active {
      border-color: var(--primary);
      background: radial-gradient(circle at 0 0, #27345c 0, #131723 48%);
      box-shadow: 0 0 0 1px rgba(79,140,255,0.4);
    }

    .team-item:hover {
      background: #171c29;
    }

    .team-main {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .team-name {
      font-size: 13px;
      font-weight: 600;
    }

    .team-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .team-score-pill {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .pill-red { color: var(--danger); border-color: rgba(255,75,92,0.65); }
    .pill-yellow { color: var(--warning); border-color: rgba(255,191,71,0.7); }
    .pill-green { color: var(--success); border-color: rgba(40,199,111,0.7); }

    .add-team {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .add-team input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(8,10,16,0.9);
      color: var(--text);
      font-size: 12px;
      outline: none;
    }

    .add-team button {
      border-radius: 999px;
      padding: 0 10px;
      font-size: 11px;
      border: none;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: 0.18s ease;
    }

    .add-team button:hover {
      background: #3a70ff;
    }

    .hint-mini {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 8px;
      border-top: 1px dashed rgba(255,255,255,0.07);
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-footer strong {
      color: var(--text);
      font-weight: 600;
    }

    /* Main content */

    .main {
      padding: 18px 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .main-title {
      font-size: 16px;
      font-weight: 600;
    }

    .main-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .main-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .btn {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(8,10,16,0.9);
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: 0.18s ease;
    }

    .btn-primary {
      background: var(--primary);
      border-color: rgba(79,140,255,0.9);
      color: #fff;
    }

    .btn-primary:hover { background: #3a70ff; }
    .btn:hover { background: #171c29; }

    .filters-row {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 11px;
      color: var(--text-muted);
    }

    .filters-row select {
      background: var(--bg-alt);
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 4px 8px;
      font-size: 11px;
      outline: none;
    }

    .chip {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 10px;
    }

    .chip-soft {
      background: rgba(255,255,255,0.02);
      border-style: dashed;
    }

    /* Form + cards layout */

    .content-grid {
      display: grid;
      grid-template-columns: minmax(0, 260px) minmax(0, 1fr);
      gap: 12px;
      margin-top: 6px;
      height: calc(100% - 60px);
      min-height: 0;
    }

    .panel {
      background: var(--bg-alt);
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 10px 10px 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      overflow: hidden;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .panel-title {
      font-size: 12px;
      font-weight: 600;
    }

    .panel-sub {
      font-size: 10px;
      color: var(--text-muted);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      margin-top: 2px;
      max-height: 100%;
      overflow-y: auto;
      padding-right: 2px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .field label {
      font-size: 10px;
      color: var(--text-muted);
    }

    .field input,
    .field textarea {
      background: #0d1017;
      border-radius: 8px;
      border: 1px solid var(--border);
      padding: 5px 7px;
      font-size: 11px;
      color: var(--text);
      outline: none;
    }

    .field input:focus,
    .field textarea:focus {
      border-color: var(--primary);
    }

    .field textarea {
      min-height: 40px;
      resize: vertical;
    }

    .score-input {
      width: 100%;
    }

    .score-input::-webkit-outer-spin-button,
    .score-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    .scores-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 4px 8px;
    }

    .field small {
      font-size: 9px;
      color: var(--text-muted);
    }

    .submit-row {
      display: flex;
      gap: 6px;
      margin-top: 4px;
    }

    .submit-row .btn {
      flex: 1;
      justify-content: center;
    }

    .projects-panel {
      position: relative;
      min-height: 0;
      display: flex;
      flex-direction: column;
    }

    .cards-list {
      margin-top: 4px;
      overflow-y: auto;
      padding-right: 2px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .card {
      background: var(--bg-alt-soft);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 8px 9px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .card:hover {
      border-color: rgba(255,255,255,0.12);
      background: #191f2b;
    }

    .card.reassessed {
      box-shadow: 0 0 0 1px rgba(40,199,111,0.4);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .card-title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .card-title {
      font-size: 12px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 10px;
      color: var(--text-muted);
    }

    .card-tag {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      border: 1px solid var(--border);
    }

    .tag-red { color: var(--danger); border-color: rgba(255,75,92,0.7); }
    .tag-yellow { color: var(--warning); border-color: rgba(255,191,71,0.7); }
    .tag-green { color: var(--success); border-color: rgba(40,199,111,0.7); }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--text-muted);
      flex-wrap: wrap;
    }

    .card-footer span.bold {
      font-weight: 600;
      color: var(--text);
      font-size: 11px;
    }

    .details {
      margin-top: 4px;
      border-top: 1px dashed rgba(255,255,255,0.08);
      padding-top: 4px;
      display: none;
      font-size: 10px;
      color: var(--text-muted);
    }

    .details-row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 3px 10px;
      margin-top: 2px;
    }

    .details-row span {
      display: flex;
      justify-content: space-between;
    }

    .details-row span strong {
      font-weight: 500;
      color: var(--text);
    }

    .card.open .details {
      display: block;
    }

    .training-panel {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-top: 4px;
    }

    .training-list {
      font-size: 10px;
      line-height: 1.4;
      max-height: 70px;
      overflow-y: auto;
      padding-right: 2px;
      margin-top: 2px;
    }

    .training-list div {
      margin-bottom: 2px;
    }

    .training-section-title {
      font-size: 10px;
      margin-top: 4px;
    }

    .empty-state {
      font-size: 11px;
      color: var(--text-muted);
      padding: 12px 4px;
      text-align: center;
    }

    .region-summary {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .region-summary span {
      margin-right: 6px;
    }

    .print-only {
      display: none;
    }

    /* Scrollbar */

    ::-webkit-scrollbar {
      width: 5px;
    }
    ::-webkit-scrollbar-track {
      background: transparent;
    }
    ::-webkit-scrollbar-thumb {
      background: #303545;
      border-radius: 999px;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: 1fr;
      }
      .sidebar {
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: column;
      }
      .content-grid {
        grid-template-columns: 1fr;
        height: auto;
      }
    }

    /* ====== PRINT STYLES ====== */
    @media print {
      body {
        background: #05060a !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      .app,
      .sidebar,
      .main,
      .panel,
      .card,
      .team-item.active,
      .filters-row,
      .training-panel {
        background-color: #111623 !important;
        color: #f5f7fb !important;
      }

      .content-grid {
        grid-template-columns: 1fr !important;
      }

      .content-grid > section:first-child {
        display: none !important;
      }

      /* team member ÙˆØ§Ø­Ø¯ Ø¨Ø³ (Ø§Ù„Ù…Ø®ØªØ§Ø±) */
      .team-item {
        display: none !important;
      }
      .team-item.active {
        display: flex !important;
      }
      .add-team,
      .hint-mini {
        display: none !important;
      }

      /* Ù†Ø³ØªØ®Ø¯Ù… Ù‚Ø§Ø¦Ù…Ø© Ø®Ø§ØµØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© */
      #projectsList {
        display: none !important;
      }
      #printProjectsList {
        display: flex !important;
      }
      #printProjectsList .card {
        cursor: default;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="app-title">
          <span class="logo">BR</span>
          <div>
            Bold Routes â€“ Projects Assessment
            <div class="app-sub">Dark mode â€¢ Compact â€¢ Team based</div>
          </div>
        </div>
      </div>

      <div class="team-header">
        <span>Team members</span>
      </div>
      <div class="team-list" id="teamList"></div>

      <div class="add-team">
        <input id="newMemberInput" placeholder="Add new member..." />
        <button id="addMemberBtn" type="button">Add</button>
      </div>
      <div class="hint-mini">Long press on member name to delete ğŸ—‘ï¸</div>

      <div class="sidebar-footer">
        <div>
          <strong>Color codes (Project):</strong><br />
          ğŸŸ¥ &lt; 60% â€“ Needs training<br />
          ğŸŸ¨ 60â€“79% â€“ Average<br />
          ğŸŸ© â‰¥ 80% â€“ Confident
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="main-header">
        <div class="main-header-left">
          <div class="main-title" id="currentMemberTitle">Select team member</div>
          <div class="main-sub" id="currentMemberSub">
            Choose a team member from the left to start assessment.
          </div>
        </div>
        <div class="main-actions">
          <button class="btn" id="exportBtn" type="button">Export PDF (Current member)</button>
        </div>
      </div>

      <div class="filters-row">
        <span>Region:</span>
        <select id="regionFilter">
          <option value="all">All regions</option>
        </select>
        <span class="chip chip-soft" id="regionStats">No projects yet</span>
      </div>

      <div class="content-grid">
        <!-- LEFT: FORM -->
        <section class="panel">
          <div class="panel-header">
            <div>
              <div class="panel-title" id="formTitle">New Project Assessment</div>
              <div class="panel-sub">Rate each point from 0 to 10 (English labels)</div>
            </div>
          </div>

          <div class="form-grid">
            <div class="field">
              <label>Project name</label>
              <input id="projectName" placeholder="e.g. New Zayed Lakes" />
            </div>

            <div class="field">
              <label>Region / Area</label>
              <input id="projectRegion" placeholder="e.g. New Zayed, NAC..." />
            </div>

            <div class="scores-grid">
              <div class="field">
                <label>Development</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreDevelopment" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Location</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreLocation" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Masterplan</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreMasterplan" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Facilities</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreFacilities" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Type mix</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreType" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Price positioning</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scorePrice" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Payment plan</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scorePayment" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Delivery date</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreDelivery" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Finishing quality</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreFinishing" placeholder="0â€“10" />
              </div>
              <div class="field">
                <label>Maintenance (deposit)</label>
                <input type="number" min="0" max="10" step="0.5"
                       class="score-input" id="scoreMaintenance" placeholder="0â€“10" />
              </div>
            </div>

            <div class="field">
              <label>Notes (optional)</label>
              <textarea id="projectNotes"
                        placeholder="Any remarks, red flags, comparison with competitors..."></textarea>
            </div>

            <div class="submit-row">
              <button class="btn btn-primary" id="addProjectBtn" type="button">
                Save project
              </button>
              <button class="btn" id="cancelEditBtn" type="button">
                Cancel edit
              </button>
            </div>
          </div>
        </section>

        <!-- RIGHT: CARDS + TRAINING -->
        <section class="panel projects-panel">
          <div class="panel-header">
            <div>
              <div class="panel-title">Projects & Scores</div>
              <div class="panel-sub">
                Click on a card to expand details â€“ filtered by region.
              </div>
            </div>
          </div>

          <!-- Normal list (screen) -->
          <div class="cards-list" id="projectsList">
            <div class="empty-state">No projects yet. Add a new assessment on the left.</div>
          </div>

          <!-- Print-only list (â‰¤60% & max 5) -->
          <div class="cards-list print-only" id="printProjectsList"></div>

          <div class="training-panel">
            <div class="training-section-title">
              <strong>Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ â€“ Ù„ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ (Ø¯Ø±Ø¬Ø§Øª Ø£Ù‚Ù„ Ù…Ù† 7):</strong>
            </div>
            <div class="training-list" id="trainingListPerProject">
              Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.
            </div>

            <div class="training-section-title">
              <strong>Ù†Ù‚Ø§Ø· Ø¶Ø¹ÙŠÙØ© Ù…ØªÙƒØ±Ø±Ø© (â‰¤ 5/10) Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹:</strong>
            </div>
            <div class="training-list" id="trainingListGlobal">
              Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "br_assessment_v3";

    let state = {
      members: [],
      selectedMemberId: null
    };

    let editingProjectId = null;

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          state = JSON.parse(raw);
        } catch (e) {
          console.error("Failed to parse state", e);
        }
      }
      if (!state.members) state.members = [];
      if (!state.selectedMemberId && state.members.length > 0) {
        // Ø£ÙˆÙ„ Ù…Ø±Ø©: Ø®Ù„ÙŠÙ‡ ÙŠØ¨Ø¯Ø£ Ø¨Ù€ All team
        state.selectedMemberId = "all-team";
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function uid() {
      return Date.now().toString(36) + Math.random().toString(16).slice(2);
    }

    function isAllTeamSelected() {
      return state.selectedMemberId === "all-team";
    }

    // Elements
    const teamListEl = document.getElementById("teamList");
    const newMemberInput = document.getElementById("newMemberInput");
    const addMemberBtn = document.getElementById("addMemberBtn");
    const currentMemberTitle = document.getElementById("currentMemberTitle");
    const currentMemberSub = document.getElementById("currentMemberSub");
    const regionFilter = document.getElementById("regionFilter");
    const regionStats = document.getElementById("regionStats");
    const projectsListEl = document.getElementById("projectsList");
    const printProjectsListEl = document.getElementById("printProjectsList");
    const trainingListPerProjectEl = document.getElementById("trainingListPerProject");
    const trainingListGlobalEl = document.getElementById("trainingListGlobal");
    const exportBtn = document.getElementById("exportBtn");

    const projectNameEl = document.getElementById("projectName");
    const projectRegionEl = document.getElementById("projectRegion");
    const projectNotesEl = document.getElementById("projectNotes");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const formTitleEl = document.getElementById("formTitle");
    const defaultFormTitle = formTitleEl.textContent;

    const scoreIds = [
      "scoreDevelopment",
      "scoreLocation",
      "scoreMasterplan",
      "scoreFacilities",
      "scoreType",
      "scorePrice",
      "scorePayment",
      "scoreDelivery",
      "scoreFinishing",
      "scoreMaintenance"
    ];

    function labelForKey(key) {
      switch (key) {
        case "development": return "Development";
        case "location": return "Location";
        case "masterplan": return "Masterplan";
        case "facilities": return "Facilities";
        case "type": return "Type mix";
        case "price": return "Price positioning";
        case "payment": return "Payment plan";
        case "delivery": return "Delivery date";
        case "finishing": return "Finishing";
        case "maintenance": return "Maintenance";
        default: return key;
      }
    }

    function getCurrentMemberOrAll() {
      if (isAllTeamSelected()) {
        const allProjects = [];
        state.members.forEach(m => {
          (m.projects || []).forEach(p => {
            allProjects.push({
              ...p,
              memberId: m.id,
              memberName: m.name
            });
          });
        });
        return {
          id: "all-team",
          name: "All team",
          projects: allProjects
        };
      }
      return state.members.find(m => m.id === state.selectedMemberId) || null;
    }

    // Compute average
    function computeAverageForProjects(projects) {
      if (!projects || projects.length === 0) return 0;
      let sum = 0;
      projects.forEach(p => {
        sum += p.overallPercent || 0;
      });
      return sum / projects.length;
    }

    function computeMemberAverage(member) {
      const projects = member?.projects || [];
      return computeAverageForProjects(projects);
    }

    function computeAllTeamStats() {
      const allProjects = [];
      state.members.forEach(m => {
        (m.projects || []).forEach(p => allProjects.push(p));
      });
      return {
        count: allProjects.length,
        avg: computeAverageForProjects(allProjects)
      };
    }

    // Render team
    function renderTeamList() {
      teamListEl.innerHTML = "";
      if (state.members.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "Add your team members to start.";
        teamListEl.appendChild(div);
        currentMemberTitle.textContent = "Select team member";
        currentMemberSub.textContent =
          "Choose a team member from the left to start assessment.";
        return;
      }

      // All team row
      const allStats = computeAllTeamStats();
      const allItem = document.createElement("div");
      allItem.className =
        "team-item" + (isAllTeamSelected() ? " active" : "");
      allItem.dataset.id = "all-team";

      const allMain = document.createElement("div");
      allMain.className = "team-main";

      const allNameEl = document.createElement("div");
      allNameEl.className = "team-name";
      allNameEl.textContent = "All team";

      const allMetaEl = document.createElement("div");
      allMetaEl.className = "team-meta";
      allMetaEl.textContent =
        allStats.count + " project" + (allStats.count !== 1 ? "s" : "");

      allMain.appendChild(allNameEl);
      allMain.appendChild(allMetaEl);

      const allPill = document.createElement("div");
      allPill.className = "team-score-pill";
      if (allStats.count === 0) {
        allPill.textContent = "No score";
        allPill.classList.add("pill-yellow");
      } else {
        allPill.textContent = `${allStats.avg.toFixed(0)}%`;
        if (allStats.avg < 60) allPill.classList.add("pill-red");
        else if (allStats.avg < 80) allPill.classList.add("pill-yellow");
        else allPill.classList.add("pill-green");
      }

      allItem.appendChild(allMain);
      allItem.appendChild(allPill);

      allItem.addEventListener("click", () => {
        state.selectedMemberId = "all-team";
        saveState();
        renderAll();
      });

      teamListEl.appendChild(allItem);

      // Normal members
      state.members.forEach(member => {
        const item = document.createElement("div");
        item.className =
          "team-item" +
          (member.id === state.selectedMemberId ? " active" : "");
        item.dataset.id = member.id;

        const main = document.createElement("div");
        main.className = "team-main";

        const nameEl = document.createElement("div");
        nameEl.className = "team-name";
        nameEl.textContent = member.name;

        const metaEl = document.createElement("div");
        metaEl.className = "team-meta";
        const projectsCount = member.projects?.length || 0;
        metaEl.textContent =
          projectsCount + " project" + (projectsCount !== 1 ? "s" : "");

        main.appendChild(nameEl);
        main.appendChild(metaEl);

        const pill = document.createElement("div");
        pill.className = "team-score-pill";
        const avg = computeMemberAverage(member);
        if (projectsCount === 0) {
          pill.textContent = "No score";
          pill.classList.add("pill-yellow");
        } else {
          pill.textContent = `${avg.toFixed(0)}%`;
          if (avg < 60) pill.classList.add("pill-red");
          else if (avg < 80) pill.classList.add("pill-yellow");
          else pill.classList.add("pill-green");
        }

        item.appendChild(main);
        item.appendChild(pill);

        // Long press delete (mouse + touch)
        let pressTimer = null;
        let longPressed = false;

        item.addEventListener("pointerdown", () => {
          longPressed = false;
          pressTimer = setTimeout(() => {
            const ok = confirm(
              `ØªÙ…Ø³Ø­ ${member.name} ÙˆÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨ØªØ§Ø¹ØªÙ‡ØŸ`
            );
            if (ok) {
              longPressed = true;
              state.members = state.members.filter(m => m.id !== member.id);
              if (state.selectedMemberId === member.id) {
                state.selectedMemberId = "all-team";
              }
              saveState();
              renderAll();
            } else {
              longPressed = false;
            }
          }, 650);
        });

        ["pointerup", "pointerleave", "pointercancel"].forEach(ev => {
          item.addEventListener(ev, () => {
            if (pressTimer) {
              clearTimeout(pressTimer);
              pressTimer = null;
            }
          });
        });

        // Normal click = select member
        item.addEventListener("click", () => {
          if (longPressed) return;
          state.selectedMemberId = member.id;
          saveState();
          renderAll();
        });

        teamListEl.appendChild(item);
      });
    }

    // Region filter + stats
    function renderRegionFilterAndStats(member) {
      const projects = member?.projects || [];
      const regions = Array.from(
        new Set(
          projects
            .map(p => (p.region || "").trim())
            .filter(Boolean)
        )
      );

      const currentValue = regionFilter.value || "all";
      regionFilter.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "All regions";
      regionFilter.appendChild(allOpt);

      regions.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        regionFilter.appendChild(opt);
      });

      if (!regions.includes(currentValue) && currentValue !== "all") {
        regionFilter.value = "all";
      } else {
        regionFilter.value = currentValue;
      }

      if (projects.length === 0) {
        regionStats.textContent = "No projects yet";
        return;
      }

      const selectedRegion = regionFilter.value;
      if (selectedRegion === "all") {
        const avg = computeAverageForProjects(projects);
        regionStats.textContent = `Overall: ${avg.toFixed(
          1
        )}% for ${projects.length} project(s)`;
      } else {
        const filtered = projects.filter(
          p => (p.region || "").trim() === selectedRegion
        );
        if (filtered.length === 0) {
          regionStats.textContent = `No projects yet in ${selectedRegion}`;
        } else {
          const avg = computeAverageForProjects(filtered);
          regionStats.textContent = `${selectedRegion}: ${avg.toFixed(
            1
          )}% over ${filtered.length} project(s)`;
        }
      }
    }

    function tagFromPercent(percent) {
      if (percent < 60)
        return { text: "Needs Training", className: "tag-red" };
      if (percent < 80)
        return { text: "Average", className: "tag-yellow" };
      return { text: "Confident", className: "tag-green" };
    }

    // Load project into form for editing
    function startEditProject(project) {
      editingProjectId = project.id;
      formTitleEl.textContent = `Editing: ${project.name || "project"}`;
      projectNameEl.value = project.name || "";
      projectRegionEl.value = project.region || "";
      projectNotesEl.value = project.notes || "";

      const s = project.scores || {};
      document.getElementById("scoreDevelopment").value =
        typeof s.development === "number" ? s.development : "";
      document.getElementById("scoreLocation").value =
        typeof s.location === "number" ? s.location : "";
      document.getElementById("scoreMasterplan").value =
        typeof s.masterplan === "number" ? s.masterplan : "";
      document.getElementById("scoreFacilities").value =
        typeof s.facilities === "number" ? s.facilities : "";
      document.getElementById("scoreType").value =
        typeof s.type === "number" ? s.type : "";
      document.getElementById("scorePrice").value =
        typeof s.price === "number" ? s.price : "";
      document.getElementById("scorePayment").value =
        typeof s.payment === "number" ? s.payment : "";
      document.getElementById("scoreDelivery").value =
        typeof s.delivery === "number" ? s.delivery : "";
      document.getElementById("scoreFinishing").value =
        typeof s.finishing === "number" ? s.finishing : "";
      document.getElementById("scoreMaintenance").value =
        typeof s.maintenance === "number" ? s.maintenance : "";
    }

    // Render projects + training
    function renderProjectsList(member) {
      projectsListEl.innerHTML = "";
      if (!member || !member.projects || member.projects.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent =
          "No projects yet. Add a new assessment on the left.";
        projectsListEl.appendChild(div);
        trainingListPerProjectEl.textContent = "Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.";
        trainingListGlobalEl.textContent = "Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.";
        return;
      }

      const selectedRegion = regionFilter.value || "all";
      const projects = member.projects.filter(p =>
        selectedRegion === "all"
          ? true
          : (p.region || "").trim() === selectedRegion
      );

      if (projects.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "No projects in this region yet.";
        projectsListEl.appendChild(div);
      } else {
        projects
          .slice()
          .sort((a, b) => b.createdAt - a.createdAt)
          .forEach(project => {
            const card = document.createElement("div");
            card.className = "card";
            card.dataset.id = project.id;

            if (typeof project.lastDelta === "number") {
              card.classList.add("reassessed");
            }

            const header = document.createElement("div");
            header.className = "card-header";

            const titleBlock = document.createElement("div");
            titleBlock.className = "card-title-block";

            const title = document.createElement("div");
            title.className = "card-title";
            title.textContent = project.name || "Untitled project";

            const subtitle = document.createElement("div");
            subtitle.className = "card-subtitle";

            const percentText = `${project.overallPercent.toFixed(1)}%`;
            if (project.memberName && project.region) {
              subtitle.textContent = `${project.memberName} â€¢ ${project.region} â€¢ ${percentText}`;
            } else if (project.memberName) {
              subtitle.textContent = `${project.memberName} â€¢ ${percentText}`;
            } else if (project.region) {
              subtitle.textContent = `${project.region} â€¢ ${percentText}`;
            } else {
              subtitle.textContent = percentText;
            }

            titleBlock.appendChild(title);
            titleBlock.appendChild(subtitle);

            const tagEl = document.createElement("div");
            const tagInfo = tagFromPercent(project.overallPercent);
            tagEl.className = "card-tag " + tagInfo.className;
            tagEl.textContent = tagInfo.text;

            header.appendChild(titleBlock);
            header.appendChild(tagEl);

            const footer = document.createElement("div");
            footer.className = "card-footer";

            const created = document.createElement("span");
            const date = new Date(project.createdAt || Date.now());
            created.textContent = `Added: ${date.toLocaleDateString()}`;

            const scoreSpan = document.createElement("span");
            scoreSpan.innerHTML = `<span class="bold">${project.overallPercent.toFixed(
              1
            )}%</span> avg (0â€“10 scale)`;

            footer.appendChild(created);
            footer.appendChild(scoreSpan);

            // Reassessment trend (if exists)
            if (typeof project.lastDelta === "number") {
              const trend = document.createElement("span");
              const diff = project.lastDelta;
              if (diff > 0) {
                trend.textContent = `Reassessment: Improved +${diff.toFixed(
                  1
                )} pts`;
                trend.style.color = "#28c76f";
              } else if (diff < 0) {
                trend.textContent = `Reassessment: Dropped ${diff.toFixed(
                  1
                )} pts`;
                trend.style.color = "#ff4b5c";
              } else {
                trend.textContent = "Reassessment: No change";
                trend.style.color = "#9aa4c0";
              }
              footer.appendChild(trend);
            }

            const details = document.createElement("div");
            details.className = "details";

            const rows = document.createElement("div");
            rows.className = "details-row";

            const s = project.scores || {};
            const mapping = [
              ["Development", s.development],
              ["Location", s.location],
              ["Masterplan", s.masterplan],
              ["Facilities", s.facilities],
              ["Type mix", s.type],
              ["Price position", s.price],
              ["Payment plan", s.payment],
              ["Delivery", s.delivery],
              ["Finishing", s.finishing],
              ["Maintenance", s.maintenance]
            ];

            mapping.forEach(([label, value]) => {
              const span = document.createElement("span");
              const v =
                typeof value === "number" ? value.toFixed(1) : "-";
              span.innerHTML = `<strong>${label}</strong><span>${v}/10</span>`;
              rows.appendChild(span);
            });

            details.appendChild(rows);

            if (project.notes && project.notes.trim()) {
              const note = document.createElement("div");
                note.style.marginTop = "4px";
              note.textContent = `Notes: ${project.notes}`;
              details.appendChild(note);
            }

            card.appendChild(header);
            card.appendChild(details);
            card.appendChild(footer);

            // Long press delete for project card
            let pressTimer = null;
            let longPressed = false;

            card.addEventListener("pointerdown", () => {
              longPressed = false;
              pressTimer = setTimeout(() => {
                const ok = confirm(
                  `ØªÙ…Ø³Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ "${project.name}" Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ`
                );
                if (ok) {
                  longPressed = true;
                  // Ù„Ùˆ All teamØŒ Ù†Ù…Ø³Ø­ Ù…Ù† Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø£ØµÙ„ÙŠ
                  if (project.memberId) {
                    const owner = state.members.find(m => m.id === project.memberId);
                    if (owner && owner.projects) {
                      owner.projects = owner.projects.filter(p => p.id !== project.id);
                    }
                  } else {
                    member.projects = member.projects.filter(
                      p => p.id !== project.id
                    );
                  }
                  saveState();
                  renderAll();
                } else {
                  longPressed = false;
                }
              }, 650);
            });

            ["pointerup", "pointerleave", "pointercancel"].forEach(ev => {
              card.addEventListener(ev, () => {
                if (pressTimer) {
                  clearTimeout(pressTimer);
                  pressTimer = null;
                }
              });
            });

            // Click: toggle + load into form for editing (Ù„Ùˆ Ù…Ø´ All team)
            card.addEventListener("click", () => {
              if (longPressed) return;
              card.classList.toggle("open");
              // ÙÙŠ All team Ù…ÙÙŠØ´ edit Ù…Ù† Ù‡Ù†Ø§ Ø¹Ø´Ø§Ù† Ù…Ø´ Ø¹Ø§ÙŠØ²ÙŠÙ† ØªÙ„Ø®Ø¨ÙŠØ·
              if (!isAllTeamSelected()) {
                startEditProject(project);
              }
            });

            projectsListEl.appendChild(card);
          });
      }

      buildTraining(member);
    }

    function buildTraining(member) {
      const projects = member?.projects || [];

      if (projects.length === 0) {
        trainingListPerProjectEl.textContent = "Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.";
        trainingListGlobalEl.textContent = "Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.";
        return;
      }

      // Ø¬Ø²Ø¡ 1: ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹ ÙˆØ§Ù„Ù†Ù‚Ø· Ø£Ù‚Ù„ Ù…Ù† 7
      const perProjectLines = [];

      // Ø¬Ø²Ø¡ 2: Ù†Ù‚Ø§Ø· â‰¤ 5 Ø¹Ù„Ù‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
      const globalWeakMap = {}; // key -> { label, count }

      projects.forEach(project => {
        const s = project.scores || {};
        const weakPoints = [];

        Object.entries(s).forEach(([key, value]) => {
          if (typeof value !== "number") return;
          const label = labelForKey(key);

          // Ø¶Ø¹ÙŠÙ ÙÙŠ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¯Ù‡ Ù„Ùˆ Ø£Ù‚Ù„ Ù…Ù† 7
          if (value < 7) {
            weakPoints.push(label);
          }

          // Ø¶Ø¹ÙŠÙ Ø¬Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ù„Ùˆ â‰¤ 5
          if (value <= 5) {
            if (!globalWeakMap[key]) {
              globalWeakMap[key] = { label, count: 0 };
            }
            globalWeakMap[key].count += 1;
          }
        });

        if (weakPoints.length > 0) {
          const prefix =
            member.id === "all-team" && project.memberName
              ? `${project.memberName} â€“ `
              : "";
          perProjectLines.push(
            `${prefix}${project.name}: Ù…Ø­ØªØ§Ø¬ ÙŠØ²ÙˆØ¯ Ù…Ø°Ø§ÙƒØ±ØªÙ‡ ÙÙŠ [${weakPoints.join("ØŒ ")}]`
          );
        }
      });

      // Ø¹Ø±Ø¶ Ø¬Ø²Ø¡ 1
      if (perProjectLines.length === 0) {
        trainingListPerProjectEl.textContent =
          "Ù…ÙÙŠØ´ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù ÙˆØ§Ø¶Ø­Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ Ø´ØºÙ„ ÙƒÙˆÙŠØ³ ğŸ‘Œ";
      } else {
        trainingListPerProjectEl.innerHTML = "";
        perProjectLines.forEach(text => {
          const div = document.createElement("div");
          div.textContent = text;
          trainingListPerProjectEl.appendChild(div);
        });
      }

      // Ø¹Ø±Ø¶ Ø¬Ø²Ø¡ 2
      const globalEntries = Object.values(globalWeakMap);

      if (globalEntries.length === 0) {
        trainingListGlobalEl.textContent =
          "Ù…ÙÙŠØ´ Ù†Ù‚Ø§Ø· Ù…ØªÙƒØ±Ø±Ø© Ø£Ù‚Ù„ Ù…Ù† 5/10 Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ğŸ‘Œ";
      } else {
        trainingListGlobalEl.innerHTML = "";
        // Ø±ØªØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ù‹Ø§
        globalEntries
          .sort((a, b) => b.count - a.count)
          .forEach(item => {
            const div = document.createElement("div");
            div.textContent = `${item.label}: Ø£Ù‚Ù„ Ù…Ù† 5/10 ÙÙŠ ${item.count} Ù…Ø´Ø±ÙˆØ¹`;
            trainingListGlobalEl.appendChild(div);
          });
      }
    }

    function renderHeaderForMember(member) {
      if (!member) {
        currentMemberTitle.textContent = "Select team member";
        currentMemberSub.textContent =
          "Choose a team member from the left to start assessment.";
        return;
      }

      if (member.id === "all-team") {
        const avg = computeAverageForProjects(member.projects);
        currentMemberTitle.textContent = "All team";
        currentMemberSub.textContent = `Team overall average: ${avg.toFixed(
          1
        )}% â€“ ${member.projects.length} project(s) evaluated.`;
      } else {
        currentMemberTitle.textContent = member.name;
        const avg = computeMemberAverage(member);
        currentMemberSub.textContent = `Overall average: ${avg.toFixed(
          1
        )}% â€“ ${member.projects.length} project(s) evaluated.`;
      }
    }

    function clearForm() {
      projectNameEl.value = "";
      projectRegionEl.value = "";
      projectNotesEl.value = "";
      scoreIds.forEach(id => {
        const el = document.getElementById(id);
        el.value = "";
      });
      editingProjectId = null;
      formTitleEl.textContent = defaultFormTitle;
    }

    // Add member
    addMemberBtn.addEventListener("click", () => {
      const name = newMemberInput.value.trim();
      if (!name) return;
      const member = {
        id: uid(),
        name,
        projects: []
      };
      state.members.push(member);
      if (!state.selectedMemberId) {
        state.selectedMemberId = member.id;
      }
      newMemberInput.value = "";
      saveState();
      renderAll();
    });

    newMemberInput.addEventListener("keydown", e => {
      if (e.key === "Enter") addMemberBtn.click();
    });

    // Add / update project
    addProjectBtn.addEventListener("click", () => {
      const baseMember = state.members.find(m => m.id === state.selectedMemberId);
      const member = baseMember || state.members[0];

      if (!member) {
        alert("Add a team member first.");
        return;
      }
      const name = projectNameEl.value.trim();
      const region = projectRegionEl.value.trim();
      if (!name) {
        alert("Please enter project name.");
        return;
      }

      const scores = {};
      let sum = 0;
      let count = 0;

      function parseScore(id, keyName) {
        const el = document.getElementById(id);
        const v = parseFloat(el.value);
        const value = isNaN(v) ? 0 : Math.min(Math.max(v, 0), 10);
        scores[keyName] = value;
        sum += value;
        count += 1;
      }

      parseScore("scoreDevelopment", "development");
      parseScore("scoreLocation", "location");
      parseScore("scoreMasterplan", "masterplan");
      parseScore("scoreFacilities", "facilities");
      parseScore("scoreType", "type");
      parseScore("scorePrice", "price");
      parseScore("scorePayment", "payment");
      parseScore("scoreDelivery", "delivery");
      parseScore("scoreFinishing", "finishing");
      parseScore("scoreMaintenance", "maintenance");

      const avgScoreOutOf10 = count > 0 ? sum / count : 0;
      const overallPercent = (avgScoreOutOf10 / 10) * 100;

      let isEdit = false;

      if (editingProjectId && !isAllTeamSelected()) {
        const existing = member.projects.find(
          p => p.id === editingProjectId
        );
        if (existing) {
          isEdit = true;
          const oldOverall = existing.overallPercent || 0;
          existing.name = name;
          existing.region = region;
          existing.scores = scores;
          existing.notes = projectNotesEl.value.trim();
          existing.lastReassessedAt = Date.now();
          existing.lastDelta = overallPercent - oldOverall;
          existing.overallPercent = overallPercent;
        }
      }

      if (!isEdit) {
        const project = {
          id: uid(),
          name,
          region,
          scores,
          notes: projectNotesEl.value.trim(),
          overallPercent,
          createdAt: Date.now()
        };
        member.projects.push(project);
      }

      saveState();
      clearForm();
      renderAll();
    });

    // Cancel edit
    cancelEditBtn.addEventListener("click", () => {
      clearForm();
    });

    // Region filter change
    regionFilter.addEventListener("change", () => {
      const member = getCurrentMemberOrAll();
      renderRegionFilterAndStats(member);
      renderProjectsList(member);
    });

    // Export as PDF (print) â€“ only first 5 projects <= 60%
    exportBtn.addEventListener("click", () => {
      const member = getCurrentMemberOrAll();
      if (!member) {
        alert("Select a team member first.");
        return;
      }

      const selectedRegion = regionFilter.value || "all";
      let projects = member.projects || [];

      if (selectedRegion !== "all") {
        projects = projects.filter(
          p => (p.region || "").trim() === selectedRegion
        );
      }

      // ÙÙ„ØªØ± Ø§Ù„Ù„ÙŠ 60% Ø£Ùˆ Ø£Ù‚Ù„ Ø¨Ø³
      const lowProjects = projects
        .filter(p => (p.overallPercent || 0) <= 60)
        .sort((a, b) => a.overallPercent - b.overallPercent); // Ù…Ù† Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø£Ø¹Ù„Ù‰

      const limited = lowProjects.slice(0, 5);

      printProjectsListEl.innerHTML = "";

      if (limited.length === 0) {
        const div = document.createElement("div");
        div.className = "empty-state";
        div.textContent = "No projects â‰¤ 60% in this region.";
        printProjectsListEl.appendChild(div);
      } else {
        limited.forEach(project => {
          const card = document.createElement("div");
          card.className = "card";

          const header = document.createElement("div");
          header.className = "card-header";

          const titleBlock = document.createElement("div");
          titleBlock.className = "card-title-block";

          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = project.name || "Untitled project";

          const subtitle = document.createElement("div");
          subtitle.className = "card-subtitle";

          const percentText = `${project.overallPercent.toFixed(1)}%`;
          if (project.memberName && project.region) {
            subtitle.textContent = `${project.memberName} â€¢ ${project.region} â€¢ ${percentText}`;
          } else if (project.memberName) {
            subtitle.textContent = `${project.memberName} â€¢ ${percentText}`;
          } else if (project.region) {
            subtitle.textContent = `${project.region} â€¢ ${percentText}`;
          } else {
            subtitle.textContent = percentText;
          }

          titleBlock.appendChild(title);
          titleBlock.appendChild(subtitle);

          const tagEl = document.createElement("div");
          const tagInfo = tagFromPercent(project.overallPercent);
          tagEl.className = "card-tag " + tagInfo.className;
          tagEl.textContent = tagInfo.text;

          header.appendChild(titleBlock);
          header.appendChild(tagEl);

          const footer = document.createElement("div");
          footer.className = "card-footer";

          const scoreSpan = document.createElement("span");
          scoreSpan.innerHTML = `<span class="bold">${project.overallPercent.toFixed(
            1
          )}%</span> avg (0â€“10 scale)`;

          footer.appendChild(scoreSpan);

          card.appendChild(header);
          card.appendChild(footer);

          printProjectsListEl.appendChild(card);
        });
      }

      window.print();
    });

    function renderAll() {
      renderTeamList();
      const member = getCurrentMemberOrAll();
      renderHeaderForMember(member);
      renderRegionFilterAndStats(member);
      renderProjectsList(member);
    }

    loadState();
    renderAll();
  </script>
</body>
</html>