<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>Projects Assessment ‚Äì Real Estate Team</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0d10;--bg-alt:#151921;--bg-alt-soft:#1b2029;--primary:#4f8cff;--text:#f5f7fb;--text-muted:#9aa4c0;--border:#252c3a;--danger:#ff4b5c;--warning:#ffbf47;--success:#28c76f;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif}
    body{background:radial-gradient(circle at top,#1a2134 0,#05060a 55%);color:var(--text);min-height:100vh;display:flex;justify-content:center;padding:16px}
    .app{width:100%;max-width:1280px;background:linear-gradient(135deg,#090b10 0,#111623 45%,#090b10 100%);border-radius:18px;box-shadow:0 8px 20px rgba(0,0,0,.45);display:grid;grid-template-columns:260px 1fr;overflow:hidden;border:1px solid rgba(255,255,255,0.04)}
    /* sidebar */
    .sidebar{background:radial-gradient(circle at top left,#20263a 0,#070910 55%);border-right:1px solid var(--border);padding:18px 16px;display:flex;flex-direction:column;gap:16px}
    .app-title{font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}
    .app-title .logo{width:26px;height:26px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:radial-gradient(circle at 30% 0,#7c8cff,#3a4bff,#141633);box-shadow:0 0 18px rgba(79,140,255,.55);font-size:14px}
    .app-sub{font-size:11px;color:var(--text-muted);margin-top:4px}
    .team-header{display:flex;align-items:center;justify-content:space-between;margin-top:6px;margin-bottom:4px}
    .team-header span{font-size:12px;color:var(--text-muted);letter-spacing:.03em;text-transform:uppercase}
    .team-list{display:flex;flex-direction:column;gap:6px;margin-bottom:6px;max-height:420px;overflow-y:auto;padding-right:4px}
    .team-item{border-radius:10px;padding:8px 10px;background:rgba(16,21,34,.9);border:1px solid transparent;display:flex;justify-content:space-between;align-items:center;cursor:pointer;transition:.18s;position:relative}
    .team-item.active{border-color:var(--primary);background:radial-gradient(circle at 0 0,#27345c 0,#131723 48%);box-shadow:0 0 0 1px rgba(79,140,255,.4)}
    .team-main{display:flex;flex-direction:column;gap:3px}
    .team-name{font-size:13px;font-weight:600}
    .team-meta{font-size:11px;color:var(--text-muted)}
    .team-score-pill{padding:3px 8px;border-radius:999px;font-size:10px;font-weight:600;letter-spacing:.04em;text-transform:uppercase;border:1px solid rgba(255,255,255,.08)}
    .pill-red{color:var(--danger);border-color:rgba(255,75,92,.65)}
    .pill-yellow{color:var(--warning);border-color:rgba(255,191,71,.7)}
    .pill-green{color:var(--success);border-color:rgba(40,199,111,.7)}
    /* sidebar hide pills visually ‚Äî keep data elsewhere */
    .sidebar .team-score-pill{display:none!important}

    .add-team{display:flex;gap:6px;margin-top:4px}
    .add-team input{flex:1;padding:6px 8px;border-radius:999px;border:1px solid var(--border);background:rgba(8,10,16,.9);color:var(--text);font-size:12px;outline:none}
    .add-team button{border-radius:999px;padding:0 10px;font-size:11px;border:none;background:var(--primary);color:#fff;cursor:pointer}
    .hint-mini{font-size:10px;color:var(--text-muted);margin-top:2px}
    .sidebar-footer{margin-top:auto;padding-top:8px;border-top:1px dashed rgba(255,255,255,.07);font-size:11px;color:var(--text-muted);display:flex;flex-direction:column;gap:4px}
    /* main */
    .main{padding:18px 18px 18px 16px;display:flex;flex-direction:column;gap:10px}
    .main-header{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .main-title{font-size:16px;font-weight:600}
    .main-sub{font-size:11px;color:var(--text-muted)}
    .main-actions{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .btn{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(8,10,16,.9);color:var(--text);font-size:11px;cursor:pointer;display:inline-flex;align-items:center;gap:4px}
    .btn-primary{background:var(--primary);border-color:rgba(79,140,255,.9);color:#fff}
    .tabs-row{display:flex;gap:6px;font-size:11px}
    .tab-btn{padding:5px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(8,10,16,.9);color:var(--text-muted);cursor:pointer}
    .tab-btn.active{background:var(--primary);color:#fff;border-color:rgba(79,140,255,.9)}
    .hidden{display:none!important}
    .filters-row{display:flex;gap:8px;align-items:center;font-size:11px;color:var(--text-muted);margin-top:6px}
    .content-grid{display:grid;grid-template-columns:minmax(0,280px) minmax(0,1fr);gap:12px;margin-top:6px;height:calc(100% - 60px);min-height:0}
    .panel{background:var(--bg-alt);border-radius:14px;border:1px solid var(--border);padding:10px 10px 12px;display:flex;flex-direction:column;gap:8px;overflow:hidden}
    .panel-header{display:flex;justify-content:space-between;align-items:center;gap:6px}
    .panel-title{font-size:12px;font-weight:600}
    .panel-sub{font-size:10px;color:var(--text-muted)}
    .form-grid{display:grid;grid-template-columns:1fr;gap:6px;margin-top:2px;max-height:100%;overflow-y:auto;padding-right:2px}
    .field label{font-size:10px;color:var(--text-muted)}
    .score-input{width:100%}
    .projects-panel{position:relative;min-height:0;display:flex;flex-direction:column}
    .cards-list{margin-top:4px;overflow-y:auto;padding-right:2px;display:flex;flex-direction:column;gap:6px}
    .card{background:var(--bg-alt-soft);border-radius:12px;border:1px solid var(--border);padding:8px 9px;display:flex;flex-direction:column;gap:6px;cursor:pointer}
    .card-tag{padding:3px 8px;border-radius:999px;font-size:10px}
    .empty-state{font-size:11px;color:var(--text-muted);padding:12px 4px;text-align:center}
    .conversion-layout{display:grid;grid-template-columns:minmax(0,260px) minmax(0,1fr);gap:12px;margin-top:6px}
    .conversion-table{width:100%;border-collapse:collapse;font-size:10px}
    .conversion-table th,.conversion-table td{border:1px solid var(--border);padding:4px 5px;text-align:center}
    .conversion-table th{font-size:10px;background:#151a25}
    .sales-name-cell{text-align:left;font-weight:600;font-size:11px}
    .percent-chip{font-size:9px;margin-top:2px;display:inline-block}
    .sales-total-row td{background:#101521;font-weight:600}
    .overview-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-top:8px}
    .member-card{background:var(--bg-alt-soft);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
    /* small helper - hide the small sub header in print by default as well */
    @media print{
      #currentMemberSub{display:none!important}
    }
    /* responsive */
    @media (max-width:900px){.app{grid-template-columns:1fr}.sidebar{border-right:none;border-bottom:1px solid var(--border);flex-direction:column}.content-grid,.conversion-layout{grid-template-columns:1fr;height:auto}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="app-title">
        <span class="logo">BR</span>
        <div>
          Bold Routes ‚Äì Projects Assessment
          <div class="app-sub">Dark mode ‚Ä¢ Compact ‚Ä¢ Team based</div>
        </div>
      </div>

      <div class="team-header"><span>Team members</span></div>
      <div class="team-list" id="teamList"></div>

      <div class="add-team">
        <input id="newMemberInput" placeholder="Add new member..." />
        <button id="addMemberBtn" type="button">Add</button>
      </div>
      <div class="hint-mini">Long press on member name to delete üóëÔ∏è</div>

      <div class="sidebar-footer">
        <div>
          <strong>Color codes (Project):</strong><br />
          üü• &lt; 60% ‚Äì Needs training<br />
          üü® 60‚Äì79% ‚Äì Average<br />
          üü© ‚â• 80% ‚Äì Confident
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="main-header">
        <div>
          <div class="main-title" id="currentMemberTitle">Select team member</div>
          <div class="main-sub" id="currentMemberSub">Choose a team member from the left to start assessment.</div>
        </div>
        <div class="main-actions">
          <button class="btn" id="exportBtn" type="button">Export PDF (Current)</button>
          <button class="btn" id="backupBtn" type="button">Backup</button>
          <label class="btn"> Restore file <input type="file" id="restoreFileInput" accept="application/json" /></label>
          <button class="btn" id="restoreAutoBtn" type="button">Restore auto</button>
        </div>
      </div>

      <div class="tabs-row">
        <button class="tab-btn active" data-tab="assessment">Assessment</button>
        <button class="tab-btn" data-tab="conversion">Conversion</button>
        <button class="tab-btn" data-tab="overview">Members overview</button>
      </div>

      <!-- ASSESSMENT -->
      <div id="assessmentTab">
        <div class="filters-row">
          <span>Region:</span>
          <select id="regionFilter"><option value="all">All regions</option></select>
          <span>Developer:</span>
          <select id="developerFilter"><option value="all">All developers</option></select>
          <span class="chip chip-soft" id="regionStats">No projects yet</span>
        </div>

        <div class="content-grid">
          <section class="panel">
            <div class="panel-header"><div><div class="panel-title" id="formTitle">New Project Assessment</div><div class="panel-sub">Rate each point from 0 to 10</div></div></div>
            <div class="form-grid">
              <div class="field"><label>Project name</label><input id="projectName" placeholder="e.g. New Zayed Lakes" /></div>
              <div class="field"><label>Developer</label><input id="projectDeveloper" placeholder="e.g. Emaar, SODIC..." /></div>
              <div class="field"><label>Region / Area</label><input id="projectRegion" placeholder="e.g. New Zayed, NAC..." /></div>
              <div class="scores-grid">
                <div class="field"><label>Development</label><input type="number" id="scoreDevelopment" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Location</label><input type="number" id="scoreLocation" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Masterplan</label><input type="number" id="scoreMasterplan" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Facilities</label><input type="number" id="scoreFacilities" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Type mix</label><input type="number" id="scoreType" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Price positioning</label><input type="number" id="scorePrice" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Payment plan</label><input type="number" id="scorePayment" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Delivery date</label><input type="number" id="scoreDelivery" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Finishing quality</label><input type="number" id="scoreFinishing" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Maintenance (deposit)</label><input type="number" id="scoreMaintenance" class="score-input" min="0" max="10" step="0.5" /></div>
                <div class="field"><label>Orientation skills</label><input type="number" id="scoreOrientation" class="score-input" min="0" max="10" step="0.5" /></div>
              </div>
              <div class="field"><label>Notes</label><textarea id="projectNotes"></textarea></div>
              <div style="display:flex;gap:8px;">
                <button class="btn btn-primary" id="addProjectBtn" type="button">Save project</button>
                <button class="btn" id="cancelEditBtn" type="button">Cancel edit</button>
              </div>
            </div>
          </section>

          <section class="panel projects-panel">
            <div class="panel-header"><div><div class="panel-title">Projects & Scores</div><div class="panel-sub">Click a card to expand ‚Äì filtered by region & developer.</div></div></div>
            <div class="cards-list" id="projectsList"><div class="empty-state">No projects yet. Add a new assessment on the left.</div></div>
            <div class="cards-list" id="printProjectsList" style="display:none"></div>
          </section>
        </div>
      </div>

      <!-- CONVERSION -->
      <div id="conversionTab" class="hidden">
        <div class="conversion-layout">
          <section class="panel">
            <div class="panel-header"><div><div class="panel-title">Daily conversion</div><div class="panel-sub">Sales write numbers, tool calculates %</div></div></div>
            <div class="form-grid">
              <div class="field"><label>Select date</label><input type="date" id="convDate" /></div>
              <div class="field"><label>Targets mode</label><small>Choose per day / per month</small></div>
              <div class="field">
                <table class="conversion-table"><thead><tr><th>Metric</th><th>Target</th><th>Mode</th><th>Daily</th><th>Monthly</th></tr></thead><tbody id="convTargetsBody"></tbody></table>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header"><div><div class="panel-title">Team performance (per day & month)</div><div class="panel-sub">Numbers per sales ‚Äì plus monthly totals</div></div></div>
            <div style="overflow-x:auto">
              <table class="conversion-table"><thead><tr><th>Sales name</th><th>Deals</th><th>Scheduled</th><th>Meetings</th><th>Requests</th><th>Call back</th><th>Active calls</th><th>Calls</th><th>Total %</th></tr></thead><tbody id="convTableBody"></tbody></table>
            </div>
            <div class="conversion-summary" id="convSummary">ŸÖŸÅŸäÿ¥ ÿØÿßÿ™ÿß ŸÑÿ≥Ÿá ŸÑŸÑŸäŸàŸÖ ÿØŸá.</div>
          </section>
        </div>
      </div>

      <!-- OVERVIEW -->
      <div id="overviewTab" class="hidden">
        <div class="panel overview-panel">
          <div class="panel-header">
            <div><div class="panel-title">Members overview</div><div class="panel-sub">50/50 weight ‚Äî Assessment & Conversion combined (Total performance)</div></div>
            <div><small class="panel-sub">Date for conversion: <span id="overviewDateLabel"></span></small></div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px;">
            <label style="font-size:11px;color:var(--text-muted)">Choose month date:</label>
            <input type="month" id="overviewMonthInput" style="background:#0d1017;border-radius:8px;padding:6px;border:1px solid var(--border);color:var(--text)" />
          </div>
          <div class="overview-grid" id="overviewGrid"></div>
        </div>
      </div>

    </main>
  </div>

  <script>
    /* -------------------------
       state + helpers
       ------------------------- */
    const STORAGE_KEY = "br_assessment_v3";
    const AUTO_BACKUP_KEY = "br_assessment_autobackup_v1";
    const ALL_TEAM_ID = "__ALL_TEAM__";
    const CONV_METRICS = ["deals","scheduled","meetings","requests","callBack","activeCalls","calls"];
    const CONV_TARGET_METRICS = ["deals","scheduled","meetings","requests","calls"];
    const CONV_LABELS = { deals:"Deals", scheduled:"Scheduled", meetings:"Meetings", requests:"Requests", callBack:"Call back", activeCalls:"Active calls", calls:"Calls" };
    let state = { members: [], selectedMemberId: null, activeTab: "assessment", conversion: { currentDate: null, targets:{}, entries:{} } };
    let editingProjectId = null;

    function initConversionState(){
      if (!state.conversion) state.conversion = { currentDate: null, targets: {}, entries: {} };
      if (!state.conversion.targets) state.conversion.targets = {};
      CONV_TARGET_METRICS.forEach(m => { if (!state.conversion.targets[m]) state.conversion.targets[m] = { mode: "day", value: 0 }; });
      if (!state.conversion.entries) state.conversion.entries = {};
    }
    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) { try { state = JSON.parse(raw); } catch(e){ console.error("parse fail",e); } }
      if (!state.members) state.members = [];
      if (!state.selectedMemberId && state.members.length) state.selectedMemberId = state.members[0].id;
      initConversionState();
    }
    function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify(state)); }catch(e){console.warn(e)} }
    function uid(){ return Date.now().toString(36) + Math.random().toString(16).slice(2) }
    function todayISO(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return `${d.getFullYear()}-${m}-${day}` }
    function daysInMonth(dateStr){ const [y,m] = dateStr.split("-").map(n=>parseInt(n,10)); return new Date(y,m,0).getDate() }
    function getCurrentMember(){
      if (state.selectedMemberId === ALL_TEAM_ID) return { id: ALL_TEAM_ID, name: "All team", isAllTeam:true, projects: state.members.flatMap(m => (m.projects||[]).map(p => ({...p, ownerName: m.name}))) };
      return state.members.find(m=>m.id===state.selectedMemberId) || null;
    }
    function computeAssessmentAverage(member){
      const projects = member?.projects || []; if (!projects.length) return 0;
      return projects.reduce((s,p)=>s+(p.overallPercent||0),0)/projects.length;
    }
    function getMonthlyTarget(metric, dateStr){
      if (!CONV_TARGET_METRICS.includes(metric)) return 0;
      const cfg = state.conversion.targets[metric] || { mode:"day", value:0 };
      const days = daysInMonth(dateStr);
      return cfg.mode==="day" ? (cfg.value||0)*days : (cfg.value||0);
    }
    function getDailyTargetForPercent(metric, dateStr){
      if (!CONV_TARGET_METRICS.includes(metric)) return 0;
      const cfg = state.conversion.targets[metric] || { mode:"day", value:0 };
      return cfg.value || 0;
    }
    function computeConversionMonthlyScoreForMember(memberId, dateStr){
      if (!dateStr) dateStr = state.conversion.currentDate || todayISO();
      const [y,m] = dateStr.split("-"); const prefix = `${y}-${m}`;
      const totals = {}; CONV_METRICS.forEach(x=>totals[x]=0);
      Object.entries(state.conversion.entries||{}).forEach(([day,per])=>{
        if (!day.startsWith(prefix)) return;
        const e = per[memberId]; if (!e) return;
        CONV_METRICS.forEach(k=> totals[k] += e[k] || 0);
      });
      let sum=0,count=0;
      CONV_TARGET_METRICS.forEach(metric=>{
        const monthlyTarget = getMonthlyTarget(metric, dateStr);
        if (monthlyTarget>0){ const pct = (totals[metric]/monthlyTarget)*100; sum+=pct; count++; }
      });
      return count?sum/count:0;
    }

    /* -------------------------
       DOM refs
       ------------------------- */
    const teamListEl = document.getElementById("teamList");
    const newMemberInput = document.getElementById("newMemberInput");
    const addMemberBtn = document.getElementById("addMemberBtn");
    const currentMemberTitle = document.getElementById("currentMemberTitle");
    const currentMemberSub = document.getElementById("currentMemberSub");
    const regionFilter = document.getElementById("regionFilter");
    const developerFilter = document.getElementById("developerFilter");
    const regionStats = document.getElementById("regionStats");
    const projectsListEl = document.getElementById("projectsList");
    const printProjectsListEl = document.getElementById("printProjectsList");
    const exportBtn = document.getElementById("exportBtn");
    const backupBtn = document.getElementById("backupBtn");
    const restoreFileInput = document.getElementById("restoreFileInput");
    const restoreAutoBtn = document.getElementById("restoreAutoBtn");
    const convDateEl = document.getElementById("convDate");
    const convTargetsBody = document.getElementById("convTargetsBody");
    const convTableBody = document.getElementById("convTableBody");
    const convSummaryEl = document.getElementById("convSummary");
    const overviewGrid = document.getElementById("overviewGrid");
    const overviewMonthInput = document.getElementById("overviewMonthInput");
    const overviewDateLabel = document.getElementById("overviewDateLabel");

    /* -------------------------
       render team list
       ------------------------- */
    function renderTeamList(){
      teamListEl.innerHTML="";
      if (!state.members.length){
        const div=document.createElement("div");div.className="empty-state";div.textContent="Add your team members to start.";teamListEl.appendChild(div);
        currentMemberTitle.textContent="Select team member"; currentMemberSub.textContent="Choose a team member from the left to start assessment.";
        return;
      }
      const currentDate = state.conversion.currentDate || todayISO();
      // all team entry
      const allItem = document.createElement("div"); allItem.className="team-item"+(state.selectedMemberId===ALL_TEAM_ID?" active":"");
      const allMain = document.createElement("div"); allMain.className="team-main";
      const allName = document.createElement("div"); allName.className="team-name"; allName.textContent="All team";
      const allMeta = document.createElement("div"); allMeta.className="team-meta"; allMeta.textContent = state.members.length + " member(s)";
      allMain.appendChild(allName); allMain.appendChild(allMeta);
      const allPill = document.createElement("div"); allPill.className="team-score-pill";
      let allAvg = state.activeTab==="conversion" ? (state.members.length? state.members.reduce((s,m)=>s+computeConversionMonthlyScoreForMember(m.id,currentDate),0)/state.members.length:0) : (state.members.length? state.members.reduce((s,m)=>s+computeAssessmentAverage(m),0)/state.members.length:0);
      if ((state.activeTab==="assessment" && state.members.every(m=>!(m.projects||[]).length)) || (state.activeTab==="conversion" && !Object.keys(state.conversion.entries||{}).length)) { allPill.textContent="No score"; allPill.classList.add("pill-yellow"); }
      else { allPill.textContent = `${Math.round(allAvg)}%`; if (allAvg<60) allPill.classList.add("pill-red"); else if (allAvg<80) allPill.classList.add("pill-yellow"); else allPill.classList.add("pill-green"); }
      allItem.appendChild(allMain); allItem.appendChild(allPill); allItem.addEventListener("click", ()=>{ state.selectedMemberId = ALL_TEAM_ID; saveState(); renderAll(); }); teamListEl.appendChild(allItem);

      state.members.forEach(member=>{
        const item = document.createElement("div"); item.className="team-item"+(member.id===state.selectedMemberId?" active":""); item.dataset.id=member.id;
        const main = document.createElement("div"); main.className="team-main";
        const nameEl = document.createElement("div"); nameEl.className="team-name"; nameEl.textContent = member.name;
        const metaEl = document.createElement("div"); metaEl.className="team-meta";
        const projectsCount = (member.projects||[]).length;
        // show projects count in sidebar in non-overview tabs; in overview we want it empty
        metaEl.textContent = state.activeTab === "overview" ? "" : projectsCount + " project" + (projectsCount!==1 ? "s" : "");
        main.appendChild(nameEl); main.appendChild(metaEl);
        const pill = document.createElement("div"); pill.className="team-score-pill";
        const avg = state.activeTab==="conversion" ? computeConversionMonthlyScoreForMember(member.id,currentDate) : computeAssessmentAverage(member);
        if ((state.activeTab==="assessment" && projectsCount===0) || (state.activeTab==="conversion" && !Object.keys(state.conversion.entries||{}).length)) { pill.textContent="No score"; pill.classList.add("pill-yellow"); }
        else { pill.textContent = `${Math.round(avg)}%`; if (avg<60) pill.classList.add("pill-red"); else if (avg<80) pill.classList.add("pill-yellow"); else pill.classList.add("pill-green"); }
        item.appendChild(main); item.appendChild(pill);

        // long press delete
        let pressTimer=null; let longPressed=false;
        item.addEventListener("pointerdown", ()=>{ longPressed=false; pressTimer=setTimeout(()=>{ const ok = confirm(`ÿ™ŸÖÿ≥ÿ≠ ${member.name} ŸàŸÉŸÑ ÿßŸÑÿ™ŸÇŸäŸäŸÖÿßÿ™ ÿ®ÿ™ÿßÿπÿ™Ÿáÿü`); if (ok){ longPressed=true; state.members = state.members.filter(m=>m.id!==member.id); if (state.selectedMemberId===member.id) state.selectedMemberId = state.members[0]?.id || ALL_TEAM_ID; saveState(); renderAll(); } else longPressed=false; },650); });
        ["pointerup","pointerleave","pointercancel"].forEach(ev=> item.addEventListener(ev, ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer = null; } }));
        item.addEventListener("click", ()=>{ if (longPressed) return; state.selectedMemberId = member.id; saveState(); renderAll(); });
        teamListEl.appendChild(item);
      });
    }

    /* -------------------------
       projects list + training
       ------------------------- */
    function renderFiltersAndStats(member){
      const projects = member?.projects || [];
      const regions = new Set(); const developers = new Set();
      projects.forEach(p=>{ if (p.region) regions.add(p.region.trim()); if (p.developer) developers.add(p.developer.trim()); });
      const prevR = regionFilter.value || "all"; const prevD = developerFilter.value || "all";
      regionFilter.innerHTML = ""; const optAllR = document.createElement("option"); optAllR.value="all"; optAllR.textContent="All regions"; regionFilter.appendChild(optAllR);
      Array.from(regions).forEach(r=>{ const o=document.createElement("option"); o.value=r; o.textContent=r; regionFilter.appendChild(o);});
      developerFilter.innerHTML = ""; const optAllD = document.createElement("option"); optAllD.value="all"; optAllD.textContent="All developers"; developerFilter.appendChild(optAllD);
      Array.from(developers).forEach(d=>{ const o=document.createElement("option"); o.value=d; o.textContent=d; developerFilter.appendChild(o);});
      if (regions.has(prevR)||prevR==="all") regionFilter.value = prevR; else regionFilter.value = "all";
      if (developers.has(prevD)||prevD==="all") developerFilter.value = prevD; else developerFilter.value = "all";
      if (!projects.length){ regionStats.textContent="No projects yet"; return; }
      const selR = regionFilter.value; const selD = developerFilter.value;
      const filtered = projects.filter(p=> (selR==="all"|| (p.region||"").trim()===selR) && (selD==="all"|| (p.developer||"").trim()===selD) );
      if (!filtered.length){ regionStats.textContent="No projects with current filters"; return; }
      const avg = filtered.reduce((s,p)=>s+(p.overallPercent||0),0)/filtered.length;
      regionStats.textContent = `Filtered: ${avg.toFixed(1)}% over ${filtered.length} project(s)`;
    }

    function renderProjectsList(member){
      projectsListEl.innerHTML = "";
      if (!member || !(member.projects||[]).length){ const d=document.createElement("div"); d.className="empty-state"; d.textContent="No projects yet. Add a new assessment on the left."; projectsListEl.appendChild(d); return; }
      const selR = regionFilter.value || "all", selD = developerFilter.value || "all";
      const projects = member.projects.filter(p=> (selR==="all"|| (p.region||"").trim()===selR) && (selD==="all"|| (p.developer||"").trim()===selD) );
      if (!projects.length){ const d=document.createElement("div"); d.className="empty-state"; d.textContent="No projects with current filters."; projectsListEl.appendChild(d); return; }
      projects.slice().sort((a,b)=>b.createdAt - a.createdAt).forEach(project=>{
        const card = document.createElement("div"); card.className="card"; card.dataset.id = project.id;
        const header = document.createElement("div"); header.style.display="flex"; header.style.justifyContent="space-between"; header.style.alignItems="center";
        const left = document.createElement("div");
        const title = document.createElement("div"); title.style.fontWeight="600"; title.textContent = project.name || "Untitled";
        const sub = document.createElement("div"); sub.style.fontSize="11px"; sub.style.color="var(--text-muted)"; sub.textContent = `${project.region||""}${project.region && project.developer ? " ‚Ä¢ " : ""}${project.developer||""} ‚Ä¢ ${project.overallPercent.toFixed(1)}%`;
        left.appendChild(title); left.appendChild(sub);
        const tag = document.createElement("div"); tag.className="card-tag"; tag.textContent = project.overallPercent < 60 ? "Needs Training" : (project.overallPercent < 80 ? "Average" : "Confident");
        header.appendChild(left); header.appendChild(tag);
        card.appendChild(header);
        projectsListEl.appendChild(card);
      });
    }

    /* -------------------------
       header rendering (remove overall text for overview)
       ------------------------- */
    function renderHeaderForMember(member){
      if (state.activeTab === "overview"){ currentMemberTitle.textContent = "Members overview"; currentMemberSub.textContent = ""; return; }
      if (!member){ currentMemberTitle.textContent = "Select team member"; currentMemberSub.textContent = "Choose a team member from the left to start assessment."; return; }
      const curDate = state.conversion.currentDate || todayISO();
      if (member.isAllTeam){
        if (state.activeTab === "conversion"){
          const avg = state.members.length ? state.members.reduce((s,m)=>s+computeConversionMonthlyScoreForMember(m.id,curDate),0)/state.members.length : 0;
          currentMemberTitle.textContent = "All team ‚Äì Conversion";
          currentMemberSub.textContent = `Overall team conversion (month): ${avg.toFixed(1)}% across ${state.members.length} member(s).`;
        } else {
          const avg = state.members.length ? state.members.reduce((s,m)=>s+computeAssessmentAverage(m),0)/state.members.length : 0;
          currentMemberTitle.textContent = "All team ‚Äì Assessment";
          // to follow your request: keep assessment tab header as-is (don't change), but overview should not show overall
          currentMemberSub.textContent = `Overall team assessment: ${avg.toFixed(1)}% ‚Äì ${member.projects.length} project(s) total.`;
        }
      } else {
        if (state.activeTab === "conversion"){
          const avg = computeConversionMonthlyScoreForMember(member.id,curDate);
          currentMemberTitle.textContent = `${member.name} ‚Äì Conversion`;
          currentMemberSub.textContent = `Monthly conversion score: ${avg.toFixed(1)}% (based on targets & activities this month).`;
        } else {
          const avg = computeAssessmentAverage(member);
          currentMemberTitle.textContent = member.name;
          currentMemberSub.textContent = `Overall assessment: ${avg.toFixed(1)}% ‚Äì ${member.projects.length} project(s) evaluated.`;
        }
      }
    }

    /* -------------------------
       conversion rendering (kept same)
       ------------------------- */
    function renderConversionTargets(){
      initConversionState();
      const dateStr = state.conversion.currentDate || todayISO(); const days = daysInMonth(dateStr);
      convTargetsBody.innerHTML="";
      CONV_TARGET_METRICS.forEach(metric=>{
        const row = document.createElement("tr");
        const cfg = state.conversion.targets[metric] || { mode:"day", value:0 };
        const daily = cfg.mode==="day" ? cfg.value : (cfg.value||0)/days;
        const monthly = cfg.mode==="day" ? (cfg.value||0)*days : cfg.value||0;
        const tdLabel = document.createElement("td"); tdLabel.textContent = CONV_LABELS[metric];
        const tdValue = document.createElement("td"); const input = document.createElement("input"); input.type="number"; input.step="1"; input.value = cfg.value ?? 0;
        input.addEventListener("change", ()=>{ state.conversion.targets[metric].value = Number(input.value) || 0; saveState(); renderConversionTargets(); renderConversionTable(); renderTeamList(); const m=getCurrentMember(); renderHeaderForMember(m); });
        tdValue.appendChild(input);
        const tdMode = document.createElement("td"); const sel = document.createElement("select"); ["day","month"].forEach(mode=>{ const opt=document.createElement("option"); opt.value=mode; opt.textContent = mode==="day" ? "Per day" : "Per month"; sel.appendChild(opt); }); sel.value = cfg.mode;
        sel.addEventListener("change", ()=>{ state.conversion.targets[metric].mode = sel.value; saveState(); renderConversionTargets(); renderConversionTable(); renderTeamList(); const m=getCurrentMember(); renderHeaderForMember(m); });
        tdMode.appendChild(sel);
        const tdDaily = document.createElement("td"); tdDaily.textContent = daily ? daily.toFixed(1) : "-";
        const tdMonthly = document.createElement("td"); tdMonthly.textContent = monthly ? monthly.toFixed(1) : "-";
        row.appendChild(tdLabel);row.appendChild(tdValue);row.appendChild(tdMode);row.appendChild(tdDaily);row.appendChild(tdMonthly);
        convTargetsBody.appendChild(row);
      });
    }

    function renderConversionTable(){
      convTableBody.innerHTML="";
      const dateStr = state.conversion.currentDate || todayISO(); convDateEl.value = dateStr;
      if (!state.members.length){ const tr=document.createElement("tr"); const td=document.createElement("td"); td.colSpan=9; td.textContent="Add team members from Assessment tab first."; tr.appendChild(td); convTableBody.appendChild(tr); convSummaryEl.textContent="ŸÖŸÅŸäÿ¥ ÿ™ŸäŸÖ ŸÑÿ≥Ÿá."; return; }
      const totalsToday = {}; CONV_METRICS.forEach(m=>totalsToday[m]=0);
      const [y,m] = dateStr.split("-"); const monthPrefix = `${y}-${m}`;
      const monthlyTotalsBySales = {};
      state.members.forEach(member=>{
        const totals={}; CONV_METRICS.forEach(x=>totals[x]=0);
        Object.entries(state.conversion.entries||{}).forEach(([d,per])=>{ if (!d.startsWith(monthPrefix)) return; const e = per[member.id]; if (!e) return; CONV_METRICS.forEach(k=>totals[k]+=e[k]||0); });
        monthlyTotalsBySales[member.id]=totals;
      });
      const monthlyTargetPerMetric = {}; CONV_METRICS.forEach(metric=> monthlyTargetPerMetric[metric] = getMonthlyTarget(metric, dateStr) );

      state.members.forEach(member=>{
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td"); nameTd.className="sales-name-cell"; nameTd.textContent = member.name; tr.appendChild(nameTd);
        let sumPercents=0, countPercents=0;
        const entriesForDay = state.conversion.entries[dateStr] || {};
        const entryForDay = entriesForDay[member.id] || {};
        CONV_METRICS.forEach(metric=>{
          const td=document.createElement("td");
          const input=document.createElement("input"); input.type="number"; input.step="1";
          const current = entryForDay[metric] || 0; input.value = current;
          input.addEventListener("change", ()=>{ if (!state.conversion.entries[dateStr]) state.conversion.entries[dateStr] = {}; if (!state.conversion.entries[dateStr][member.id]) state.conversion.entries[dateStr][member.id] = {}; state.conversion.entries[dateStr][member.id][metric] = Number(input.value) || 0; saveState(); renderConversionTable(); renderTeamList(); renderHeaderForMember(getCurrentMember()); });
          td.appendChild(input);
          const dailyTarget = getDailyTargetForPercent(metric, dateStr);
          if (CONV_TARGET_METRICS.includes(metric) && dailyTarget>0){ const pct = (current/dailyTarget)*100; const span=document.createElement("div"); span.className="percent-chip"; span.textContent = `${Math.round(pct)}%`; td.appendChild(span); sumPercents += pct; countPercents++; }
          totalsToday[metric] += current;
          tr.appendChild(td);
        });
        const tdTotal = document.createElement("td"); if (countPercents>0){ const avgPercent = sumPercents/countPercents; const s=document.createElement("span"); s.textContent = `${Math.round(avgPercent)}%`; tdTotal.appendChild(s); } else tdTotal.textContent="-";
        tr.appendChild(tdTotal); convTableBody.appendChild(tr);

        // sales total row
        const totalsForSales = monthlyTotalsBySales[member.id] || {};
        const totalRow = document.createElement("tr"); totalRow.className="sales-total-row";
        const totalNameTd = document.createElement("td"); totalNameTd.className="sales-name-cell"; totalNameTd.textContent = `${member.name} total`; totalRow.appendChild(totalNameTd);
        let monthlySumPercents=0, monthlyCountPercents=0;
        CONV_METRICS.forEach(metric=>{
          const td=document.createElement("td"); const totalVal = totalsForSales[metric] || 0; const monthlyTarget = monthlyTargetPerMetric[metric] || 0;
          if (CONV_TARGET_METRICS.includes(metric) && monthlyTarget>0){ const pct=(totalVal/monthlyTarget)*100; td.textContent = `${totalVal} - `; const span=document.createElement("span"); span.className="percent-chip"; span.textContent = `${Math.round(pct)}%`; td.appendChild(span); monthlySumPercents += pct; monthlyCountPercents++; } else td.textContent = totalVal || 0;
          totalRow.appendChild(td);
        });
        const tdTotalMonth = document.createElement("td"); if (monthlyCountPercents>0){ const avgMonth = monthlySumPercents/monthlyCountPercents; tdTotalMonth.textContent = `${Math.round(avgMonth)}%`; } else tdTotalMonth.textContent = "-";
        totalRow.appendChild(tdTotalMonth); convTableBody.appendChild(totalRow);
      });

      // day summary
      const lines=[];
      CONV_METRICS.forEach(metric=>{ const total = totalsToday[metric]; let line = `${CONV_LABELS[metric]}: ${total}`; const dailyTarget = getDailyTargetForPercent(metric,state.conversion.currentDate||todayISO()); const teamTarget = (CONV_TARGET_METRICS.includes(metric) && dailyTarget>0) ? dailyTarget*state.members.length : 0; if (teamTarget>0){ const pct = (total/teamTarget)*100; line += ` / team daily target ${teamTarget.toFixed(1)} ‚Üí ${Math.round(pct)}%`; } lines.push(line); });
      convSummaryEl.innerHTML = Object.values(totalsToday).some(v=>v>0) ? lines.map(l=>`<div>${l}</div>`).join("") : "ŸÖŸÅŸäÿ¥ ÿ£ÿ±ŸÇÿßŸÖ ŸÑŸÑŸäŸàŸÖ ÿØŸá ŸÑÿ≥Ÿá.";
    }

    /* -------------------------
       Overview grid
       ------------------------- */
    function previousMonthPrefixFromMonthValue(monthValue){
      if (!monthValue) return null;
      const [y,m] = monthValue.split("-").map(n=>parseInt(n,10));
      const d = new Date(y,m-1,1); d.setMonth(d.getMonth()-1); const py = d.getFullYear(); const pm = String(d.getMonth()+1).padStart(2,"0"); return `${py}-${pm}`;
    }
    function computeMemberCombined(member, monthValue){
      const assessment = computeAssessmentAverage(member);
      let monthStr = monthValue ? monthValue + "-01" : (state.conversion.currentDate || todayISO());
      const conv = computeConversionMonthlyScoreForMember(member.id, monthStr);
      const a = isFinite(assessment)?assessment:0, c = isFinite(conv)?conv:0;
      return { assessment:a, conversion:c, combined:(a*0.5)+(c*0.5) };
    }
    function renderMembersOverview(){
      overviewGrid.innerHTML = "";
      const monthValue = overviewMonthInput.value || (state.conversion.currentDate ? state.conversion.currentDate.slice(0,7) : todayISO().slice(0,7));
      overviewDateLabel.textContent = monthValue;
      state.members.forEach(member=>{
        const { assessment, conversion, combined } = computeMemberCombined(member, monthValue);
        const card = document.createElement("div"); card.className="member-card";
        const top = document.createElement("div"); top.style.display="flex"; top.style.justifyContent="space-between"; top.style.alignItems="center";
        const left = document.createElement("div");
        const name = document.createElement("div"); name.style.fontWeight="700"; name.textContent = member.name;
        const meta = document.createElement("div"); meta.style.fontSize="11px"; meta.style.color="var(--text-muted)"; meta.textContent = `${(member.projects||[]).length} project(s)`;
        left.appendChild(name); left.appendChild(meta);
        const pill = document.createElement("div"); pill.className="team-score-pill"; pill.textContent = `${Math.round(combined)}%`; if (combined<60) pill.classList.add("pill-red"); else if (combined<80) pill.classList.add("pill-yellow"); else pill.classList.add("pill-green");
        top.appendChild(left); top.appendChild(pill); card.appendChild(top);
        const scoresRow = document.createElement("div"); scoresRow.style.display="flex"; scoresRow.style.gap="8px";
        const blockA = document.createElement("div"); blockA.style.flex="1"; blockA.innerHTML = `<div style="font-size:11px;color:var(--text-muted)">Assessment</div><div style="font-weight:700;font-size:16px">${Math.round(assessment)}%</div>`;
        const blockB = document.createElement("div"); blockB.style.flex="1"; blockB.innerHTML = `<div style="font-size:11px;color:var(--text-muted)">Conversion (${monthValue})</div><div style="font-weight:700;font-size:16px">${Math.round(conversion)}%</div>`;
        scoresRow.appendChild(blockA); scoresRow.appendChild(blockB); card.appendChild(scoresRow);
        const totalRow = document.createElement("div"); totalRow.style.display="flex"; totalRow.style.justifyContent="space-between"; totalRow.style.alignItems="center"; totalRow.style.gap="8px"; totalRow.style.padding="8px"; totalRow.style.borderRadius="8px"; totalRow.style.background="linear-gradient(90deg, rgba(10,12,18,.6), rgba(15,18,28,.6))"; totalRow.style.border="1px solid rgba(255,255,255,.03)";
        const leftTotal = document.createElement("div"); leftTotal.innerHTML = `<div style="font-size:11px;color:var(--text-muted)">Total performance (50/50)</div><div style="font-weight:700;font-size:16px">${Math.round(combined)}%</div>`;
        const trendEl = document.createElement("div"); trendEl.style.fontSize="13px";
        const prevPrefix = previousMonthPrefixFromMonthValue(monthValue); let prevCombined = combined;
        if (prevPrefix){ const prevDateStr = prevPrefix + "-01"; const prevA = computeAssessmentAverage(member); const prevC = computeConversionMonthlyScoreForMember(member.id, prevDateStr); prevCombined = (prevA*0.5)+(prevC*0.5); }
        const diff = combined - prevCombined;
        trendEl.textContent = diff > 0.5 ? `‚ñ≤ +${diff.toFixed(1)}%` : (diff < -0.5 ? `‚ñº ${diff.toFixed(1)}%` : `‚Äî 0.0%`);
        totalRow.appendChild(leftTotal); totalRow.appendChild(trendEl); card.appendChild(totalRow);
        overviewGrid.appendChild(card);
      });
    }

    /* -------------------------
       add/update projects & members
       ------------------------- */
    document.getElementById("addProjectBtn").addEventListener("click", ()=>{
      const member = getCurrentMember(); if (!member || member.isAllTeam){ alert("Select a specific team member first (not All team)."); return; }
      const realMember = state.members.find(m=>m.id===member.id); if (!realMember) return;
      const name = document.getElementById("projectName").value.trim(); if (!name){ alert("Please enter project name."); return; }
      const developer = document.getElementById("projectDeveloper").value.trim(); const region = document.getElementById("projectRegion").value.trim();
      const ids = ["scoreDevelopment","scoreLocation","scoreMasterplan","scoreFacilities","scoreType","scorePrice","scorePayment","scoreDelivery","scoreFinishing","scoreMaintenance","scoreOrientation"];
      const scores = {}; let sum=0, count=0;
      ids.forEach(id=>{ const v = Number(document.getElementById(id).value); const val = isNaN(v)?0:Math.max(0,Math.min(10,v)); scores[id.replace("score","").toLowerCase()] = val; sum+=val; count++; });
      const overallPercent = (count? (sum/count)/10*100 : 0);
      if (editingProjectId){
        const existing = realMember.projects.find(p=>p.id===editingProjectId);
        if (existing){ const old = existing.overallPercent || 0; existing.name = name; existing.developer = developer; existing.region = region; existing.scores = scores; existing.lastDelta = overallPercent - old; existing.overallPercent = overallPercent; existing.lastReassessedAt = Date.now(); }
      } else {
        const project = { id: uid(), name, developer, region, scores, notes: document.getElementById("projectNotes").value||"", overallPercent, createdAt: Date.now() };
        realMember.projects.push(project);
      }
      saveState(); clearForm(); renderAll();
    });
    function clearForm(){ ["projectName","projectDeveloper","projectRegion","projectNotes"].forEach(id=>document.getElementById(id).value=""); ["scoreDevelopment","scoreLocation","scoreMasterplan","scoreFacilities","scoreType","scorePrice","scorePayment","scoreDelivery","scoreFinishing","scoreMaintenance","scoreOrientation"].forEach(id=>document.getElementById(id).value=""); editingProjectId=null; document.getElementById("formTitle").textContent="New Project Assessment"; }

    addMemberBtn.addEventListener("click", ()=>{ const name = newMemberInput.value.trim(); if (!name) return; const member = { id: uid(), name, projects: [] }; state.members.push(member); state.selectedMemberId = member.id; newMemberInput.value=""; saveState(); renderAll(); });
    newMemberInput.addEventListener("keydown", e=>{ if (e.key==="Enter") addMemberBtn.click(); });

    regionFilter.addEventListener("change", ()=>{ const m = getCurrentMember(); renderFiltersAndStats(m); renderProjectsList(m); });
    developerFilter.addEventListener("change", ()=>{ const m = getCurrentMember(); renderFiltersAndStats(m); renderProjectsList(m); });

    /* -------------------------
       export / print (NEW: open new window with content)
       - assessment export: prints limited low projects (<=60%) as before
       - conversion export: prints only selected member totals (no daily conversion table)
       ------------------------- */
    exportBtn.addEventListener("click", ()=>{
      const member = getCurrentMember(); if (!member){ alert("Select a team member first."); return; }

      // ASSESSMENT export
      if (state.activeTab === "assessment"){
        let projects = member.projects || [];
        projects = projects.filter(p=>{ const selR = regionFilter.value || "all"; const selD = developerFilter.value || "all"; const r = (p.region||"").trim(); const d = (p.developer||"").trim(); const regionMatch = selR==="all"?true:r===selR; const devMatch = selD==="all"?true:d===selD; return regionMatch && devMatch; });
        const low = projects.filter(p=> (p.overallPercent||0) <= 60).sort((a,b)=>a.overallPercent - b.overallPercent).slice(0,10);

        // build printable html
        const html = buildPrintableHTML_Assessment(member, low);
        const w = window.open("", "_blank", "noopener,noreferrer");
        if (!w) { alert("Popup blocked ‚Äî allow popups for this site."); return; }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.focus();
        w.print();
        // optional: close window after print (some browsers block auto-close), so keep it.
        return;
      }

      // CONVERSION export
      if (state.activeTab === "conversion"){
        if (!member || member.isAllTeam){ alert("Please select a specific team member for Conversion PDF."); return; }
        const entry = Object.values(state.conversion.entries || {}).filter(e=>e[member.id]).reduce((acc,day)=>{ Object.keys(day[member.id]).forEach(k=> acc[k] = (acc[k]||0) + (day[member.id][k]||0)); return acc; }, {});
        const html = buildPrintableHTML_Conversion(member, entry, state.conversion.currentDate || todayISO());
        const w = window.open("", "_blank", "noopener,noreferrer");
        if (!w) { alert("Popup blocked ‚Äî allow popups for this site."); return; }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.focus();
        w.print();
        return;
      }

      // OVERVIEW export: if needed, we can export overview cards ‚Äî (not requested explicitly)
      if (state.activeTab === "overview"){
        // build simple overview printable with combined scores
        const monthValue = overviewMonthInput.value || (state.conversion.currentDate||todayISO()).slice(0,7);
        const cards = state.members.map(m=> computeMemberCombined(m, monthValue));
        // reuse assessment style or implement later
        const html = buildPrintableHTML_Overview(state.members, monthValue);
        const w = window.open("", "_blank", "noopener,noreferrer");
        if (!w) { alert("Popup blocked ‚Äî allow popups for this site."); return; }
        w.document.open();
        w.document.write(html);
        w.document.close();
        w.focus();
        w.print();
        return;
      }
    });

    /* -------------------------
       printable HTML builders
       ------------------------- */
    function buildPrintableHTML_Assessment(member, projects){
      const styles = `
        body{font-family:system-ui,-apple-system,Segoe UI,Arial;background:#0b0d10;color:#f5f7fb;padding:18px}
        .container{max-width:900px;margin:0 auto}
        h1{font-size:18px;margin-bottom:6px}
        .meta{color:#9aa4c0;margin-bottom:10px}
        .card{background:#111623;border-radius:10px;padding:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.04)}
        .card-title{font-weight:700}
        .card-sub{color:#9aa4c0;font-size:13px;margin-top:4px}
      `;
      const rows = projects.map(p=>`<div class="card"><div class="card-title">${escapeHtml(p.name)}</div><div class="card-sub">${escapeHtml(p.region||"")} ${p.region && p.developer ? "‚Ä¢" : ""} ${escapeHtml(p.developer||"")} ‚Ä¢ ${p.overallPercent.toFixed(1)}%</div></div>`).join("");
      return `<!doctype html><html><head><meta charset="utf-8"><title>Assessment export</title><style>${styles}</style></head><body><div class="container"><h1>Assessment report ‚Äì ${escapeHtml(member.name)}</h1><div class="meta">Filtered projects ‚â§ 60% (max 10 shown)</div>${rows || '<div class="card">No projects to show.</div>'}</div></body></html>`;
    }

    function buildPrintableHTML_Conversion(member, totalsEntry, dateStr){
      const styles = `
        body{font-family:system-ui,-apple-system,Segoe UI,Arial;background:#0b0d10;color:#f5f7fb;padding:18px}
        .container{max-width:900px;margin:0 auto}
        h1{font-size:18px;margin-bottom:6px}
        .meta{color:#9aa4c0;margin-bottom:10px}
        table{width:100%;border-collapse:collapse}
        th,td{border:1px solid rgba(255,255,255,0.06);padding:8px;text-align:center}
        th{background:#111827;color:#cbd5e1}
      `;
      const metrics = ["deals","scheduled","meetings","requests","callBack","activeCalls","calls"];
      const row = metrics.map(m=>`<td>${(totalsEntry[m]||0)}</td>`).join("");
      const headerCols = metrics.map(m=>`<th>${escapeHtml(CONV_LABELS[m])}</th>`).join("");
      const month = (dateStr||"").slice(0,7);
      return `<!doctype html><html><head><meta charset="utf-8"><title>Conversion export</title><style>${styles}</style></head><body><div class="container"><h1>Conversion report ‚Äì ${escapeHtml(member.name)}</h1><div class="meta">Month: ${escapeHtml(month)}</div><table><thead><tr>${headerCols}</tr></thead><tbody><tr>${row}</tr></tbody></table></div></body></html>`;
    }

    function buildPrintableHTML_Overview(members, monthValue){
      const styles = `
        body{font-family:system-ui,-apple-system,Segoe UI,Arial;background:#0b0d10;color:#f5f7fb;padding:18px}
        .container{max-width:900px;margin:0 auto}
        h1{font-size:18px;margin-bottom:6px}
        .card{background:#111623;border-radius:10px;padding:10px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.04)}
      `;
      const rows = members.map(m => {
        const { assessment, conversion, combined } = computeMemberCombined(m, monthValue);
        return `<div class="card"><div style="font-weight:700">${escapeHtml(m.name)}</div><div style="margin-top:6px">Assessment: ${Math.round(assessment)}% ‚Äî Conversion (${escapeHtml(monthValue)}): ${Math.round(conversion)}% ‚Äî Total: ${Math.round(combined)}%</div></div>`;
      }).join("");
      return `<!doctype html><html><head><meta charset="utf-8"><title>Overview export</title><style>${styles}</style></head><body><div class="container"><h1>Members overview ‚Äì ${escapeHtml(monthValue)}</h1>${rows}</div></body></html>`;
    }

    function escapeHtml(str){ if (!str && str!==0) return ""; return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }

    /* -------------------------
       backup / restore
       ------------------------- */
    backupBtn.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], { type: "application/json" });
      const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `br_assessment_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    restoreFileInput.addEventListener("change", e=>{
      const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
      reader.onload = ev => { try { const data = JSON.parse(ev.target.result); if (!data || !Array.isArray(data.members)) { alert("Invalid backup file."); return; } state = data; initConversionState(); saveState(); renderAll(); alert("Backup restored."); } catch(err){ console.error(err); alert("Failed to read backup file."); } };
      reader.readAsText(file); restoreFileInput.value="";
    });
    restoreAutoBtn.addEventListener("click", ()=>{
      const raw = localStorage.getItem(AUTO_BACKUP_KEY); if (!raw) { alert("No auto backup found."); return; }
      try { const data = JSON.parse(raw); if (!data || !Array.isArray(data.members)) { alert("Invalid auto backup data."); return; } state = data; initConversionState(); saveState(); renderAll(); alert("Auto backup restored."); } catch(e){ console.error(e); alert("Failed to restore auto backup."); }
    });

    /* -------------------------
       tabs + render all
       ------------------------- */
    document.querySelectorAll(".tab-btn").forEach(btn=> btn.addEventListener("click", ()=>{ document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active")); btn.classList.add("active"); state.activeTab = btn.dataset.tab; saveState(); renderAll(); }));

    function renderTabsAndContent(){
      document.getElementById("assessmentTab").classList.toggle("hidden", state.activeTab !== "assessment");
      document.getElementById("conversionTab").classList.toggle("hidden", state.activeTab !== "conversion");
      document.getElementById("overviewTab").classList.toggle("hidden", state.activeTab !== "overview");
    }

    function renderAll(){
      renderTabsAndContent();
      renderTeamList();
      const member = getCurrentMember();
      renderHeaderForMember(member);
      renderFiltersAndStats(member);
      renderProjectsList(member);
      if (!state.conversion.currentDate) state.conversion.currentDate = todayISO();
      renderConversionTargets();
      renderConversionTable();
      if (!overviewMonthInput.value) overviewMonthInput.value = (state.conversion.currentDate || todayISO()).slice(0,7);
      renderMembersOverview();
    }

    /* -------------------------
       conv date change
       ------------------------- */
    convDateEl.addEventListener("change", ()=>{ state.conversion.currentDate = convDateEl.value || todayISO(); saveState(); renderConversionTargets(); renderConversionTable(); renderTeamList(); renderHeaderForMember(getCurrentMember()); });

    overviewMonthInput.addEventListener("change", ()=> renderMembersOverview());

    /* -------------------------
       init
       ------------------------- */
    loadState();
    renderAll();

    // small helper: expose renderAll for debugging in console
    window._renderAll = renderAll;
  </script>
</body>
</html>