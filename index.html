<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Projects Assessment â€“ Real Estate Team</title>

  <!-- html2pdf via CDN (for PDF export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

  <style>
    :root {
      --bg: #0b0d10;
      --bg-alt: #151921;
      --bg-alt-soft: #1b2029;
      --primary: #4f8cff;
      --primary-soft: #223455;
      --text: #f5f7fb;
      --text-muted: #9aa4c0;
      --danger: #ff4b5c;
      --warning: #ffbf47;
      --success: #28c76f;
      --border: #252c3a;
      --card-radius: 10px;
      --shadow-soft: 0 8px 20px rgba(0,0,0,0.45);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", sans-serif; }
    body { background: radial-gradient(circle at top, #1a2134 0, #05060a 55%); color: var(--text); min-height: 100vh; display: flex; justify-content: center; padding: 16px; }
    .app { width: 100%; max-width: 1280px; background: linear-gradient(135deg, #090b10 0, #111623 45%, #090b10 100%); border-radius: 18px; box-shadow: var(--shadow-soft); display: grid; grid-template-columns: 260px 1fr; overflow: hidden; border: 1px solid rgba(255,255,255,0.04); }

    /* Sidebar */
    .sidebar { background: radial-gradient(circle at top left, #20263a 0, #070910 55%); border-right: 1px solid var(--border); padding: 18px 16px; display: flex; flex-direction: column; gap: 16px; }
    .app-title { font-size: 18px; font-weight: 700; display:flex; align-items:center; gap:8px; }
    .app-title span.logo { width:26px; height:26px; border-radius:10px; display:inline-flex; align-items:center; justify-content:center; background: radial-gradient(circle at 30% 0, #7c8cff, #3a4bff, #141633); box-shadow:0 0 18px rgba(79,140,255,0.55); font-size:14px; }
    .app-sub { font-size:11px; color:var(--text-muted); margin-top:4px; }

    .team-header { display:flex; align-items:center; justify-content:space-between; margin-top:6px; margin-bottom:4px; }
    .team-header span { font-size:12px; color:var(--text-muted); letter-spacing:0.03em; text-transform:uppercase; }

    .team-list { display:flex; flex-direction:column; gap:6px; margin-bottom:6px; max-height:260px; overflow-y:auto; padding-right:4px; }
    .team-item { border-radius:10px; padding:8px 10px; background:rgba(16,21,34,0.9); border:1px solid transparent; display:flex; justify-content:space-between; align-items:center; cursor:pointer; transition:0.18s ease; position:relative; }
    .team-item.active { border-color:var(--primary); background: radial-gradient(circle at 0 0, #27345c 0, #131723 48%); box-shadow:0 0 0 1px rgba(79,140,255,0.4); }
    .team-item:hover { background:#171c29; }
    .team-main { display:flex; flex-direction:column; gap:3px; }
    .team-name { font-size:13px; font-weight:600; }
    .team-meta { font-size:11px; color:var(--text-muted); }
    .team-score-pill { padding:3px 8px; border-radius:999px; font-size:10px; font-weight:600; letter-spacing:0.04em; text-transform:uppercase; border:1px solid rgba(255,255,255,0.08); }
    .pill-red { color:var(--danger); border-color:rgba(255,75,92,0.65); }
    .pill-yellow { color:var(--warning); border-color:rgba(255,191,71,0.7); }
    .pill-green { color:var(--success); border-color:rgba(40,199,111,0.7); }

    .add-team { display:flex; gap:6px; margin-top:4px; }
    .add-team input { flex:1; padding:6px 8px; border-radius:999px; border:1px solid var(--border); background:rgba(8,10,16,0.9); color:var(--text); font-size:12px; outline:none; }
    .add-team button { border-radius:999px; padding:0 10px; font-size:11px; border:none; background:var(--primary); color:#fff; cursor:pointer; transition:0.18s ease; }
    .add-team button:hover { background:#3a70ff; }
    .hint-mini { font-size:10px; color:var(--text-muted); margin-top:2px; }
    .sidebar-footer { margin-top:auto; padding-top:8px; border-top:1px dashed rgba(255,255,255,0.07); font-size:11px; color:var(--text-muted); display:flex; flex-direction:column; gap:6px; }
    .sidebar-footer strong { color:var(--text); font-weight:600; }

    /* Main */
    .main { padding:18px 18px 18px 16px; display:flex; flex-direction:column; gap:10px; }
    .main-header { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .main-header-left { display:flex; flex-direction:column; gap:4px; }
    .main-title { font-size:16px; font-weight:600; }
    .main-sub { font-size:11px; color:var(--text-muted); }

    .main-actions { display:flex; gap:6px; align-items:center; flex-wrap:wrap; justify-content:flex-end; }
    .btn { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.12); background:rgba(8,10,16,0.9); color:var(--text); font-size:11px; cursor:pointer; display:inline-flex; align-items:center; gap:4px; transition:0.18s ease; }
    .btn-primary { background:var(--primary); border-color:rgba(79,140,255,0.9); color:#fff; }
    .btn-primary:hover { background:#3a70ff; } .btn:hover { background:#171c29; }
    .btn input[type="file"]{ display:none; }

    .tabs-row { display:flex; gap:6px; font-size:11px; }
    .tab-btn { padding:5px 10px; border-radius:999px; border:1px solid var(--border); background:rgba(8,10,16,0.9); color:var(--text-muted); cursor:pointer; font-size:11px; }
    .tab-btn.active { background:var(--primary); border-color:rgba(79,140,255,0.9); color:#fff; }

    .hidden { display:none !important; }

    .filters-row { display:flex; gap:8px; align-items:center; font-size:11px; color:var(--text-muted); margin-top:6px; }
    .filters-row select { background:var(--bg-alt); color:var(--text); border-radius:999px; border:1px solid var(--border); padding:4px 8px; font-size:11px; outline:none; }
    .chip { padding:2px 8px; border-radius:999px; border:1px solid var(--border); font-size:10px; }
    .chip-soft { background:rgba(255,255,255,0.02); border-style:dashed; }

    .content-grid { display:grid; grid-template-columns:minmax(0,280px) minmax(0,1fr); gap:12px; margin-top:6px; height:calc(100% - 60px); min-height:0; }

    .panel { background:var(--bg-alt); border-radius:14px; border:1px solid var(--border); padding:10px 10px 12px; display:flex; flex-direction:column; gap:8px; overflow:hidden; }
    .panel-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .panel-title { font-size:12px; font-weight:600; }
    .panel-sub { font-size:10px; color:var(--text-muted); }
    .form-grid { display:grid; grid-template-columns:1fr; gap:6px; margin-top:2px; max-height:100%; overflow-y:auto; padding-right:2px; }
    .field { display:flex; flex-direction:column; gap:2px; }
    .field label { font-size:10px; color:var(--text-muted); }
    .field input, .field textarea, .field select { background:#0d1017; border-radius:8px; border:1px solid var(--border); padding:5px 7px; font-size:11px; color:var(--text); outline:none; }
    .field input:focus, .field textarea:focus, .field select:focus { border-color:var(--primary); }
    .field textarea { min-height:40px; resize:vertical; }

    .scores-grid { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:4px 8px; }
    .score-input { width:100%; }
    .score-input::-webkit-outer-spin-button, .score-input::-webkit-inner-spin-button { -webkit-appearance:none; margin:0; }

    .projects-panel { position:relative; min-height:0; display:flex; flex-direction:column; }
    .cards-list { margin-top:4px; overflow-y:auto; padding-right:2px; display:flex; flex-direction:column; gap:6px; }

    .card { background:var(--bg-alt-soft); border-radius:12px; border:1px solid var(--border); padding:8px 9px; display:flex; flex-direction:column; gap:6px; cursor:pointer; transition:0.15s ease; }
    .card:hover { border-color:rgba(255,255,255,0.12); background:#191f2b; }
    .card.reassessed { box-shadow:0 0 0 1px rgba(40,199,111,0.4); }
    .card-header { display:flex; justify-content:space-between; align-items:center; gap:6px; }
    .card-title-block { display:flex; flex-direction:column; gap:2px; }
    .card-title { font-size:12px; font-weight:600; }
    .card-subtitle { font-size:10px; color:var(--text-muted); }
    .card-tag { padding:3px 8px; border-radius:999px; font-size:10px; border:1px solid var(--border); }
    .tag-red { color:var(--danger); border-color:rgba(255,75,92,0.7); }
    .tag-yellow { color:var(--warning); border-color:rgba(255,191,71,0.7); }
    .tag-green { color:var(--success); border-color:rgba(40,199,111,0.7); }
    .card-footer { display:flex; justify-content:space-between; align-items:center; gap:6px; font-size:10px; color:var(--text-muted); flex-wrap:wrap; }
    .card-footer span.bold { font-weight:600; color:var(--text); font-size:11px; }
    .details { margin-top:4px; border-top:1px dashed rgba(255,255,255,0.08); padding-top:4px; display:none; font-size:10px; color:var(--text-muted); }
    .details-row { display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:3px 10px; margin-top:2px; }
    .details-row span { display:flex; justify-content:space-between; }
    .details-row span strong { font-weight:500; color:var(--text); }
    .card.open .details { display:block; }
    .training-panel { font-size:11px; color:var(--text-muted); display:flex; flex-direction:column; gap:4px; margin-top:4px; }
    .training-list { font-size:10px; line-height:1.4; max-height:90px; overflow-y:auto; padding-right:2px; }
    .empty-state { font-size:11px; color:var(--text-muted); padding:12px 4px; text-align:center; }
    .print-only { display:none; }

    /* Conversion */
    .conversion-layout { display:grid; grid-template-columns:minmax(0,260px) minmax(0,1fr); gap:12px; margin-top:6px; }
    .conversion-table { width:100%; border-collapse:collapse; font-size:10px; }
    .conversion-table th, .conversion-table td { border:1px solid var(--border); padding:4px 5px; text-align:center; }
    .conversion-table th { font-size:10px; background:#151a25; }
    .conversion-table td input { width:100%; border-radius:6px; border:1px solid var(--border); background:#05070b; color:var(--text); font-size:10px; padding:3px 4px; text-align:center; }
    .conversion-table .sales-name-cell { text-align:left; font-weight:600; font-size:11px; }
    .percent-chip { font-size:9px; margin-top:2px; display:inline-block; }
    .percent-good { color:var(--success); } .percent-mid { color:var(--warning); } .percent-bad { color:var(--danger); }
    .conversion-summary { font-size:10px; color:var(--text-muted); margin-top:6px; line-height:1.5; }
    .conversion-summary-line { margin-bottom:2px; }
    .sales-total-row td { background:#101521; font-weight:600; }

    /* Members overview styles */
    .overview-panel { padding:10px; }
    .overview-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:10px; margin-top:8px; }
    .member-card { background:var(--bg-alt-soft); border:1px solid var(--border); border-radius:12px; padding:10px; display:flex; flex-direction:column; gap:8px; }
    .member-top { display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .member-name { font-weight:700; font-size:14px; }
    .member-meta { font-size:11px; color:var(--text-muted); }
    .scores-row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .score-block { flex:1; min-width:96px; padding:8px; border-radius:8px; background:rgba(8,10,16,0.6); border:1px solid rgba(255,255,255,0.02); text-align:center; }
    .score-label { font-size:11px; color:var(--text-muted); margin-bottom:4px; }
    .score-value { font-weight:700; font-size:16px; }
    .total-performance { display:flex; align-items:center; gap:8px; justify-content:space-between; padding:8px; border-radius:8px; background:linear-gradient(90deg, rgba(10,12,18,0.6), rgba(15,18,28,0.6)); border:1px solid rgba(255,255,255,0.03); }
    .trend { font-size:13px; display:flex; align-items:center; gap:6px; color:var(--text-muted); }
    .trend.up { color:var(--success); } .trend.down { color:var(--danger); } .trend.flat { color:var(--text-muted); }

    /* scrollbar */
    ::-webkit-scrollbar { width:5px; }
    ::-webkit-scrollbar-track { background:transparent; }
    ::-webkit-scrollbar-thumb { background:#303545; border-radius:999px; }

    @media (max-width:900px) {
      .app { grid-template-columns:1fr; }
      .sidebar { border-right:none; border-bottom:1px solid var(--border); flex-direction:column; }
      .content-grid, .conversion-layout { grid-template-columns:1fr; height:auto; }
    }

    @media print {
      body { background:#05060a !important; -webkit-print-color-adjust:exact; print-color-adjust:exact; }
      .app, .sidebar, .main, .panel, .card, .team-item.active, .filters-row, .training-panel { background-color:#111623 !important; color:#f5f7fb !important; }
      .main-actions, .tabs-row { display:none !important; }
      #assessmentTab .content-grid { grid-template-columns:1fr !important; }
      #assessmentTab .content-grid > section:first-child { display:none !important; }
      .team-item { display:none !important; }
      .team-item.active { display:flex !important; }
      .add-team, .hint-mini { display:none !important; }
      #projectsList { display:none !important; }
      #printProjectsList { display:flex !important; }
      #assessmentTab.hidden, #conversionTab.hidden, #overviewTab.hidden { display:none !important; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div>
        <div class="app-title">
          <span class="logo">BR</span>
          <div>
            Bold Routes â€“ Projects Assessment
            <div class="app-sub">Dark mode â€¢ Compact â€¢ Team based</div>
          </div>
        </div>
      </div>

      <div class="team-header">
        <span>Team members</span>
      </div>
      <div class="team-list" id="teamList"></div>

      <div class="add-team">
        <input id="newMemberInput" placeholder="Add new member..." />
        <button id="addMemberBtn" type="button">Add</button>
      </div>
      <div class="hint-mini">Long press on member name to delete ğŸ—‘ï¸</div>

      <div class="sidebar-footer">
        <div>
          <strong>Color codes (Project):</strong><br />
          ğŸŸ¥ &lt; 60% â€“ Needs training<br />
          ğŸŸ¨ 60â€“79% â€“ Average<br />
          ğŸŸ© â‰¥ 80% â€“ Confident
        </div>
        <!-- buttons added dynamically by JS -->
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <div class="main-header">
        <div class="main-header-left">
          <div class="main-title" id="currentMemberTitle">Select team member</div>
          <div class="main-sub" id="currentMemberSub">Choose a team member from the left to start assessment.</div>
        </div>
        <div class="main-actions">
          <button class="btn" id="exportBtn" type="button">Export PDF (Current)</button>
          <button class="btn" id="backupBtn" type="button">Backup</button>
          <label class="btn"> Restore file <input type="file" id="restoreFileInput" accept="application/json" /></label>
          <button class="btn" id="restoreAutoBtn" type="button">Restore auto</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs-row">
        <button class="tab-btn active" data-tab="assessment">Assessment</button>
        <button class="tab-btn" data-tab="conversion">Conversion</button>
        <button class="tab-btn" data-tab="overview">Members overview</button>
      </div>

      <!-- ASSESSMENT TAB -->
      <div id="assessmentTab">
        <div class="filters-row">
          <span>Region:</span>
          <select id="regionFilter"><option value="all">All regions</option></select>
          <span>Developer:</span>
          <select id="developerFilter"><option value="all">All developers</option></select>
          <span class="chip chip-soft" id="regionStats">No projects yet</span>
        </div>

        <div class="content-grid">
          <!-- LEFT: FORM -->
          <section class="panel">
            <div class="panel-header">
              <div>
                <div class="panel-title" id="formTitle">New Project Assessment</div>
                <div class="panel-sub">Rate each point from 0 to 10 (English labels)</div>
              </div>
            </div>

            <div class="form-grid">
              <div class="field"><label>Project name</label><input id="projectName" placeholder="e.g. New Zayed Lakes" /></div>
              <div class="field"><label>Developer</label><input id="projectDeveloper" placeholder="e.g. Emaar, SODIC..." /></div>
              <div class="field"><label>Region / Area</label><input id="projectRegion" placeholder="e.g. New Zayed, NAC..." /></div>

              <div class="scores-grid">
                <div class="field"><label>Development</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreDevelopment" placeholder="0â€“10" /></div>
                <div class="field"><label>Location</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreLocation" placeholder="0â€“10" /></div>
                <div class="field"><label>Masterplan</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreMasterplan" placeholder="0â€“10" /></div>
                <div class="field"><label>Facilities</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreFacilities" placeholder="0â€“10" /></div>
                <div class="field"><label>Type mix</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreType" placeholder="0â€“10" /></div>
                <div class="field"><label>Price positioning</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scorePrice" placeholder="0â€“10" /></div>
                <div class="field"><label>Payment plan</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scorePayment" placeholder="0â€“10" /></div>
                <div class="field"><label>Delivery date</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreDelivery" placeholder="0â€“10" /></div>
                <div class="field"><label>Finishing quality</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreFinishing" placeholder="0â€“10" /></div>
                <div class="field"><label>Maintenance (deposit)</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreMaintenance" placeholder="0â€“10" /></div>
                <div class="field"><label>Orientation skills</label><input type="number" min="0" max="10" step="0.5" class="score-input" id="scoreOrientation" placeholder="0â€“10" /></div>
              </div>

              <div class="field"><label>Notes (optional)</label><textarea id="projectNotes" placeholder="Any remarks, red flags, comparison with competitors..."></textarea></div>

              <div class="submit-row">
                <button class="btn btn-primary" id="addProjectBtn" type="button">Save project</button>
                <button class="btn" id="cancelEditBtn" type="button">Cancel edit</button>
              </div>
            </div>
          </section>

          <!-- RIGHT: CARDS + TRAINING -->
          <section class="panel projects-panel">
            <div class="panel-header">
              <div>
                <div class="panel-title">Projects & Scores</div>
                <div class="panel-sub">Click on a card to expand details â€“ filtered by region & developer.</div>
              </div>
            </div>

            <!-- QUICK SEARCH -->
            <div style="margin-bottom:6px;">
              <input id="quickSearchProj" placeholder="Search projects or developer..." style="width:100%; padding:6px; border-radius:8px; border:1px solid var(--border); background:#0d1017; color:var(--text);" />
            </div>

            <div class="cards-list" id="projectsList"><div class="empty-state">No projects yet. Add a new assessment on the left.</div></div>
            <div class="cards-list print-only" id="printProjectsList"></div>

            <div class="training-panel">
              <div><strong>Ø®Ø·Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ): Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù Ø­Ø³Ø¨ ÙƒÙ„ Ù…Ø´Ø±ÙˆØ¹</strong></div>
              <div class="training-list" id="trainingList">Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.</div>
              <div style="margin-top:4px;"><strong>Ù†Ù‚Ø· Ù…ØªÙƒØ±Ø±Ø© Ø£Ù‚Ù„ Ù…Ù† Ù¥/Ù¡Ù  Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹:</strong></div>
              <div class="training-list" id="trainingSummaryList">Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ.</div>
            </div>
          </section>
        </div>
      </div>

      <!-- CONVERSION TAB -->
      <div id="conversionTab" class="hidden">
        <div class="conversion-layout">
          <section class="panel">
            <div class="panel-header"><div><div class="panel-title">Daily conversion</div><div class="panel-sub">Sales write numbers, tool calculates %</div></div></div>
            <div class="form-grid">
              <div class="field"><label>Select date</label><input type="date" id="convDate" /></div>
              <div class="field"><label>Targets mode</label><small>Choose per day / per month for each metric</small></div>
              <div class="field">
                <table class="conversion-table">
                  <thead><tr><th>Metric</th><th>Target</th><th>Mode</th><th>Daily</th><th>Monthly</th></tr></thead>
                  <tbody id="convTargetsBody"></tbody>
                </table>
              </div>
            </div>
          </section>

          <section class="panel">
            <div class="panel-header"><div><div class="panel-title">Team performance (per day & month)</div><div class="panel-sub">Numbers per sales â€“ plus monthly totals under each one</div></div></div>

            <div style="overflow-x:auto;">
              <table class="conversion-table" id="convTable">
                <thead><tr><th>Sales name</th><th>Deals</th><th>Scheduled</th><th>Meetings</th><th>Requests</th><th>Call back</th><th>Active calls</th><th>Calls</th><th>Total %</th></tr></thead>
                <tbody id="convTableBody"></tbody>
              </table>
            </div>

            <div class="conversion-summary" id="convSummary">Ù…ÙÙŠØ´ Ø¯Ø§ØªØ§ Ù„Ø³Ù‡ Ù„Ù„ÙŠÙˆÙ… Ø¯Ù‡.</div>
          </section>
        </div>
      </div>

      <!-- OVERVIEW TAB -->
      <div id="overviewTab" class="hidden">
        <div class="panel overview-panel">
          <div class="panel-header">
            <div><div class="panel-title">Members overview</div><div class="panel-sub">50/50 weight â€” Assessment & Conversion combined (Total performance)</div></div>
            <div>
              <small class="panel-sub">Date for conversion: <span id="overviewDateLabel"></span></small>
            </div>
          </div>

          <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
            <label style="font-size:11px; color:var(--text-muted);">Choose month date:</label>
            <input type="month" id="overviewMonthInput" style="background:#0d1017; border-radius:8px; padding:6px; border:1px solid var(--border); color:var(--text);" />
          </div>

          <div class="overview-grid" id="overviewGrid"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const STORAGE_KEY = "br_assessment_v3";
    const AUTO_BACKUP_KEY = "br_assessment_autobackup_v1";
    const ALL_TEAM_ID = "__ALL_TEAM__";

    // Conversion metrics
    const CONV_METRICS = ["deals","scheduled","meetings","requests","callBack","activeCalls","calls"];
    const CONV_TARGET_METRICS = ["deals","scheduled","meetings","requests","calls"];
    function hasTarget(metric){ return CONV_TARGET_METRICS.includes(metric); }
    const CONV_LABELS = { deals: "Deals", scheduled: "Scheduled", meetings: "Meetings", requests: "Requests", callBack: "Call back", activeCalls: "Active calls", calls: "Calls" };

    let state = { members: [], selectedMemberId: null, activeTab: "assessment", conversion: { currentDate: null, targets: {}, entries: {} } };
    let editingProjectId = null;

    function initConversionState() {
      if (!state.conversion) state.conversion = { currentDate: null, targets: {}, entries: {} };
      if (!state.conversion.targets) state.conversion.targets = {};
      CONV_TARGET_METRICS.forEach(m => { if (!state.conversion.targets[m]) state.conversion.targets[m] = { mode: "day", value: 0 }; });
      if (!state.conversion.entries) state.conversion.entries = {};
    }

    function loadState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try { state = JSON.parse(raw); } catch(e){ console.error("Failed parse", e); }
      }
      if (!state.members) state.members = [];
      if (!state.selectedMemberId && state.members.length > 0) state.selectedMemberId = state.members[0].id;
      if (!state.activeTab) state.activeTab = "assessment";
      initConversionState();
    }

    function autoBackup(){ try{ localStorage.setItem(AUTO_BACKUP_KEY, JSON.stringify(state)); }catch(e){ console.warn("Auto backup failed", e); } }
    function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); autoBackup(); }
    function uid(){ return Date.now().toString(36) + Math.random().toString(16).slice(2); }
    function todayISO(){ const d=new Date(); const m=String(d.getMonth()+1).padStart(2,"0"); const day=String(d.getDate()).padStart(2,"0"); return `${d.getFullYear()}-${m}-${day}`; }
    function daysInMonth(dateStr){ const [y,m] = dateStr.split("-").map(n=>parseInt(n,10)); return new Date(y,m,0).getDate(); }
    function monthPrefixFromDateStr(dateStr){ const [y,m] = dateStr.split("-"); return `${y}-${m}`; }

    // Elements
    const teamListEl = document.getElementById("teamList");
    const newMemberInput = document.getElementById("newMemberInput");
    const addMemberBtn = document.getElementById("addMemberBtn");
    const currentMemberTitle = document.getElementById("currentMemberTitle");
    const currentMemberSub = document.getElementById("currentMemberSub");
    const regionFilter = document.getElementById("regionFilter");
    const developerFilter = document.getElementById("developerFilter");
    const regionStats = document.getElementById("regionStats");
    const projectsListEl = document.getElementById("projectsList");
    const printProjectsListEl = document.getElementById("printProjectsList");
    const trainingListEl = document.getElementById("trainingList");
    const trainingSummaryListEl = document.getElementById("trainingSummaryList");
    const exportBtn = document.getElementById("exportBtn");
    const backupBtn = document.getElementById("backupBtn");
    const restoreFileInput = document.getElementById("restoreFileInput");
    const restoreAutoBtn = document.getElementById("restoreAutoBtn");

    const projectNameEl = document.getElementById("projectName");
    const projectDeveloperEl = document.getElementById("projectDeveloper");
    const projectRegionEl = document.getElementById("projectRegion");
    const projectNotesEl = document.getElementById("projectNotes");
    const addProjectBtn = document.getElementById("addProjectBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const formTitleEl = document.getElementById("formTitle");
    const defaultFormTitle = formTitleEl.textContent;

    const tabButtons = document.querySelectorAll(".tab-btn");
    const assessmentTabEl = document.getElementById("assessmentTab");
    const conversionTabEl = document.getElementById("conversionTab");
    const overviewTabEl = document.getElementById("overviewTab");

    const convDateEl = document.getElementById("convDate");
    const convTargetsBody = document.getElementById("convTargetsBody");
    const convTableBody = document.getElementById("convTableBody");
    const convSummaryEl = document.getElementById("convSummary");

    const overviewGrid = document.getElementById("overviewGrid");
    const overviewMonthInput = document.getElementById("overviewMonthInput");
    const overviewDateLabel = document.getElementById("overviewDateLabel");

    const scoreIds = ["scoreDevelopment","scoreLocation","scoreMasterplan","scoreFacilities","scoreType","scorePrice","scorePayment","scoreDelivery","scoreFinishing","scoreMaintenance","scoreOrientation"];
    const SCORE_LABELS = { development:"Development", location:"Location", masterplan:"Masterplan", facilities:"Facilities", type:"Type mix", price:"Price positioning", payment:"Payment plan", delivery:"Delivery date", finishing:"Finishing", maintenance:"Maintenance", orientation:"Orientation skills" };

    const quickSearchProj = document.getElementById("quickSearchProj");

    function getCurrentMember(){
      if (state.selectedMemberId === ALL_TEAM_ID) {
        // return simplified all-team object (no projects shown in conversion)
        return { id: ALL_TEAM_ID, name: "All team", isAllTeam: true, projects: state.members.flatMap(m => (m.projects||[]).map(p => ({...p, ownerName: m.name}))) };
      }
      return state.members.find(m => m.id === state.selectedMemberId) || null;
    }

    // NEW: compute assessment average for a given monthPrefix "YYYY-MM"
    function computeAssessmentAverageForMonth(member, monthPrefix){
      const projects = (member.projects || []).filter(p => {
        if (!p.createdAt) return false;
        const d = new Date(p.createdAt);
        const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,"0");
        return `${y}-${m}` === monthPrefix;
      });
      if (projects.length === 0) return 0;
      const sum = projects.reduce((acc,p)=>acc + (p.overallPercent||0), 0);
      return sum / projects.length;
    }

    // Assessment averages (existing)
    function computeAssessmentAverage(member){
      const projects = member?.projects || [];
      if (projects.length === 0) return 0;
      let sum = 0;
      projects.forEach(p => sum += p.overallPercent || 0);
      return sum / projects.length;
    }
    function computeAssessmentAllTeamAverage(){
      let sum=0; let count=0;
      state.members.forEach(m => { const avg = computeAssessmentAverage(m); if (m.projects && m.projects.length>0){ sum += avg; count++; }});
      if (!count) return 0; return sum/count;
    }

    // Conversion monthly score (per member)
    function getMonthlyTarget(metric, dateStr){
      if (!hasTarget(metric)) return 0;
      const cfg = state.conversion.targets[metric]; if (!cfg) return 0;
      const days = daysInMonth(dateStr);
      if (cfg.mode === "day") return (cfg.value || 0) * days;
      return cfg.value || 0;
    }
    function getDailyTargetForPercent(metric, dateStr){
      if (!hasTarget(metric)) return 0;
      const cfg = state.conversion.targets[metric]; if (!cfg) return 0;
      if (cfg.mode === "day") return cfg.value || 0;
      return cfg.value || 0;
    }

    function computeConversionMonthlyScoreForMember(memberId, dateStr){
      if (!dateStr) dateStr = state.conversion.currentDate || todayISO();
      const [y,m] = dateStr.split("-");
      const prefix = `${y}-${m}`;
      const totals = {}; CONV_METRICS.forEach(metric => totals[metric]=0);

      Object.entries(state.conversion.entries).forEach(([day, perMember])=>{
        if (!day.startsWith(prefix)) return;
        const entry = perMember[memberId];
        if (!entry) return;
        CONV_METRICS.forEach(metric => totals[metric] += entry[metric] || 0);
      });

      let sumPct=0; let count=0;
      CONV_TARGET_METRICS.forEach(metric=>{
        const monthlyTarget = getMonthlyTarget(metric, dateStr);
        if (monthlyTarget > 0) {
          const pct = (totals[metric] / monthlyTarget) * 100;
          sumPct += pct; count++;
        }
      });
      if (!count) return 0;
      return sumPct / count;
    }

    function computeConversionAllTeamAverage(dateStr){
      if (!state.members.length) return 0;
      if (!dateStr) dateStr = state.conversion.currentDate || todayISO();
      let sum=0; let count=0;
      state.members.forEach(m => { const s = computeConversionMonthlyScoreForMember(m.id, dateStr); sum += s; count++; });
      if (!count) return 0; return sum/count;
    }

    function percentClass(percent){
      if (percent >= 100) return "percent-good";
      if (percent >= 60) return "percent-mid";
      return "percent-bad";
    }

    // Render team list
    function renderTeamList(){
      teamListEl.innerHTML = "";
      if (state.members.length === 0) {
        const div = document.createElement("div"); div.className="empty-state"; div.textContent="Add your team members to start."; teamListEl.appendChild(div);
        currentMemberTitle.textContent = "Select team member"; currentMemberSub.textContent = "Choose a team member from the left to start assessment.";
        return;
      }

      const currentDate = state.conversion.currentDate || todayISO();

      // All team item
      let totalProjects=0; state.members.forEach(m => totalProjects += (m.projects?.length||0));
      const allItem = document.createElement("div"); allItem.className = "team-item" + (state.selectedMemberId===ALL_TEAM_ID ? " active":"");
      const allMain = document.createElement("div"); allMain.className="team-main";
      const allName = document.createElement("div"); allName.className="team-name"; allName.textContent="All team";
      const allMeta = document.createElement("div"); allMeta.className="team-meta";
      // show only member count for overview/conversion per your request
      allMeta.textContent = state.members.length + " member(s)";
      allMain.appendChild(allName); allMain.appendChild(allMeta);
      const allPill = document.createElement("div"); allPill.className="team-score-pill";
      let allAvg = 0;
      if (state.activeTab === "conversion") allAvg = computeConversionAllTeamAverage(currentDate); else allAvg = computeAssessmentAllTeamAverage();
      if ((state.activeTab === "assessment" && totalProjects === 0) || (state.activeTab === "conversion" && !state.members.length)) {
        allPill.textContent = "No score"; allPill.classList.add("pill-yellow");
      } else {
        allPill.textContent = `${allAvg.toFixed(0)}%`;
        if (allAvg < 60) allPill.classList.add("pill-red"); else if (allAvg < 80) allPill.classList.add("pill-yellow"); else allPill.classList.add("pill-green");
      }
      allItem.appendChild(allMain); allItem.appendChild(allPill);
      allItem.addEventListener("click", ()=>{ state.selectedMemberId = ALL_TEAM_ID; saveState(); renderAll(); });
      teamListEl.appendChild(allItem);

      // members
      state.members.forEach(member=>{
        const item = document.createElement("div"); item.className="team-item"+(member.id===state.selectedMemberId?" active":""); item.dataset.id = member.id;
        const main = document.createElement("div"); main.className="team-main";
        const nameEl = document.createElement("div"); nameEl.className="team-name"; nameEl.textContent = member.name;
        const metaEl = document.createElement("div"); metaEl.className="team-meta";
        const projectsCount = member.projects?.length || 0;
        if (state.activeTab === "assessment") metaEl.textContent = projectsCount + " project" + (projectsCount!==1 ? "s":"");
        else metaEl.textContent = "Conversion";
        main.appendChild(nameEl); main.appendChild(metaEl);

        const pill = document.createElement("div"); pill.className="team-score-pill";
        let avg = 0;
        if (state.activeTab === "conversion") avg = computeConversionMonthlyScoreForMember(member.id, currentDate);
        else avg = computeAssessmentAverage(member);

        if ((state.activeTab === "assessment" && projectsCount === 0) || (state.activeTab === "conversion" && !Object.keys(state.conversion.entries || {}).length)) {
          pill.textContent = "No score"; pill.classList.add("pill-yellow");
        } else {
          pill.textContent = `${avg.toFixed(0)}%`;
          if (avg < 60) pill.classList.add("pill-red"); else if (avg < 80) pill.classList.add("pill-yellow"); else pill.classList.add("pill-green");
        }

        item.appendChild(main); item.appendChild(pill);

        // long press delete
        let pressTimer=null; let longPressed=false;
        item.addEventListener("pointerdown", ()=>{
          longPressed=false; pressTimer=setTimeout(()=>{
            const ok = confirm(`ØªÙ…Ø³Ø­ ${member.name} ÙˆÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨ØªØ§Ø¹ØªÙ‡ØŸ`);
            if (ok) { longPressed=true; state.members = state.members.filter(m=>m.id!==member.id); if (state.selectedMemberId === member.id) state.selectedMemberId = state.members[0]?.id || ALL_TEAM_ID; saveState(); renderAll(); } else longPressed=false;
          },650);
        });
        ["pointerup","pointerleave","pointercancel"].forEach(ev=> item.addEventListener(ev, ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }));
        item.addEventListener("click", ()=>{ if (longPressed) return; state.selectedMemberId = member.id; saveState(); renderAll(); });

        teamListEl.appendChild(item);
      });
    }

    // Filters + stats
    function renderFiltersAndStats(member){
      const projects = member?.projects || [];
      const regions = new Set(); const developers = new Set();
      projects.forEach(p=>{ const r=(p.region||"").trim(); const d=(p.developer||"").trim(); if (r) regions.add(r); if (d) developers.add(d); });

      const prevRegion = regionFilter.value || "all"; const prevDev = developerFilter.value || "all";
      regionFilter.innerHTML=""; const allOptR=document.createElement("option"); allOptR.value="all"; allOptR.textContent="All regions"; regionFilter.appendChild(allOptR);
      Array.from(regions).forEach(r=>{ const opt=document.createElement("option"); opt.value=r; opt.textContent=r; regionFilter.appendChild(opt); });
      developerFilter.innerHTML=""; const allOptD=document.createElement("option"); allOptD.value="all"; allOptD.textContent="All developers"; developerFilter.appendChild(allOptD);
      Array.from(developers).forEach(d=>{ const opt=document.createElement("option"); opt.value=d; opt.textContent=d; developerFilter.appendChild(opt); });

      if (regions.has(prevRegion) || prevRegion==="all") regionFilter.value = prevRegion; else regionFilter.value="all";
      if (developers.has(prevDev) || prevDev==="all") developerFilter.value = prevDev; else developerFilter.value = "all";

      if (projects.length===0) { regionStats.textContent="No projects yet"; return; }
      const selectedRegion = regionFilter.value; const selectedDev = developerFilter.value;
      const filtered = projects.filter(p=>{ const r=(p.region||"").trim(); const d=(p.developer||"").trim(); const regionMatch = selectedRegion==="all"?true:r===selectedRegion; const devMatch = selectedDev==="all"?true:d===selectedDev; return regionMatch && devMatch; });
      if (filtered.length===0){ regionStats.textContent="No projects with current filters"; return; }
      const sum = filtered.reduce((acc,p)=>acc+(p.overallPercent||0), 0); const avg = sum/filtered.length;
      regionStats.textContent = `Filtered: ${avg.toFixed(1)}% over ${filtered.length} project(s)`;
    }

    function tagFromPercent(percent){ if (percent < 60) return { text: "Needs Training", className: "tag-red" }; if (percent < 80) return { text: "Average", className: "tag-yellow" }; return { text: "Confident", className: "tag-green" }; }

    // Edit project load
    function startEditProject(project){
      editingProjectId = project.id;
      formTitleEl.textContent = `Editing: ${project.name || "project"}`;
      projectNameEl.value = project.name || "";
      projectDeveloperEl.value = project.developer || "";
      projectRegionEl.value = project.region || "";
      projectNotesEl.value = project.notes || "";
      const s = project.scores || {};
      document.getElementById("scoreDevelopment").value = typeof s.development==="number"?s.development:"";
      document.getElementById("scoreLocation").value = typeof s.location==="number"?s.location:"";
      document.getElementById("scoreMasterplan").value = typeof s.masterplan==="number"?s.masterplan:"";
      document.getElementById("scoreFacilities").value = typeof s.facilities==="number"?s.facilities:"";
      document.getElementById("scoreType").value = typeof s.type==="number"?s.type:"";
      document.getElementById("scorePrice").value = typeof s.price==="number"?s.price:"";
      document.getElementById("scorePayment").value = typeof s.payment==="number"?s.payment:"";
      document.getElementById("scoreDelivery").value = typeof s.delivery==="number"?s.delivery:"";
      document.getElementById("scoreFinishing").value = typeof s.finishing==="number"?s.finishing:"";
      document.getElementById("scoreMaintenance").value = typeof s.maintenance==="number"?s.maintenance:"";
      document.getElementById("scoreOrientation").value = typeof s.orientation==="number"?s.orientation:"";
    }

    // Render projects list
    function renderProjectsList(member){
      projectsListEl.innerHTML = "";
      if (!member || !member.projects || member.projects.length === 0) {
        const div = document.createElement("div"); div.className="empty-state"; div.textContent="No projects yet. Add a new assessment on the left."; projectsListEl.appendChild(div); trainingListEl.textContent="Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ."; trainingSummaryListEl.textContent="Ù„Ø³Ù‡ Ù…Ø§ÙÙŠØ´ Ø¯Ø§ØªØ§ ÙƒÙØ§ÙŠØ© Ø¯Ù„ÙˆÙ‚ØªÙŠ."; return;
      }

      const selectedRegion = regionFilter.value || "all"; const selectedDev = developerFilter.value || "all";
      const searchTerm = (quickSearchProj?.value||"").trim().toLowerCase();

      const projects = member.projects.filter(p=>{
        const r=(p.region||"").trim(); const d=(p.developer||"").trim();
        const regionMatch = selectedRegion==="all"?true:r===selectedRegion;
        const devMatch = selectedDev==="all"?true:d===selectedDev;
        const textMatch = !searchTerm ? true : ( (p.name||"").toLowerCase().includes(searchTerm) || (p.developer||"").toLowerCase().includes(searchTerm) );
        return regionMatch && devMatch && textMatch;
      });

      if (projects.length===0){ const div=document.createElement("div"); div.className="empty-state"; div.textContent="No projects with current filters."; projectsListEl.appendChild(div); }
      else {
        projects.slice().sort((a,b)=>b.createdAt - a.createdAt).forEach(project=>{
          const card = document.createElement("div"); card.className="card"; card.dataset.id = project.id;
          if (typeof project.lastDelta === "number") card.classList.add("reassessed");
          const header = document.createElement("div"); header.className="card-header";
          const titleBlock = document.createElement("div"); titleBlock.className="card-title-block";
          const title = document.createElement("div"); title.className="card-title"; title.textContent = project.name || "Untitled project";
          const subtitle = document.createElement("div"); subtitle.className="card-subtitle";
          const bits = []; if (project.region) bits.push(project.region); if (project.developer) bits.push(project.developer); bits.push(`${(project.overallPercent||0).toFixed(1)}%`); subtitle.textContent = bits.join(" â€¢ ");
          titleBlock.appendChild(title); titleBlock.appendChild(subtitle);
          const tagEl = document.createElement("div"); const tagInfo = tagFromPercent(project.overallPercent || 0); tagEl.className = "card-tag " + tagInfo.className; tagEl.textContent = tagInfo.text;
          header.appendChild(titleBlock); header.appendChild(tagEl);

          const footer = document.createElement("div"); footer.className="card-footer";
          const created = document.createElement("span"); const date = new Date(project.createdAt || Date.now()); created.textContent = `Added: ${date.toLocaleDateString()}`;
          const scoreSpan = document.createElement("span"); scoreSpan.innerHTML = `<span class="bold">${(project.overallPercent||0).toFixed(1)}%</span> avg (0â€“10 scale)`;
          footer.appendChild(created); footer.appendChild(scoreSpan);

          if (typeof project.lastDelta === "number") {
            const trend = document.createElement("span"); const diff = project.lastDelta;
            if (diff > 0) { trend.textContent = `Reassessment: Improved +${diff.toFixed(1)} pts`; trend.style.color = "#28c76f"; } else if (diff < 0) { trend.textContent = `Reassessment: Dropped ${diff.toFixed(1)} pts`; trend.style.color = "#ff4b5c"; } else { trend.textContent = "Reassessment: No change"; trend.style.color = "#9aa4c0"; }
            footer.appendChild(trend);
          }

          const details = document.createElement("div"); details.className="details";
          const rows = document.createElement("div"); rows.className="details-row";
          const s = project.scores || {};
          const mapping = [["Development", s.development], ["Location", s.location], ["Masterplan", s.masterplan], ["Facilities", s.facilities], ["Type mix", s.type], ["Price position", s.price], ["Payment plan", s.payment], ["Delivery", s.delivery], ["Finishing", s.finishing], ["Maintenance", s.maintenance], ["Orientation", s.orientation]];
          mapping.forEach(([label, value]) => { const span = document.createElement("span"); const v = typeof value === "number" ? value.toFixed(1) : "-"; span.innerHTML = `<strong>${label}</strong><span>${v}/10</span>`; rows.appendChild(span); });
          details.appendChild(rows);
          if (project.notes && project.notes.trim()) { const note = document.createElement("div"); note.style.marginTop="4px"; note.textContent = `Notes: ${project.notes}`; details.appendChild(note); }

          card.appendChild(header); card.appendChild(details); card.appendChild(footer);

          let pressTimer=null; let longPressed=false;
          card.addEventListener("pointerdown", ()=>{ longPressed=false; pressTimer=setTimeout(()=>{ const ok = confirm(`ØªÙ…Ø³Ø­ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ "${project.name}" Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ`); if (ok){ longPressed=true; const realMember = member.isAllTeam ? state.members.find(m=>(m.projects||[]).some(p=>p.id===project.id)) : member; if (realMember){ realMember.projects = realMember.projects.filter(p=>p.id!==project.id); saveState(); renderAll(); } } else longPressed=false; },650); });
          ["pointerup","pointerleave","pointercancel"].forEach(ev=> card.addEventListener(ev, ()=>{ if (pressTimer){ clearTimeout(pressTimer); pressTimer=null; } }));
          card.addEventListener("click", ()=>{ if (longPressed) return; card.classList.toggle("open"); if (!member.isAllTeam) startEditProject(project); });

          projectsListEl.appendChild(card);
        });
      }

      // training plan
      const lines=[]; const summaryCounts={};
      (member.projects || []).forEach(project => {
        const weakPoints=[]; const s = project.scores || {};
        Object.entries(s).forEach(([key, value])=> { const num = typeof value==="number"?value:0; const label = SCORE_LABELS[key] || key; if (num < 7) weakPoints.push(label); if (num <= 5) summaryCounts[label] = (summaryCounts[label]||0) + 1; });
        if (weakPoints.length > 0) {
          const ownerPrefix = member.isAllTeam && project.ownerName ? `${project.ownerName} â€“ ` : `${member.name} â€“ `;
          lines.push(`${ownerPrefix}${project.name}: Ù…Ø­ØªØ§Ø¬ ÙŠØ²ÙˆØ¯ Ù…Ø°Ø§ÙƒØ±ØªÙ‡ ÙÙŠ [${weakPoints.join("ØŒ ")}]`);
        }
      });

      if (lines.length === 0) trainingListEl.textContent = "Ù…ÙÙŠØ´ Ù†Ù‚Ø§Ø· Ø¶Ø¹Ù ÙˆØ§Ø¶Ø­Ø© Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø´ØºÙ„ ÙƒÙˆÙŠØ³ ğŸ‘Œ";
      else { trainingListEl.innerHTML = ""; lines.forEach(l=>{ const div=document.createElement("div"); div.textContent = l; trainingListEl.appendChild(div); }); }

      const summaryEntries = Object.entries(summaryCounts).sort((a,b)=>b[1]-a[1]);
      if (summaryEntries.length === 0) trainingSummaryListEl.textContent = "Ù…ÙÙŠØ´ Ù†Ù‚Ø· Ù…ØªÙƒØ±Ø±Ø© Ø£Ù‚Ù„ Ù…Ù† Ù¥/Ù¡Ù  Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ ÙƒÙ„ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹.";
      else { trainingSummaryListEl.innerHTML = ""; summaryEntries.forEach(([label,count])=>{ const div=document.createElement("div"); div.textContent = `${label}: Ø¸Ù‡Ø± ÙÙŠ ${count} Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¯Ø±Ø¬Ø§Øª â‰¤ Ù¥`; trainingSummaryListEl.appendChild(div); }); }
    }

    function renderHeaderForMember(member){
      if (!member) { currentMemberTitle.textContent="Select team member"; currentMemberSub.textContent="Choose a team member from the left to start assessment."; return; }
      const currentDate = state.conversion.currentDate || todayISO();
      if (member.isAllTeam) {
        if (state.activeTab === "conversion") {
          const avg = computeConversionAllTeamAverage(currentDate);
          currentMemberTitle.textContent = "All team â€“ Conversion";
          currentMemberSub.textContent = `Overall team conversion (month): ${avg.toFixed(1)}% across ${state.members.length} member(s).`;
        } else {
          const avg = computeAssessmentAllTeamAverage();
          currentMemberTitle.textContent = "All team â€“ Assessment";
          currentMemberSub.textContent = `Overall team assessment: ${avg.toFixed(1)}% â€“ ${member.projects.length} project(s) total.`;
        }
      } else {
        if (state.activeTab === "conversion") {
          const avg = computeConversionMonthlyScoreForMember(member.id, currentDate);
          currentMemberTitle.textContent = `${member.name} â€“ Conversion`;
          currentMemberSub.textContent = `Monthly conversion score: ${avg.toFixed(1)}% (based on targets & activities this month).`;
        } else {
          const avg = computeAssessmentAverage(member);
          currentMemberTitle.textContent = member.name;
          currentMemberSub.textContent = `Overall assessment: ${avg.toFixed(1)}% â€“ ${member.projects.length} project(s) evaluated.`;
        }
      }
    }

    function clearForm(){ projectNameEl.value=""; projectDeveloperEl.value=""; projectRegionEl.value=""; projectNotesEl.value=""; scoreIds.forEach(id=>{ const el=document.getElementById(id); el.value=""; }); editingProjectId=null; formTitleEl.textContent = defaultFormTitle; }

    // Add member
    addMemberBtn.addEventListener("click", ()=>{ const name = newMemberInput.value.trim(); if (!name) return; const member = { id: uid(), name, projects: [] }; state.members.push(member); state.selectedMemberId = member.id; newMemberInput.value=""; saveState(); renderAll(); });
    newMemberInput.addEventListener("keydown", e=>{ if (e.key === "Enter") addMemberBtn.click(); });

    // Add/update project
    addProjectBtn.addEventListener("click", ()=>{
      let member = getCurrentMember(); if (!member || member.isAllTeam) { alert("Select a specific team member first (not All team)."); return; }
      const realMember = state.members.find(m=>m.id===member.id); if (!realMember) return;
      const name = projectNameEl.value.trim(); const developer = projectDeveloperEl.value.trim(); const region = projectRegionEl.value.trim(); if (!name){ alert("Please enter project name."); return; }
      const scores = {}; let sum=0; let count=0;
      function parseScore(id, keyName){ const el=document.getElementById(id); const v=parseFloat(el.value); const value = isNaN(v)?0:Math.min(Math.max(v,0),10); scores[keyName]=value; sum += value; count += 1; }
      parseScore("scoreDevelopment","development"); parseScore("scoreLocation","location"); parseScore("scoreMasterplan","masterplan"); parseScore("scoreFacilities","facilities"); parseScore("scoreType","type"); parseScore("scorePrice","price"); parseScore("scorePayment","payment"); parseScore("scoreDelivery","delivery"); parseScore("scoreFinishing","finishing"); parseScore("scoreMaintenance","maintenance"); parseScore("scoreOrientation","orientation");
      const avgScoreOutOf10 = count>0?sum/count:0; const overallPercent = (avgScoreOutOf10/10)*100;
      let isEdit=false;
      if (editingProjectId){
        const existing = realMember.projects.find(p=>p.id===editingProjectId);
        if (existing){ isEdit=true; const oldOverall = existing.overallPercent || 0; existing.name = name; existing.developer = developer; existing.region = region; existing.scores = scores; existing.notes = projectNotesEl.value.trim(); existing.lastReassessedAt = Date.now(); existing.lastDelta = overallPercent - oldOverall; existing.overallPercent = overallPercent; }
      }
      if (!isEdit){ const project = { id: uid(), name, developer, region, scores, notes: projectNotesEl.value.trim(), overallPercent, createdAt: Date.now() }; realMember.projects.push(project); }
      saveState(); clearForm(); renderAll();
    });

    cancelEditBtn.addEventListener("click", ()=> clearForm());

    regionFilter.addEventListener("change", ()=>{ const member = getCurrentMember(); renderFiltersAndStats(member); renderProjectsList(member); });
    developerFilter.addEventListener("change", ()=>{ const member = getCurrentMember(); renderFiltersAndStats(member); renderProjectsList(member); });

    quickSearchProj.addEventListener("input", ()=>{ renderProjectsList(getCurrentMember()); });

    // Export / backup / restore
    exportBtn.addEventListener("click", ()=>{
      const member = getCurrentMember(); if (!member) { alert("Select a team member first."); return; }
      if (state.activeTab === "assessment") {
        const selectedRegion = regionFilter.value || "all"; const selectedDev = developerFilter.value || "all"; let projects = member.projects || [];
        projects = projects.filter(p=>{ const r=(p.region||"").trim(); const d=(p.developer||"").trim(); const regionMatch = selectedRegion==="all"?true:r===selectedRegion; const devMatch = selectedDev==="all"?true:d===selectedDev; return regionMatch && devMatch; });
        const lowProjects = projects.filter(p=>(p.overallPercent||0) <= 60).sort((a,b)=>a.overallPercent - b.overallPercent);
        const limited = lowProjects.slice(0,5);
        printProjectsListEl.innerHTML = "";
        if (limited.length === 0) { const div=document.createElement("div"); div.className="empty-state"; div.textContent="No projects â‰¤ 60% with current filters."; printProjectsListEl.appendChild(div); }
        else { limited.forEach(project=>{ const card=document.createElement("div"); card.className="card"; const header=document.createElement("div"); header.className="card-header"; const titleBlock=document.createElement("div"); titleBlock.className="card-title-block"; const title=document.createElement("div"); title.className="card-title"; title.textContent = project.name || "Untitled project"; const subtitle=document.createElement("div"); subtitle.className="card-subtitle"; const bits=[]; if (project.region) bits.push(project.region); if (project.developer) bits.push(project.developer); bits.push(`${(project.overallPercent||0).toFixed(1)}%`); subtitle.textContent = bits.join(" â€¢ "); titleBlock.appendChild(title); titleBlock.appendChild(subtitle); const tagEl=document.createElement("div"); const tagInfo=tagFromPercent(project.overallPercent || 0); tagEl.className="card-tag "+tagInfo.className; tagEl.textContent = tagInfo.text; header.appendChild(titleBlock); header.appendChild(tagEl); const footer=document.createElement("div"); footer.className="card-footer"; const scoreSpan=document.createElement("span"); scoreSpan.innerHTML = `<span class="bold">${(project.overallPercent||0).toFixed(1)}%</span> avg (0â€“10 scale)`; footer.appendChild(scoreSpan); card.appendChild(header); card.appendChild(footer); printProjectsListEl.appendChild(card); }); }
      }
    });

    // ===== enhanced projects CSV export =====
    function exportProjectsCSVEnhanced(){
      const member = getCurrentMember();
      if (!member) return alert("Select a member or All team first.");
      // apply current filters (region/dev/search)
      const selRegion = regionFilter.value || "all";
      const selDev = developerFilter.value || "all";
      const searchTerm = (quickSearchProj?.value||"").trim().toLowerCase();

      let projects = (member.projects || []).map(p => ({...p, ownerName: member.isAllTeam ? p.ownerName || "" : member.name}));
      projects = projects.filter(p=>{
        const r=(p.region||"").trim(); const d=(p.developer||"").trim();
        const regionMatch = selRegion==="all"?true:r===selRegion;
        const devMatch = selDev==="all"?true:d===selDev;
        const textMatch = !searchTerm ? true : ((p.name||"").toLowerCase().includes(searchTerm) || (p.developer||"").toLowerCase().includes(searchTerm));
        return regionMatch && devMatch && textMatch;
      });

      if (!projects.length) return alert("No projects to export with current filters.");

      // header
      const rows = [["Project","Developer","Region","Owner","Overall %","Orientation (0-10)","Created At (iso)","Tag","Notes"]];

      projects.forEach(p=>{
        const orientation = (p.scores && typeof p.scores.orientation === "number") ? p.scores.orientation.toFixed(1) : "";
        const tag = (p.overallPercent||0) < 60 ? "Needs Training" : ((p.overallPercent||0) < 80 ? "Average" : "Confident");
        rows.push([p.name||"", p.developer||"", p.region||"", p.ownerName||"", (p.overallPercent||0).toFixed(1), orientation, new Date(p.createdAt||Date.now()).toISOString(), tag, p.notes ? p.notes.replace(/\n/g," \\n ") : ""]);
      });

      // summary row: averages
      const avgOverall = projects.reduce((a,b)=>a+(b.overallPercent||0),0)/projects.length;
      const avgOrientation = projects.reduce((a,b)=>a+((b.scores && typeof b.scores.orientation === "number") ? b.scores.orientation : 0),0)/projects.length;
      rows.push([]); // blank
      rows.push(["SUMMARY", "", "", `${projects.length} project(s)`, avgOverall.toFixed(1), avgOrientation.toFixed(2), "", "", ""]);

      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const filename = `projects_${(member.name||'all').replace(/\s+/g,'_')}_${(regionFilter.value||'all')}_${(developerFilter.value||'all')}_${new Date().toISOString().slice(0,10)}.csv`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // ===== export conversion monthly CSV =====
    function exportConversionMonthlyCSV(monthValue){
      // monthValue format "YYYY-MM" optional; default to state.conversion.currentDate month
      const month = monthValue || (state.conversion.currentDate ? state.conversion.currentDate.slice(0,7) : todayISO().slice(0,7));
      const prefix = month;
      // header
      const header = ["Sales Name", ...CONV_METRICS.map(m => `${CONV_LABELS[m]} (total)`), ...CONV_METRICS.filter(m=>hasTarget(m)).map(m=>`${CONV_LABELS[m]} (% of target)`)];
      const rows = [header];

      // compute monthly totals per sales
      state.members.forEach(member=>{
        const totals = {}; CONV_METRICS.forEach(m=>totals[m]=0);
        Object.entries(state.conversion.entries || {}).forEach(([day, perMember])=>{
          if (!day.startsWith(prefix)) return;
          const e = perMember[member.id];
          if (!e) return;
          CONV_METRICS.forEach(m=> totals[m] += (e[m] || 0));
        });
        const line = [member.name];
        CONV_METRICS.forEach(m=> line.push(totals[m] || 0));
        // percentages relative to monthly target
        CONV_METRICS.filter(m=>hasTarget(m)).forEach(m=>{
          const monthlyTarget = getMonthlyTarget(m, month + "-01");
          const pct = monthlyTarget > 0 ? ((totals[m] / monthlyTarget) * 100).toFixed(1) : "";
          line.push(pct ? `${pct}%` : "");
        });
        rows.push(line);
      });

      // totals row
      const totalsAll = {}; CONV_METRICS.forEach(m=>totalsAll[m]=0);
      Object.entries(state.conversion.entries || {}).forEach(([day, perMember])=>{
        if (!day.startsWith(prefix)) return;
        Object.entries(perMember).forEach(([memberId, entry])=>{
          CONV_METRICS.forEach(m=> totalsAll[m] += (entry[m]||0));
        });
      });
      const totalLine = ["Team total"];
      CONV_METRICS.forEach(m=> totalLine.push(totalsAll[m] || 0));
      CONV_METRICS.filter(m=>hasTarget(m)).forEach(m=>{
        const monthlyTarget = getMonthlyTarget(m, month + "-01");
        const pct = monthlyTarget > 0 ? ((totalsAll[m] / monthlyTarget) * 100).toFixed(1) : "";
        totalLine.push(pct ? `${pct}%` : "");
      });
      rows.push([]); rows.push(totalLine);

      const csv = rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
      const filename = `conversion_${month}.csv`;
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a"); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    backupBtn.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download = `br_assessment_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    });

    restoreFileInput.addEventListener("change", e=>{
      const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
      reader.onload = evt => { try { const data = JSON.parse(evt.target.result); if (!data || !Array.isArray(data.members)) { alert("Invalid backup file."); return; } state = data; initConversionState(); saveState(); renderAll(); alert("Backup restored successfully."); } catch(err){ console.error(err); alert("Failed to read backup file."); } };
      reader.readAsText(file); restoreFileInput.value="";
    });

    restoreAutoBtn.addEventListener("click", ()=>{
      const raw = localStorage.getItem(AUTO_BACKUP_KEY); if (!raw) { alert("No auto backup found."); return; }
      try { const data = JSON.parse(raw); if (!data || !Array.isArray(data.members)) { alert("Invalid auto backup data."); return; } state = data; initConversionState(); saveState(); renderAll(); alert("Auto backup restored."); } catch(e){ console.error(e); alert("Failed to restore auto backup."); }
    });

    // Tabs switching
    tabButtons.forEach(btn=> btn.addEventListener("click", ()=>{ const tab = btn.dataset.tab; state.activeTab = tab; saveState(); renderAll(); }));

    function renderTabs(){
      tabButtons.forEach(btn=> btn.classList.toggle("active", btn.dataset.tab === state.activeTab));
      assessmentTabEl.classList.toggle("hidden", state.activeTab !== "assessment");
      conversionTabEl.classList.toggle("hidden", state.activeTab !== "conversion");
      overviewTabEl.classList.toggle("hidden", state.activeTab !== "overview");
    }

    // Conversion targets rendering
    function renderConversionTargets(){
      initConversionState();
      const dateStr = state.conversion.currentDate || todayISO(); const days = daysInMonth(dateStr);
      convTargetsBody.innerHTML = "";
      CONV_TARGET_METRICS.forEach(metric=>{
        const row = document.createElement("tr");
        const cfg = state.conversion.targets[metric] || { mode:"day", value:0 };
        const daily = cfg.mode === "day" ? cfg.value : (cfg.value||0)/days;
        const monthly = cfg.mode === "day" ? (cfg.value||0)*days : cfg.value||0;
        const tdLabel = document.createElement("td"); tdLabel.textContent = CONV_LABELS[metric];
        const tdValue = document.createElement("td"); const input = document.createElement("input"); input.type="number"; input.step="1"; input.value = cfg.value ?? 0;
        input.addEventListener("change", ()=>{ const v = parseFloat(input.value); state.conversion.targets[metric].value = isNaN(v)?0:v; saveState(); renderConversionTargets(); renderConversionTable(); renderTeamList(); const member = getCurrentMember(); renderHeaderForMember(member); });
        tdValue.appendChild(input);
        const tdMode = document.createElement("td"); const sel = document.createElement("select"); ["day","month"].forEach(mode=>{ const opt=document.createElement("option"); opt.value=mode; opt.textContent = mode==="day" ? "Per day" : "Per month"; sel.appendChild(opt); }); sel.value = cfg.mode;
        sel.addEventListener("change", ()=>{ state.conversion.targets[metric].mode = sel.value; saveState(); renderConversionTargets(); renderConversionTable(); renderTeamList(); const member = getCurrentMember(); renderHeaderForMember(member); });
        tdMode.appendChild(sel);
        const tdDaily = document.createElement("td"); tdDaily.textContent = daily ? daily.toFixed(1) : "-";
        const tdMonthly = document.createElement("td"); tdMonthly.textContent = monthly ? monthly.toFixed(1) : "-";
        row.appendChild(tdLabel); row.appendChild(tdValue); row.appendChild(tdMode); row.appendChild(tdDaily); row.appendChild(tdMonthly);
        convTargetsBody.appendChild(row);
      });
    }

    // Conversion table rendering
    function renderConversionTable(){
      convTableBody.innerHTML = "";
      const dateStr = state.conversion.currentDate || todayISO();
      convDateEl.value = dateStr;
      const entriesForDay = state.conversion.entries[dateStr] || {};

      if (!state.members.length) {
        const tr = document.createElement("tr"); const td=document.createElement("td"); td.colSpan=9; td.textContent="Add team members from Assessment tab first."; tr.appendChild(td); convTableBody.appendChild(tr); convSummaryEl.textContent="Ù…ÙÙŠØ´ ØªÙŠÙ… Ù„Ø³Ù‡."; return;
      }

      const totalsToday = {}; CONV_METRICS.forEach(m=> totalsToday[m]=0);
      const [year,month] = dateStr.split("-"); const monthPrefix = `${year}-${month}`;
      const monthlyTotalsBySales = {};
      state.members.forEach(member=>{
        const totals = {}; CONV_METRICS.forEach(m=> totals[m]=0);
        Object.entries(state.conversion.entries).forEach(([d, perMember])=>{
          if (!d.startsWith(monthPrefix)) return;
          const entry = perMember[member.id]; if (!entry) return;
          CONV_METRICS.forEach(metric => totals[metric] += entry[metric] || 0);
        });
        monthlyTotalsBySales[member.id] = totals;
      });

      const monthlyTargetPerMetric = {}; CONV_METRICS.forEach(metric => monthlyTargetPerMetric[metric] = getMonthlyTarget(metric, dateStr));

      state.members.forEach(member=>{
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td"); nameTd.className="sales-name-cell"; nameTd.textContent = member.name; tr.appendChild(nameTd);
        let sumPercents=0; let countPercents=0;
        const entryForDay = entriesForDay[member.id] || {};
        CONV_METRICS.forEach(metric => {
          const td = document.createElement("td");
          const input = document.createElement("input"); input.type="number"; input.step="1";
          const current = entryForDay[metric] || 0; input.value = current;
          input.addEventListener("change", ()=> {
            const v = parseFloat(input.value);
            if (!state.conversion.entries[dateStr]) state.conversion.entries[dateStr] = {};
            if (!state.conversion.entries[dateStr][member.id]) state.conversion.entries[dateStr][member.id] = {};
            state.conversion.entries[dateStr][member.id][metric] = isNaN(v)?0:v;
            saveState(); renderConversionTable(); renderTeamList(); const m = getCurrentMember(); renderHeaderForMember(m);
          });
          td.appendChild(input);
          const dailyTarget = getDailyTargetForPercent(metric, dateStr);
          if (hasTarget(metric) && dailyTarget > 0) {
            let percent = (current / dailyTarget) * 100;
            const span = document.createElement("div"); span.className = "percent-chip " + percentClass(percent); span.textContent = `${percent.toFixed(0)}%`;
            td.appendChild(span);
            sumPercents += percent; countPercents++;
          }
          totalsToday[metric] += current;
          tr.appendChild(td);
        });
        const tdTotal = document.createElement("td");
        if (countPercents > 0) { const avgPercent = sumPercents / countPercents; const span = document.createElement("span"); span.className = percentClass(avgPercent); span.textContent = `${avgPercent.toFixed(0)}%`; tdTotal.appendChild(span); } else tdTotal.textContent = "-";
        tr.appendChild(tdTotal);
        convTableBody.appendChild(tr);

        // sales total row
        const totalsForSales = monthlyTotalsBySales[member.id] || {};
        const totalRow = document.createElement("tr"); totalRow.className="sales-total-row";
        const totalNameTd = document.createElement("td"); totalNameTd.className="sales-name-cell"; totalNameTd.textContent = `${member.name} total`; totalRow.appendChild(totalNameTd);
        let monthlySumPercents=0; let monthlyCountPercents=0;
        CONV_METRICS.forEach(metric=>{
          const td = document.createElement("td"); const totalVal = totalsForSales[metric] || 0; const monthlyTarget = monthlyTargetPerMetric[metric] || 0;
          if (hasTarget(metric) && monthlyTarget > 0) {
            const pct = (totalVal / monthlyTarget) * 100;
            td.textContent = `${totalVal} - `;
            const span = document.createElement("span"); span.className = "percent-chip " + percentClass(pct); span.textContent = `${pct.toFixed(0)}%`; td.appendChild(span);
            monthlySumPercents += pct; monthlyCountPercents++;
          } else { td.textContent = totalVal || 0; }
          totalRow.appendChild(td);
        });
        const tdTotalMonth = document.createElement("td");
        if (monthlyCountPercents>0) { const avgMonth = monthlySumPercents / monthlyCountPercents; const span = document.createElement("span"); span.className = percentClass(avgMonth); span.textContent = `${avgMonth.toFixed(0)}%`; tdTotalMonth.appendChild(span); } else tdTotalMonth.textContent="-";
        totalRow.appendChild(tdTotalMonth);
        convTableBody.appendChild(totalRow);
      });

      // summary for the day
      const lines = [];
      CONV_METRICS.forEach(metric => {
        const total = totalsToday[metric];
        let line = `${CONV_LABELS[metric]}: ${total}`;
        const dailyTarget = getDailyTargetForPercent(metric, state.conversion.currentDate || todayISO());
        const teamTarget = hasTarget(metric) && dailyTarget > 0 ? dailyTarget * state.members.length : 0;
        if (teamTarget > 0) {
          const pct = (total / teamTarget) * 100;
          line += ` / team daily target ${teamTarget.toFixed(1)} â†’ ${pct.toFixed(0)}%`;
        }
        lines.push(line);
      });

      if (!Object.values(totalsToday).some(v=> v>0)) convSummaryEl.textContent = "Ù…ÙÙŠØ´ Ø£Ø±Ù‚Ø§Ù… Ù„Ù„ÙŠÙˆÙ… Ø¯Ù‡ Ù„Ø³Ù‡.";
      else convSummaryEl.innerHTML = lines.map(l=> `<div class="conversion-summary-line">${l}</div>`).join("");
    }

    convDateEl.addEventListener("change", ()=>{
      const val = convDateEl.value || todayISO(); state.conversion.currentDate = val; saveState(); renderConversionTargets(); renderConversionTable(); renderTeamList(); const member = getCurrentMember(); renderHeaderForMember(member);
    });

    // ===== Overview tab logic =====
    // overview month input: default to current month
    function monthToInputValue(dateStr){
      // dateStr "YYYY-MM-DD" or "YYYY-MM"
      if (!dateStr) return "";
      const parts = dateStr.split("-"); return `${parts[0]}-${parts[1]}`;
    }

    overviewMonthInput.addEventListener("change", ()=> { renderMembersOverview(); });

    function previousMonthPrefixFromMonthValue(monthValue){
      // monthValue "YYYY-MM"
      if (!monthValue) return null;
      const [y,m] = monthValue.split("-").map(n=>parseInt(n,10));
      const d = new Date(y, m-1, 1);
      d.setMonth(d.getMonth() - 1);
      const py = d.getFullYear(); const pm = String(d.getMonth()+1).padStart(2,"0");
      return `${py}-${pm}`;
    }

    // Modified: computeMemberCombined now uses month-specific assessment when monthValue provided
    function computeMemberCombined(member, monthValue){
      // 50/50 weighting: assessment average (0-100) and conversion monthly % (0-100)
      // monthValue is "YYYY-MM" or null -> use state.conversion.currentDate month
      let assessment = 0;
      const monthPrefix = monthValue || (state.conversion.currentDate ? state.conversion.currentDate.slice(0,7) : todayISO().slice(0,7));
      // try month-specific assessment first; fallback to overall if no projects in month
      const monthAssessment = computeAssessmentAverageForMonth(member, monthPrefix);
      if (monthAssessment > 0) assessment = monthAssessment;
      else assessment = computeAssessmentAverage(member);
      let monthStr;
      if (monthValue) monthStr = monthValue + "-01"; else monthStr = state.conversion.currentDate || todayISO();
      const conv = computeConversionMonthlyScoreForMember(member.id, monthStr);
      const a = isFinite(assessment) ? assessment : 0;
      const c = isFinite(conv) ? conv : 0;
      const combined = (a * 0.5) + (c * 0.5);
      return { assessment: a, conversion: c, combined };
    }

    function renderMembersOverview(){
      overviewGrid.innerHTML = "";
      // set overview month label
      const monthValue = overviewMonthInput.value || (state.conversion.currentDate ? state.conversion.currentDate.slice(0,7) : todayISO().slice(0,7));
      overviewDateLabel.textContent = monthValue;
      // for each member render card
      state.members.forEach(member=>{
        const { assessment, conversion, combined } = computeMemberCombined(member, monthValue);
        const card = document.createElement("div"); card.className = "member-card";
        const top = document.createElement("div"); top.className = "member-top";
        const left = document.createElement("div");
        const name = document.createElement("div"); name.className="member-name"; name.textContent = member.name;
        const meta = document.createElement("div"); meta.className="member-meta"; meta.textContent = `${(member.projects?.length||0)} project(s)`;
        left.appendChild(name); left.appendChild(meta);

        // pill color same logic as team list for combined
        const pill = document.createElement("div"); pill.className = "team-score-pill";
        pill.textContent = `${combined.toFixed(0)}%`;
        if (combined < 60) pill.classList.add("pill-red"); else if (combined < 80) pill.classList.add("pill-yellow"); else pill.classList.add("pill-green");

        top.appendChild(left); top.appendChild(pill);
        card.appendChild(top);

        const scoresRow = document.createElement("div"); scoresRow.className="scores-row";
        const blockA = document.createElement("div"); blockA.className="score-block";
        blockA.innerHTML = `<div class="score-label">Assessment</div><div class="score-value">${assessment.toFixed(0)}%</div>`;
        const blockB = document.createElement("div"); blockB.className="score-block";
        blockB.innerHTML = `<div class="score-label">Conversion (${monthValue})</div><div class="score-value">${conversion.toFixed(0)}%</div>`;
        scoresRow.appendChild(blockA); scoresRow.appendChild(blockB);
        card.appendChild(scoresRow);

        const totalRow = document.createElement("div"); totalRow.className="total-performance";
        const leftTotal = document.createElement("div"); leftTotal.innerHTML = `<div style="font-size:11px;color:var(--text-muted)">Total performance (50/50)</div><div style="font-weight:700;font-size:16px">${combined.toFixed(0)}%</div>`;
        const trendEl = document.createElement("div"); trendEl.className="trend";
        // compute previous month combined and show arrow + diff; show "No previous data" if none
        const prevMonthPrefix = previousMonthPrefixFromMonthValue(monthValue);
        let prevCombined = null;
        if (prevMonthPrefix) {
          // use month-specific assessment for previous month too
          const prevAssessment = computeAssessmentAverageForMonth(member, prevMonthPrefix);
          const fallbackPrevAssessment = computeAssessmentAverage(member);
          const prevA = prevAssessment > 0 ? prevAssessment : (fallbackPrevAssessment > 0 ? fallbackPrevAssessment : null);
          const prevDateStr = prevMonthPrefix + "-01";
          const prevConv = computeConversionMonthlyScoreForMember(member.id, prevDateStr);
          if (prevA === null && !prevConv) {
            prevCombined = null; // no previous data
          } else {
            const pa = prevA === null ? 0 : prevA;
            prevCombined = (pa*0.5) + (prevConv*0.5);
          }
        } else {
          prevCombined = null;
        }
        if (prevCombined === null) {
          trendEl.classList.add("flat");
          trendEl.innerHTML = `<span>â€”</span><span>No previous data</span>`;
        } else {
          const diff = combined - prevCombined;
          if (diff > 0.5) { trendEl.classList.add("up"); trendEl.innerHTML = `<span>â–²</span><span>+${diff.toFixed(1)}%</span>`; }
          else if (diff < -0.5) { trendEl.classList.add("down"); trendEl.innerHTML = `<span>â–¼</span><span>${diff.toFixed(1)}%</span>`; }
          else { trendEl.classList.add("flat"); trendEl.innerHTML = `<span>â€”</span><span>0.0%</span>`; }
        }

        totalRow.appendChild(leftTotal); totalRow.appendChild(trendEl);
        card.appendChild(totalRow);

        overviewGrid.appendChild(card);
      });
    }

    // Render all conversion targets, table, team, projects, overview
    function renderAll(){
      renderTabs();
      renderTeamList();
      const member = getCurrentMember();
      renderHeaderForMember(member);
      renderFiltersAndStats(member);
      renderProjectsList(member);

      if (!state.conversion.currentDate) state.conversion.currentDate = todayISO();
      renderConversionTargets();
      renderConversionTable();

      // overview defaults
      // set overview month input to currently selected conversion month if empty
      if (!overviewMonthInput.value) overviewMonthInput.value = (state.conversion.currentDate || todayISO()).slice(0,7);
      renderMembersOverview();
    }

    // init load
    loadState();

    // ===== inject UI buttons and features (single place) =====
    (function injectSidebarButtons(){
      const footer = document.querySelector(".sidebar-footer");

      // toggle percent visibility
      const togglePercentBtn = document.createElement("button");
      togglePercentBtn.className = "btn";
      togglePercentBtn.textContent = "Hide % in sidebar";
      togglePercentBtn.dataset.hidden = "0";
      togglePercentBtn.addEventListener("click", ()=>{
        const items = document.querySelectorAll(".team-score-pill");
        const hidden = togglePercentBtn.dataset.hidden === "1";
        items.forEach(it => { it.style.visibility = hidden ? "visible" : "hidden"; });
        togglePercentBtn.dataset.hidden = hidden ? "0" : "1";
        togglePercentBtn.textContent = hidden ? "Hide % in sidebar" : "Show % in sidebar";
      });
      footer.appendChild(togglePercentBtn);

      // export CSV
      const exportCsvBtn = document.createElement("button");
      exportCsvBtn.className = "btn";
      exportCsvBtn.textContent = "Export Projects (CSV)";
      exportCsvBtn.addEventListener("click", exportProjectsCSVEnhanced);
      footer.appendChild(exportCsvBtn);

      // export conversion CSV
      const btnExportConv = document.createElement("button");
      btnExportConv.className = "btn";
      btnExportConv.textContent = "Export Conversion (CSV)";
      btnExportConv.addEventListener("click", ()=> {
        const month = prompt("Enter month to export in format YYYY-MM (leave empty for current):", (state.conversion.currentDate||todayISO()).slice(0,7));
        if (month === null) return;
        exportConversionMonthlyCSV(month || null);
      });
      footer.appendChild(btnExportConv);

      // seed demo data
      const quickSeedBtn = document.createElement("button");
      quickSeedBtn.className = "btn";
      quickSeedBtn.textContent = "Seed demo data";
      quickSeedBtn.addEventListener("click", ()=>{
        if (!confirm("Add demo sample data?")) return;
        state.members = [
          { id: uid(), name: "Dina", projects: [
            { id: uid(), name:"HydePark New Cairo", developer:"HydePark", region:"New Cairo", scores:{development:8,location:7,masterplan:7.5,facilities:8,type:7,price:6,payment:7,delivery:6.5,finishing:7,maintenance:6,orientation:8}, overallPercent:72.5, createdAt: Date.now()-1000*60*60*24*30, notes:"Ready to move" }
          ]},
          { id: uid(), name: "Khaled", projects: [
            { id: uid(), name:"Zayed Lakes", developer:"ZayedCo", region:"New Zayed", scores:{development:6,location:5,masterplan:5,facilities:6,type:5.5,price:5,payment:6,delivery:5.5,finishing:5,maintenance:4.5,orientation:6}, overallPercent:53.6, createdAt: Date.now()-1000*60*60*24*10, notes:"Needs follow-up" }
          ]}
        ];
        saveState(); renderAll();
      });
      footer.appendChild(quickSeedBtn);

      // PDF exports (Projects / Conversion / Overview)
      const btnP = document.createElement("button"); btnP.className="btn"; btnP.textContent="Export Projects (PDF)";
      btnP.addEventListener("click", ()=> exportFilteredProjectsToPDF());
      footer.appendChild(btnP);

      const btnC = document.createElement("button"); btnC.className="btn"; btnC.textContent="Export Conversion (PDF)";
      btnC.addEventListener("click", ()=> {
        const month = prompt("Enter month YYYY-MM (leave empty for current):", (state.conversion.currentDate||todayISO()).slice(0,7));
        if (month === null) return;
        exportConversionToPDF(month || null);
      });
      footer.appendChild(btnC);

      const btnO = document.createElement("button"); btnO.className="btn"; btnO.textContent="Export Overview (PDF)";
      btnO.addEventListener("click", ()=> exportOverviewToPDF());
      footer.appendChild(btnO);
    })();

    // ===== PDF Export helpers (using html2pdf) =====

    // utility: create printable container with styles
    function makePrintableContainer(titleHtml, bodyHtml){
      const wrap = document.createElement("div");
      wrap.style.padding = "18px";
      wrap.style.background = "#fff";
      wrap.style.color = "#000";
      wrap.style.fontFamily = "Arial, Helvetica, sans-serif";
      wrap.style.lineHeight = "1.25";
      // header
      const header = document.createElement("div");
      header.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
          <div style="font-size:16px;font-weight:700;">${titleHtml}</div>
          <div style="font-size:12px;color:#666;">Generated: ${new Date().toLocaleString()}</div>
        </div>
        <hr style="border:none;border-top:1px solid #ddd;margin:6px 0 12px 0;">
      `;
      wrap.appendChild(header);
      const body = document.createElement("div");
      body.innerHTML = bodyHtml;
      wrap.appendChild(body);
      return wrap;
    }

    // ===== Export filtered Projects to PDF =====
    function exportFilteredProjectsToPDF(){
  const member = getCurrentMember();
  if (!member) return alert("Select a member first.");

  // ===== apply SAME filters as UI =====
  const selRegion = regionFilter.value || "all";
  const selDev = developerFilter.value || "all";
  const searchTerm = (quickSearchProj?.value || "").trim().toLowerCase();

  let projects = (member.projects || []).map(p => ({
    ...p,
    ownerName: member.isAllTeam ? p.ownerName || "" : member.name
  }));

  projects = projects.filter(p=>{
    const r = (p.region||"").trim();
    const d = (p.developer||"").trim();

    const regionMatch = selRegion==="all" ? true : r===selRegion;
    const devMatch = selDev==="all" ? true : d===selDev;
    const textMatch = !searchTerm
      ? true
      : ((p.name||"").toLowerCase().includes(searchTerm)
        || (p.developer||"").toLowerCase().includes(searchTerm));

    return regionMatch && devMatch && textMatch;
  });

  // ===== score filter + sort + limit =====
  projects = projects
    .filter(p => (p.overallPercent||0) <= 60)
    .sort((a,b)=> (a.overallPercent||0) - (b.overallPercent||0))
    .slice(0, 5);

  if (!projects.length){
    alert("No projects â‰¤ 60% with current filters.");
    return;
  }

  // ===== build CARDS html =====
  let bodyHtml = `
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;font-size:13px;">
  `;

  projects.forEach(p=>{
    const tag =
      p.overallPercent < 60 ? "Needs training" :
      p.overallPercent < 80 ? "Average" : "Confident";

    bodyHtml += `
      <div style="border:1px solid #e5e5e5;border-radius:10px;padding:10px;">
        <div style="font-weight:700;margin-bottom:4px">${escapeHtml(p.name||"")}</div>
        <div style="font-size:11px;color:#555;margin-bottom:6px">
          ${escapeHtml(p.region||"")} â€¢ ${escapeHtml(p.developer||"")}
        </div>
        <div style="font-size:16px;font-weight:700;margin-bottom:4px">
          ${(p.overallPercent||0).toFixed(1)}%
        </div>
        <div style="font-size:11px;margin-bottom:6px">
          Orientation: ${p.scores?.orientation ?? "-"} / 10
        </div>
        <div style="display:inline-block;font-size:10px;padding:3px 8px;border-radius:999px;border:1px solid #999">
          ${tag}
        </div>
      </div>
    `;
  });

  bodyHtml += `</div>`;

  const title = `${member.name} â€“ Weak projects (â‰¤ 60%)`;
  const printable = makePrintableContainer(title, bodyHtml);

  html2pdf().set({
    margin: [10,10,10,10],
    filename: `${member.name.replace(/\s+/g,"_")}_projects_cards.pdf`,
    image: { type:'jpeg', quality:0.95 },
    html2canvas: { scale:2, useCORS:true },
    jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
  }).from(printable).save();
}
    // ===== Export Conversion summary for selected month to PDF =====
    function exportConversionToPDF(monthValue){
      const month = monthValue || (state.conversion.currentDate ? state.conversion.currentDate.slice(0,7) : todayISO().slice(0,7));
      // build table
      let rowsHtml = `<div style="margin-bottom:8px;font-size:13px;"><strong>Month:</strong> ${month}</div>`;
      rowsHtml += `<table style="width:100%;border-collapse:collapse;font-size:12px;">`;
      // header
      rowsHtml += `<thead><tr><th style="padding:6px;border-bottom:1px solid #ddd;text-align:left">Sales</th>`;
      CONV_METRICS.forEach(m => { rowsHtml += `<th style="padding:6px;border-bottom:1px solid #ddd;text-align:center">${escapeHtml(CONV_LABELS[m])}</th>`; });
      rowsHtml += `</tr></thead><tbody>`;
      // compute totals per sales (same logic as earlier)
      const prefix = month;
      state.members.forEach(mem=>{
        const totals = {}; CONV_METRICS.forEach(m=> totals[m]=0);
        Object.entries(state.conversion.entries || {}).forEach(([day, perMember])=>{
          if (!day.startsWith(prefix)) return;
          const e = perMember[mem.id];
          if (!e) return;
          CONV_METRICS.forEach(m=> totals[m] += (e[m]||0));
        });
        rowsHtml += `<tr><td style="padding:6px;border-bottom:1px solid #f0f0f0">${escapeHtml(mem.name)}</td>`;
        CONV_METRICS.forEach(m=> rowsHtml += `<td style="padding:6px;border-bottom:1px solid #f0f0f0;text-align:center">${totals[m]||0}</td>`);
        rowsHtml += `</tr>`;
      });
      rowsHtml += `</tbody></table>`;

      const title = `Conversion â€“ ${month}`;
      const printable = makePrintableContainer(title, rowsHtml);

      const opt = {
        margin:       [10,10,10,10],
        filename:     `conversion_${month}.pdf`,
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2, useCORS: true, logging:false },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'landscape' }
      };
      html2pdf().set(opt).from(printable).save();
    }

    // ===== Export Overview (members cards) to PDF =====
    function exportOverviewToPDF(monthValue){
      const month = monthValue || (overviewMonthInput.value || (state.conversion.currentDate||todayISO()).slice(0,7));
      let rowsHtml = `<div style="margin-bottom:8px;font-size:13px;"><strong>Overview month:</strong> ${month}</div>`;
      rowsHtml += `<table style="width:100%;border-collapse:collapse;font-size:12px;">`;
      rowsHtml += `<thead><tr><th style="padding:6px;border-bottom:1px solid #ddd;text-align:left">Member</th><th style="padding:6px;border-bottom:1px solid #ddd;text-align:center">Assessment</th><th style="padding:6px;border-bottom:1px solid #ddd;text-align:center">Conversion</th><th style="padding:6px;border-bottom:1px solid #ddd;text-align:center">Combined</th></tr></thead><tbody>`;
      state.members.forEach(mem=>{
        const { assessment, conversion, combined } = computeMemberCombined(mem, month);
        rowsHtml += `<tr><td style="padding:6px;border-bottom:1px solid #f0f0f0">${escapeHtml(mem.name)}</td>
          <td style="padding:6px;border-bottom:1px solid #f0f0f0;text-align:center">${assessment.toFixed(1)}%</td>
          <td style="padding:6px;border-bottom:1px solid #f0f0f0;text-align:center">${conversion.toFixed(1)}%</td>
          <td style="padding:6px;border-bottom:1px solid #f0f0f0;text-align:center">${combined.toFixed(1)}%</td>
        </tr>`;
      });
      rowsHtml += `</tbody></table>`;

      const printable = makePrintableContainer(`Members overview â€“ ${month}`, rowsHtml);
      const opt = {
        margin:       [10,10,10,10],
        filename:     `overview_${month}.pdf`,
        image:        { type: 'jpeg', quality: 0.95 },
        html2canvas:  { scale: 2, useCORS: true, logging:false },
        jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(printable).save();
    }

    // small helper to escape HTML in table cells
    function escapeHtml(s){
      if (!s) return "";
      return String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g," ");
    }

    // render initial
    renderAll();
  </script>
  
  <!-- ================= PDF POPUP ================= -->
<div id="pdfModal" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:9999">
  
  <div style="
    background:#111623;
    color:#fff;
    padding:16px;
    border-radius:12px;
    width:90%;
    max-width:420px">

    <h3 style="margin-bottom:12px">Export PDF</h3>

    <label style="font-size:12px">Section</label>
    <select id="pdfSection" style="width:100%;margin-bottom:10px">
      <option value="overview">Members overview</option>
      <option value="assessment">Assessment</option>
      <option value="conversion">Conversion</option>
    </select>

    <label style="font-size:12px">Orientation</label>
    <select id="pdfOrientation" style="width:100%;margin-bottom:14px">
      <option value="portrait">Portrait</option>
      <option value="landscape">Landscape</option>
    </select>

    <div style="display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="closePdfModal()">Cancel</button>
      <button class="btn btn-primary" onclick="generatePDF()">Preview</button>
    </div>
  </div>
</div>

<script>
function generatePDF(){
  const section = document.getElementById("pdfSection").value;
  const orientation = document.getElementById("pdfOrientation").value;

  let source;
  if(section === "overview"){
    source = document.getElementById("overviewTab");
  }else if(section === "assessment"){
    source = document.getElementById("assessmentTab");
  }else{
    source = document.getElementById("conversionTab");
  }

  if(!source){
    alert("Section not found");
    return;
  }

  // Ù†Ø¹Ù…Ù„ Ù†Ø³Ø®Ø© Ù…Ø¤Ù‚ØªØ©
  const clone = source.cloneNode(true);
  clone.style.display = "block";
  clone.style.background = "#fff";
  clone.style.color = "#000";
  clone.style.padding = "20px";

  const temp = document.createElement("div");
  temp.style.position = "fixed";
  temp.style.left = "-9999px";
  temp.appendChild(clone);
  document.body.appendChild(temp);

  html2pdf().set({
    margin: 10,
    html2canvas: { scale: 2 },
    jsPDF: { format: "a4", orientation }
  }).from(clone).save().then(()=>{
    document.body.removeChild(temp);
  });
}
</script>
</body>
</html>